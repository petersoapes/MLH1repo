---
title: "betweenCell.Var"
author: "April Peterson"
date: "5/5/2020"
output: html_document
---


load all the file set ups


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#library(tidyverse)
library(knitr)
library(ggplot2)
#library(pwr)

library(dplyr)
library(plyr)
library(lattice)

library(raster)
library(lme4)
library(nlme)
library(RLRsim)
#library(ggpubr)
library(reshape2)
library(patchwork)
library(png)
library(grid)
library(gridBase)
library(gridExtra)
library(dplyr)
library(cowplot)
library(kableExtra)
library(xlsx)

#set wd
#load datafile

options(digits=2)

#setwd("~.")#switch over to here()

load(file="~./MLH1repo/data/Results_setup_4.24.20.RData")

load(file="~./MLH1repo/data/Results_setup_4.21.20.RData")

load(file="~./MLH1repo/data/CleanBivData_6.3.20.RData")
load(file="~./MLH1repo/data/total_SC_30.12.19.RData")

#skeletonize
SC.skel = read.csv("~./MLH1repo/data/SCskel_output_feb20.csv", header = TRUE, strip.white = TRUE)


#load functions
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
```


plot the variances

```{r female.strain.table, echo=FALSE}
female_mouse.avs_for.analysis <- female_mouse.avs_for.analysis %>% filter(strain != "CAST")
#female strain table
#female_mouse.avs_for.analysis
F.strain.table <- ddply(female_mouse.avs_for.analysis, c("strain"), summarise,
                       
                        Nmice = length(unique(mouse)),
                        
                        total.cells  = sum(Ncells, na.rm = TRUE),
                        
                        mouse.mean_co = mean(mean_co, na.rm=TRUE),
                       
                        mean.mouse_cV = mean(cV, na.rm = TRUE),
                        
                        mean.mouse_var = mean(var, na.rm = TRUE ), 
                        
                        mean.mouse_sd   = mean(sd, na.rm = TRUE ),
                       
                        #Standard error (mice vs cells)
                        mean.mouse_se  = mean(se, na.rm=TRUE)
    )

```

```{r mouse.var.plots.female, echo=FALSE, fig.width = 4, fig.height=2.5, include=FALSE, eval=TRUE}

#variance plots
musc.female.VAR.plot <- ggplot( (female_mouse.avs_for.analysis %>% filter(sex== "female") %>% filter(subsp == "Musc") ) , aes(color= strain))+geom_jitter(aes(x = as.factor(strain), y =var, color= strain, alpha=0.5), width = .2 )+ ggtitle("Musc female of within mouse MLH1 distributions")+scale_color_manual(values=colors_of_strains)
musc.female.VAR.plot

Mol.female.VAR.plot <- ggplot( (female_mouse.avs_for.analysis %>% filter(subsp == "Mol") ), aes(color= strain))+geom_jitter(aes(x = as.factor(strain), y = var, color= strain, alpha=0.5), width = .2 )+ ggtitle("Mol female of within mouse MLH1 distributions")+scale_color_manual(values=colors_of_strains)
Mol.female.VAR.plot

Dom.female.VAR.plot <- ggplot(Dom.female_mouse.av, aes(color= strain))+geom_jitter(aes(x = as.factor(strain), y = var, color= strain), width = .2 )+ ggtitle("Dom female\nwithin mouse  MLH1 distributions") + scale_color_manual(values=colors_of_strains)
Dom.female.VAR.plot

```

```{r male.strain.table, echo=FALSE}

M.strain.table <- ddply(fomo.male_mouse.av, c("strain"), summarise,
                        Nmice =length(unique(mouse)),
                        
                        totNcells  = sum(Ncells, na.rm=TRUE),
                        
                        mean.mouse_mean_co = mean(mean_co, na.rm=TRUE),
                       
                        mean.mouse_cV = mean(cV, na.rm = TRUE),
                        
                        mean.mouse_var = mean(var, na.rm = TRUE ), 
                        
                        mean.mouse_sd   = mean(sd, na.rm=TRUE),
                       
                        #Standard error (mice . cells)
                        mean.mouse_se  = mean(se, na.rm=TRUE)
    )
#M.strain.table
#same issue as the female table .. ugh
```

```{r mouse.var.plots.male, echo=FALSE, fig.width = 4, fig.height=2.5, include=FALSE, include=FALSE, eval=FALSE}

#variance plots
musc.male.VAR.plot <- ggplot(Musc.male_mouse.av, aes(color= strain))+geom_jitter(aes(x = as.factor(strain), y =var, color= strain, alpha=0.5), width = .2 )+ ggtitle("VAR Musc male of within mouse MLH1 distributions")+scale_color_manual(values=colors_of_strains)
musc.male.VAR.plot

Mol.male.VAR.plot <- ggplot(Mol.male_mouse.av, aes(color= strain))+geom_jitter(aes(x = as.factor(strain), y = var, color= strain, alpha=0.5), width = .2 )+ ggtitle("VAR Mol male of within mouse MLH1 distributions")+scale_color_manual(values=colors_of_strains)
Mol.male.VAR.plot 

Dom.male.VAR.plot <- ggplot(Dom.male_mouse.av, aes(color= strain))+geom_jitter(aes(x = as.factor(strain), y = var, color= strain, alpha=0.5), width = .2 )+ ggtitle("VAR Dom male ofwithin mouse  MLH1 distributions")+scale_color_manual(values=colors_of_strains)
Dom.male.VAR.plot
```




go over the main patterns (from the model framework)


Bret's suggestions

On the question of variance in MLH1 count, I agree that it is crucial to reduce experimental noise to find a signal. 

I would suggest the following approach:
1.  Consider only high-quality cells.
2. Pool cells within a strain and within a sex and compute one estimate of the variance in MLH1 count for each sex in each strain.
3. Randomly permute cells among strains, keeping the structure of the dataset otherwise the same.
4. For each permutation, compute the among-strain variance in the MLH1 count variance (separately for each sex).
Compute the among-strain variance in the MLH1 count variance (separately for each sex) in your original data.
Compare your observed variance with the null distribution generated by permutations to compute a p-value (one for each sex).



```{r bret.filters, echo=FALSE}

```


# Identifying mice with largest sample sizes

I have a hunch that using these mice might be the best (least risky way forward)


