---
title: "Total_SC"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
    toc_float: yes
  pdf_document: default
  
---


```{r setup, echo=FALSE, warning=FALSE, include = FALSE}
library(ggplot2)
library(plyr)
library(dplyr)
#load main MLH1 files to merge MLH1 cell data with the sc data 
setwd("~./")

load(file="~./MLH1repo/data/MLH1/MLH1_data_setup_5.12.20.RData")
#load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/MLH1/MLH1_data_setup_12.20.19.RData")#most recent 

#these data generated by running "python script --, it should be re-run when new cells are added to the anon.csv file
SC.skel = read.csv("~./MLH1repo/data/SCskel_output_nov19.csv", header = TRUE, strip.white = TRUE)

#load BivData  
load(file="~./MLH1repo/data/CleanBivData_6.3.20.RData")
#load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/CleanBivData_13.2.20.RData")

#Curated list

#strain specific xlsx sheets (why?)


# Total.SC
# input: output from RW SC_skel run over Anon_Data images. The file names are random
# output: DFs of merged MLH1 and Skel data, cell and mouse levels
```


# Goals

Why include these results in the Main MLH1 results?

 - test if **greater SC area in females is a conserved trait of heterochiasmy**
 
 - test how average total SC correlates / contributes to mean CO
 
 
## Discribe these Data

output from RW SC_skel run over Anon_Data images. The file names are random  

The Main dataframe is the Merge MLH1 + skel data.

## Running the Python Script

Python -- apply to all images in the Anon folder (so all the random named image files)

(should I update all the crops? How many images need cropping)


### ToDo

- How will I test these / and adjust for XX?

- Look up the python output

- Check for outliers in the skel data

- rerun the Python script

- check that the mice from mixed models are in these

ToDo re-run the pipeline, to get measues for SKIVE and MOLF females
molf has almost eq SC -- but this is just 1 female


merge the sc.skel outputs with the master MLH1 measures
match up random names with original names

the skel output and scripts are in the SC_skel dir. it was run on all images in the anon_data folder. 
I haven't manually confirmed that the default parameters are skeletonizing the images correctly.

```{r clean.data, echo=FALSE, warning=FALSE}
#format all factors to numbers
SC.skel$bin_size  <- as.character(SC.skel$bin_size )
SC.skel$skel_size  <- as.character(SC.skel$skel_size)

SC.skel$bin_size  <- as.numeric(SC.skel$bin_size )
SC.skel$skel_size <- as.numeric(SC.skel$skel_size)

SC.skel$rand_name <- as.character(SC.skel$rand_name)

#check for duplicatations of the random name
original_DF$Random.Name <- as.character(original_DF$Random.Name)
duplies <- original_DF[duplicated(original_DF$Random.Name),]
#3 duplicate rows in original DF -- because Random name was blank -- how will these be matched to total.SC?
```


```{r merge.DF, echo=FALSE}

#MERGEING MLH! with SKEL
MLH1.merge.Skel <- merge(original_DF, SC.skel, by.x = "Random.Name", by.y = "rand_name", all= F)
OG.MLH1.merge.Skel <- MLH1.merge.Skel #raw version of DF

```


```{r grab.nice.mice.setup, echo=FALSE, warning=FALSE}
#https://rcompanion.org/handbook/G_03.html
#testing random effects within lme
#notes for testing random effects

#variance is still chr
AP_mouse_table_w.Ages$var <- as.numeric(AP_mouse_table_w.Ages$var)

#use the merged DF to filter by age 
AP_mouse_table_w.Ages$strain <- AP_mouse_table_w.Ages$strain.x
AP_mouse_table_w.Ages$sex <- AP_mouse_table_w.Ages$sex.x
AP_mouse_table_w.Ages$subsp <- AP_mouse_table_w.Ages$subsp.x
#main file, make everything unordered factors
AP_mouse_table_w.Ages <- add_species(AP_mouse_table_w.Ages)

DF.HetC.MixedModel <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$species == "M.musculus",]

DF.HetC.MixedModel <- subset(DF.HetC.MixedModel, select= -c(sex.x, sex.y,
                            subsp.y,subsp.x,
                    category.y, category.x,
                        strain.x,strain.y, mouse.1  )  )

#REMOVE EXTRA STRAINS
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$subsp != "Cast",]
#remove musc strains
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "AST",]
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "TOM",]
#remove PERC, MOLF, CZECH, (no females)
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "CZECH",]
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "PERC",]

DF.HetC.MixedModel <- droplevels(DF.HetC.MixedModel)#remove levels not used

#mean_co.HQ  (this might remove some of the MOLF males)
DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel[DF.HetC.MixedModel$Ncells > 9,]
#DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel.HQ[DF.HetC.MixedModel.HQ$age.weeks < 25,]
#above should only apply to males

DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel.HQ[!(is.na(DF.HetC.MixedModel.HQ$mouse)|DF.HetC.MixedModel.HQ$mouse==""),]

```



```{r check.lists, echo=FALSE}
#MLH1.merge.Skel
#OG.MLH1.merge.Skel

#checking / comparing the two lists

DF.HetC.MixedModel.HQ$mouse

skel.mice_from.MM.DF <- OG.MLH1.merge.Skel[ OG.MLH1.merge.Skel$mouse %in% DF.HetC.MixedModel.HQ$mouse, ]
#1630

#some WSB females missing from DF.HETC.HQ

#compare this list to cells in whole cell / curate (why?)
#FOR COMPARISON ACROSS APPROACHES

#OG.MLH1.merge.Skel doesn't have '.tif' -- remove .tif to make matching easier
skel.mice_from.MM.DF$fileName <- as.character(skel.mice_from.MM.DF$fileName)

for(j in 1:length(skel.mice_from.MM.DF$fileName)){
  print(j) 
  #MLH1_data$quant_status[i] <- ifelse( is.element(MLH1_data$mouse[i], pass_mice), "pass", NA)
   templist2 = strsplit(skel.mice_from.MM.DF$fileName[j], split='.tif')[[1]]
   #print(templist2)
   skel.mice_from.MM.DF$fileName2[j] = templist2
}
#this loop puts list in fileName2


library(tidyr)

skel.mice_from.MM.DF$og.fileName <- skel.mice_from.MM.DF$fileName
skel.mice_from.MM.DF <- skel.mice_from.MM.DF %>% separate(fileName, c("fileName3","blah"),'.tif')


#cell level data, MLH1 and skel
DF <- skel.mice_from.MM.DF[ skel.mice_from.MM.DF$fileName3 %in% Curated_BivData$fileName, ]#415
#above is the DF which there are cell which have been curated (and there is total.sc data)
#how to merge the biv level data..?

#number of bivs curated?

SC.pass_table <- ddply(.data=Curated_BivData, 
                 .(fileName),
                 summarize, 
                 n.SC.pacc.bivs = length(unique(Obj.ID))
                 
)
#the PWD and KAZ duplicate mice will have more than 20 -- remove them

SC.pass_table <- add_mouse(SC.pass_table)
#SC.pass_table <- add_strain(SC.pass_table)
#SC.pass_table <- add_sex(SC.pass_table)
#SC.pass_table <- add_category(SC.pass_table)

DF$fileName <- DF$fileName3

#with mouse, merge to DF
DF.2 <- merge(DF, SC.pass_table, by = "fileName", all.y = FALSE, no.dups = TRUE )
#not merging because of silly / weird list thing

DF.2 <- DF.2[ -c(14,15,20,23,21) ]
DF.2$mouse <- DF.2$mouse.x

DF.2 <- add_strain(DF.2)
DF.2 <- add_sex(DF.2)
DF.2 <- add_category(DF.2)

table(DF.2$category)


this.plot <- ggplot(DF.2, aes(n.SC.pacc.bivs)) + geom_histogram(bins = 40)+ facet_wrap(~category)+ggtitle("Number of curated bivs per image")

this.plot_WSB.female <- ggplot(DF.2[DF.2$category == "WSB female",], aes(n.SC.pacc.bivs)) + geom_histogram(bins = 40)+ facet_wrap(~mouse)+ggtitle("Number of curated bivs per image")


```




```{r more.blahs, echo=FALSE}
#WSB -- WSB_curation, WSB_female output on big External
#not sure why Curated bivData catching more categories than this above

#this table now has merged bin/skel, and have been curated (but it doesn't have data on the curated bivalents)
#the curated list is the current bottle neck

#I should start inventory  how many mice are in each curated category


Skel.summary.table <- ddply(.data=skel.mice_from.MM.list, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci, na.rm = TRUE),
                 var.MLH1 = var(adj_nMLH1.foci, na.rm = TRUE),
                 
                 mean.skel = mean(skel_size, na.rm = TRUE),
                 mean.bin =  mean(bin_size, na.rm = TRUE)
                 
)

#add strain, category, etc

  
```



```{r cleaning.up, echo=FALSE}
#clean up this DataFrame REMOVE 'X'
MLH1.merge.Skel <- MLH1.merge.Skel[ !grepl("X", MLH1.merge.Skel$Batch) , ]
MLH1.merge.Skel <- MLH1.merge.Skel[ !grepl("x", MLH1.merge.Skel$X) , ]
MLH1.merge.Skel <- MLH1.merge.Skel[!(is.na(MLH1.merge.Skel$quality) | MLH1.merge.Skel$quality==""), ]

MLH1.merge.Skel <- add_mouse(MLH1.merge.Skel)
MLH1.merge.Skel <- add_strain(MLH1.merge.Skel)
MLH1.merge.Skel <- add_sex(MLH1.merge.Skel)

MLH1.merge.Skel <- add_category(MLH1.merge.Skel)
MLH1.merge.Skel <- add_subsp(MLH1.merge.Skel)

#where does this DF come from?
#mlh1.skel.og <- add_euth_date(mlh1.skel.og)
#mlh1.skel.og <- add_age(mlh1.skel.og)
#str(mlh1.skel.og)

MLH1.merge.Skel$nMLH1.foci <- as.character(MLH1.merge.Skel$nMLH1.foci)
MLH1.merge.Skel$nMLH1.foci <- as.numeric(MLH1.merge.Skel$nMLH1.foci)

#it seems like this has duplicates
MLH1.merge.Skel.DUPs <- MLH1.merge.Skel[duplicated(MLH1.merge.Skel$Random.Name),]
#with new dataframe, there are 0 duplicates..
#make sure to seperate mice based on adult and juvinille

#remove for now
#MLH1.merge.Skel <- MLH1.merge.Skel %>% distinct()

#keep list of outliers (need to adjust threshold with lastest batch)
Total.SC.above.threshold <- MLH1.merge.Skel[MLH1.merge.Skel$skel_size > 25000,]
#remove outliers 
MLH1.merge.Skel <- MLH1.merge.Skel[MLH1.merge.Skel$skel_size < 25000,]

```


# write table


```{r write.table, echo=FALSE, eval=FALSE}

#add categories and levels

#above threshold is bad,
#write out these cell's info so I can double check them.
#write.table(Total.SC.above.threshold, "~./MLH1repo/data/BivData/total_SC_above_threshold.csv", sep=",", row.names = FALSE)

#write.xlsx2(strain.table.HQ_Fig, "Main_MLH1_table2.xlsx", sheetName = "Sheet1", 
#            col.names = TRUE, row.names = FALSE, append = FALSE)

#write.table(MLH1.merge.Skel, "~./MLH1repo/data/BivData/total_SC_below_threshold.csv", sep=",", row.names = FALSE)


#Below threshold is are the values to use

#write.xlsx2(MLH1.merge.Skel, "Total.SC_merge.MLH1.xlsx", sheetName = "Sheet1", 
#            col.names = TRUE, row.names = FALSE, append = FALSE)
```


# More Analysis

I noticed that these cells have the same bin sizes and skel sizes
this is written within RW's code

now there are quite a few cells above the threshold
table(Total.SC.above.threshold$category)
more female cells than male


to clean up the total SC data -- use the images with no in redo crop (400 vs 2500)
could also compare to quality =1 cells

```{r ploting, echo=FALSE}
Total.SC.box <- ggplot(data = MLH1.merge.Skel, aes(y=skel_size, x=strain, color=sex) ) + geom_boxplot()+ggtitle("Total SC Measures")

Total.SC.points <- ggplot(data = MLH1.merge.Skel, aes(y=skel_size, x=strain, color=sex) ) + 
  geom_jitter()+ggtitle("Total SC Measures")
```


 test if my score of crop, causes more noise / is a cleaner cell segment
for internal checking, not need to keep

 make tables of the means ect to measure how much change there is between these subseted data sets


```{r crop.stuff, echo=FALSE}

clean.crop <- MLH1.merge.Skel[MLH1.merge.Skel$REDO.crop == 'no',]
table(clean.crop$category)
table(MLH1.merge.Skel$category)

#WTF are these?
clean.crop.table <- ddply(.data=clean.crop, 
                             .(category),
                             summarize, 
                          #mean skel, mean binary, var for the two
                          n.obs = length(unique(Original.Name)),
                          mean.skel = mean(skel_size), 
                          mean.bin = mean(bin_size),
                          var.skel = var(skel_size),
                          var.bin = var(bin_size)
                          #ncells = length(unique(fileName)),
                             #nbivs = length(unique(Obj.ID))
)

not.clean.crop.table <- ddply(.data=MLH1.merge.Skel[!MLH1.merge.Skel$REDO.crop == 'no',], 
                          .(category),
                          summarize, 
                          #mean skel, mean binary, var for the two
                          n.obs = length(unique(Original.Name)),
                          mean.skel = mean(skel_size), 
                          mean.bin = mean(bin_size),
                          var.skel = var(skel_size),
                          var.bin = var(bin_size)
                          #ncells = length(unique(fileName)),
                          #nbivs = length(unique(Obj.ID))
                          
)

weee <- merge(clean.crop.table, not.clean.crop.table, by.x = 'category', by.y = 'category', all = FALSE)


```


table of clean crop stat
table of total (minus clean crop, stat)
 difference in means is the amount of error 


for some categories the difference is ~20% between the means
usuall difference means the croped version has less compared to other

```{r more.plot, echo=FALSE}

weee$dif.skel.mean <-  ( (weee$mean.skel.x - weee$mean.skel.y) / weee$mean.skel.x ) *100
#what is this below

Total.SC.points2 <- ggplot(data = clean.crop, aes(y=skel_size, x=strain, color=sex) ) + 
  geom_jitter()+ggtitle("Total SC Measures, clean crops")

#str(MLH1.merge.Skel)
```


```{r table.making, echo=FALSE}
#mouse level
mouse.level.skel <- ddply(.data=MLH1.merge.Skel,
                          .(mouse),
                          summarize, 
                          ncells = length(unique(Original.Name)),
                          nmice = length(unique(mouse)),
                          mean.MLH1 = mean(nMLH1.foci, na.rm = TRUE),
                          mean.skel = mean(skel_size),
                          mean.bin = mean(bin_size)
)

mouse.level.skel <- add_strain(mouse.level.skel)
mouse.level.skel <- add_sex(mouse.level.skel)
mouse.level.skel <- add_category(mouse.level.skel)
mouse.level.skel <- add_subsp(mouse.level.skel)
```


```{r mouse.level.plot, echo=FALSE, warning=FALSE}

looky.mouse <- ggplot(data = mouse.level.skel[mouse.level.skel$subsp == "Musc",], aes(y=mean.skel, x=mean.MLH1, color=strain) ) + geom_jitter() +facet_wrap(subsp~sex) + ggtitle("")
looky.mouse

looky.mouseDom <- ggplot(data = mouse.level.skel[mouse.level.skel$subsp == "Dom",], aes(y=mean.skel, x=mean.MLH1, color=strain) ) + geom_jitter() + ylim(c(150,1200))+facet_wrap(subsp~sex) + ggtitle("")

#theme(legend.position="none") 
```


double check a way to visually inspect the python skel output

repeat random numbers?

some of richard's analysis show negative relationship with SC length and MLH1 (his QTL word doc). Could this be sign
 of pwd like regulation?

remove MLH1 tables since they overwrite other ones

remove plots, tables for internal checking
what to keep: SC.skel, OG.MLH1.merge.Skel, MLH1.merge.Skel, MLH1.merge.Skel.DUPs, mouse.level.skel



```{r saving.data, echo=FALSE}
rm(list=setdiff(ls(), c("SC.skel", "OG.MLH1.merge.Skel", "MLH1.merge.Skel", "MLH1.merge.Skel.DUPs","mouse.level.skel")))

#output: matched random names with real names.
#save RData file
#save.image("~./MLH1repo/data/total_SC_14.2.20.RData")

#changing to just loading the csv file

```

