---
title: "ANOVA_MixedModel"
author: "April Peterson"
date: "April 6, 2018"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
library(nlme)
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(raster)#for cV
library(knitr)

#load data
setwd("C:/Users/alpeterson7/Documents/MLH1repo")
load(file="MLH1_data_setup.RData")
```


ReDo these mixed model analyses with REML

Goals; complete 2 Mixed Model for
- house mouse
- Mus (with outgroups)


This current data set has `r length(MLH1_data$Random.Name)`. and `r length(unique( MLH1_data$mouse) )`  mice. (do these data include non-HM?)

I processed some of the data for these analyses,
  - changed all SPIC and SPRET labels to outgroup. (The fact that these are under 'subsp' is kinda misleading)
  - compare full cell data set to dataset of quality 123


#### Partition Variance, ANOVA, (using REML)


I wrote an power point (Jan18 lab meeting slide) explaining the MM. with REML

There are several constiderations / QC things to keep in mind for the data set

- use mouse average data
- only use house mouse data
- set Dom male as the intercept
- the sexes are matched (remove strains which don't have both sexes represented)
- consider adding the stain most of the mouse data came from

```{r}
#remove everything not H.M
HM.Table <- AP_mouse_table[AP_mouse_table$subsp != "outgroup",]
HM.Table <- HM.Table[HM.Table$subsp != "other",]

#make sure that sexes are matched! (remove strains that don't have matched data)
#table(HM.Table$strain,HM.Table$sex)
#REMOVE, HMI
#feb 2019, still need more imaging and data before this should be run again.


#make sure the the orders are right, intercept = Dom-male
#cast is number 1 first

dd <- lme(mean_co ~ sex * subsp, data=HM.Table, random=list(strain=pdDiag(~sex) ) )


```




make several models then compare the subsp and subsp:strain variance 



I filtered the data, for mouse averages calculated from cells of quality 3 or lower and each mouse has 5 or more cells. (there are 52 mice). The originale mouse table has 105 mice.

when making these models  I learned...
- if I use the mouse averages for aov ... all of the DF will be used up.  These aov estimates should be done on the full cell count data frames

- nested models for cell level data (strain:subsp, sex:strain, )

- Discribe data (full and reduced based on quality...)


```{r make aov, include=FALSE}
#edit the cell level data (not sure how to remove mice with low number of cells)

#re-assigned spret and spic subsp to outgroup ()
MLH1_data$subsp <-  ifelse(grepl("Spic", MLH1_data$subsp), "outgroup", 
                    ifelse(grepl("Spretus", MLH1_data$subsp), "outgroup",
                                            MLH1_data$subsp))

MLH1_data.Mus <- MLH1_data[ !(grepl("Spretus", MLH1_data$subsp)), ]
MLH1_data.Mus <- MLH1_data[ !(grepl("Spic", MLH1_data$subsp)), ]

MLH1_data.123 <- MLH1_data[MLH1_data$quality <4, ]
MLH1_data.123 <- na.omit(MLH1_data.123)

#I should change the speret ext to outgroup

#the aovs
full.orig <- aov(nMLH1.foci  ~ subsp+strain:subsp+sex:strain+mouse:sex + quality, data = MLH1_data)
full.123 <- aov(nMLH1.foci  ~ subsp+strain:subsp+sex:strain+mouse:sex + quality, data = MLH1_data.123)

#not sure how to plot these models ... for testing assumptions

simp.model <- aov(nMLH1.foci  ~ subsp+strain:subsp+sex:strain+mouse:sex, data = MLH1_data)


full.orig.vals <- summary(full.orig)
full.123.vals <- summary(full.123)

#quality vs no quality...
#figure out how to display these...
#compare effects across full models
# the compare full to sex specific data (how much larger is the sum or squares )

male_full.orig <- aov(nMLH1.foci  ~ subsp+strain:subsp+ mouse:strain + quality, data = MLH1_data[MLH1_data$sex == "male", ] )
female_full.orig <- aov(nMLH1.foci  ~ subsp+strain:subsp+ mouse:strain + quality, data = MLH1_data[MLH1_data$sex == "female", ])

male_full.123 <- aov(nMLH1.foci  ~ subsp+strain:subsp+ mouse:strain + quality, data = MLH1_data.123[MLH1_data.123$sex == "male", ] )
female_full.123 <- aov(nMLH1.foci  ~ subsp+strain:subsp+ mouse:strain + quality, data = MLH1_data.123[MLH1_data.123$sex == "female", ])

```


```{r, echo=FALSE}
kable(summary(full.orig)[[1]],digits = 2, caption = "Full ANOVA table")
kable(summary(full.123)[[1]],digits = 2, format = "pandoc", caption = "reduced data (quality123) ANOVA table")
```


**Full vs reduced**: full model, all parameters/coeffecients are significant. sex has the largest amount of variance for both full and 123 data sets. The quality coeffecient is less significant in the 123 dataset. sex also becomes less efficient in the 123 dataset.

```{r, echo=FALSE}
kable(summary(female_full.orig)[[1]],digits = 2, format = "pandoc", caption = "Female Full ANOVA table")
kable(summary(female_full.123)[[1]],digits = 2, format = "pandoc", caption = "Female123 ANOVA table")
```

**Female specific**: subsp is not significant in the full dataset. mouse is less significant. quality is the most significant in full and in the 123 dataset, mouse is the most significant.
the difference between full and 123 dataset, quality becomes less significant in the 123 dataset. 
Caveat: subsp in females only has 3 DF (MUSC, Dom, Outgroup), because I don't have any cast data.


```{r, echo=FALSE}
kable(summary(male_full.orig)[[1]],digits = 2, format = "pandoc", caption = "Male Full ANOVA table")
kable(summary(male_full.123)[[1]],digits = 2, format = "pandoc", caption = "Male123 ANOVA table")
```

**male specific**: in the full dataset, subsp, quality, strain are max significant. Mouse is significant but less so. Subsp is explains most of the variance. in the 123 dataset, subsp is also most sig, quality exaplains a lot less. All coeffecients are significant still.

### Mixed Models

One of the point of comparing the mix model values is to assess if there are subsp and strain specific sexual dimorphism.
This is better than the ANOVA... because I can compare sexual dimorphism. Whereas the ANOVA framework I am looking at the between and within amount of variation.

The mixed models also serve as a saniety check-- for comparing the effects and directions on MLH1 number.

Better because it allows for fixed and random effects (instead of making wrong assumuptions about the effect distributions).

#### Setting up Model

Only use Musc and Dom? 

Mouse averages are used, since MLH1 distributions are closer to normal distribution.

Coding for the mixed model; Dom male is the base.  (in most of my dataframes female is ordered before males, for visualization purposes). Effect values for sex and subsp will be for Female and Musc.

Subsp and sex (and interaction) are fixed effects. Strain and strain specific sex effect and residual are random effects.

Compare full dataset to 123quality dataset.

Compare full dataset to mice with 5 cells


```{r mouse quality, include=FALSE}
#make mouse average table with 
AP_mouse_table$mouse <- as.factor(AP_mouse_table$mouse)

AP_mouse_table1.2.3 <- ddply(MLH1_data[MLH1_data$quality > 3, ], c("subsp","strain","sex","mouse"), summarise,
                         Nmice = length(unique(mouse)),
                         Ncells  = length(adj_nMLH1.foci),
                         mean_co = as.numeric(format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3) ),
                         cV = cv(adj_nMLH1.foci),
                        var = format(round(   var(adj_nMLH1.foci),3), nsmall=3),
                         sd   = round(sd(adj_nMLH1.foci), 3),
                         se   = round(sd / sqrt(Ncells), 3)
)
AP_mouse_table1.2.3 <- na.omit(AP_mouse_table1.2.3)
AP_mouse_table1.2.3_5orMore <- AP_mouse_table1.2.3[AP_mouse_table1.2.3$Ncells > 5, ]

AP_mouse_table1.2.3_5orMore$subsp <-  ifelse(grepl("Spic", AP_mouse_table1.2.3_5orMore$subsp), "outgroup", 
                                      ifelse(grepl("Spretus", AP_mouse_table1.2.3_5orMore$subsp), "outgroup",
                                                    AP_mouse_table1.2.3_5orMore$subsp))
```



```{r full.model, echo=FALSE}

# just look at data of Musc and Dom 
#mixmodmouse_data <- AP_mouse_table[(AP_mouse_table$subsp == "Musc" | AP_mouse_table$subsp == "Dom"),  ]

#remove cast .. models can't be built with missing data

AP_mouse_table <- AP_mouse_table[(AP_mouse_table$subsp == "Musc" | AP_mouse_table$subsp == "Dom"),  ]
AP_mouse_table$sex <- factor(AP_mouse_table$sex, levels = c("male", "female"))


AP_mouse_table1.2.3 <- AP_mouse_table1.2.3[(AP_mouse_table1.2.3$subsp == "Musc" | AP_mouse_table1.2.3$subsp == "Dom"),  ]
AP_mouse_table1.2.3 <- na.omit(AP_mouse_table1.2.3)
AP_mouse_table1.2.3$sex <- factor(AP_mouse_table1.2.3$sex, levels = c("male", "female"))
AP_mouse_table1.2.3$subsp <-  factor(AP_mouse_table1.2.3$subsp, levels = c("Dom", "Musc"))

AP_mouse_table1.2.3_5orMore <- AP_mouse_table1.2.3[AP_mouse_table1.2.3$Ncells > 5, ]

MMfull <- lme(mean_co ~ sex * subsp, data=AP_mouse_table, random=list(strain=pdDiag(~sex)) ) 
MM123 <- lme(mean_co ~ sex * subsp, data=AP_mouse_table1.2.3, random=list(strain=pdDiag(~sex)) ) 
MM123.5 <- lme(mean_co ~ sex * subsp, data=AP_mouse_table1.2.3_5orMore, random=list(strain=pdDiag(~sex)) ) 

aa <- summary(MMfull)
bb <- summary(MM123)
cc <- summary(MM123.5)
```


To interpert the summary results, (Fixed effects)
- the intercept is the mean MLH1 number of the base factors -- which in this model is defined as Dom male (26.40).

- the next variable is sex being female, has an affect of increasing the mean MLH1 count by 1.7. (This is about the amount of sexual dimorphism)
1.7 (SD)

- the value for Musc is 3.935, meaning being male and Musc adds 3.935 to the mean MLH1 (in the previous model without KAZ, this was 5.5)

- the interaction of sex and subspecies is -3.7 meaning, musc females are 3 MLH1 foci lower than musc males (in previous models this was -5.1)


Random effects (strain and strain specific sexual dimorphism)
- the intercept is the average sd from strains 1.89, 
- the sex effec is the average sd from strain specific sexual dimorphism 2.07
- the random effects can be estimated; the intercepts are the average sd for the strain effect, ... from these esitmates is seems that G and Kaz have strain specific sexual dimorphism where females are larger if the strain specific SD effect is larger than the whole sex effect

```{r, include=FALSE}
#make new AP mouse table with cells from 1-3
quality_data <- MLH1_data[MLH1_data$quality <= 3, ]
quality_data <- quality_data[(quality_data$subsp == "Musc" | quality_data$subsp == "Dom"),  ]

na.omit(quality_data)

qualAP_mouse_table <- ddply(quality_data, c("subsp", "sex", "strain", "mouse"), summarise,
                         Nmice = length(unique(mouse)),
                         Ncells  = length(adj_nMLH1.foci),
                         mean_co = as.numeric(format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3) ),
                         cV = cv(adj_nMLH1.foci),
                        var = format(round(   var(adj_nMLH1.foci),3), nsmall=3),
                         sd   = round(sd(adj_nMLH1.foci), 3),
                         se   = round(sd / sqrt(Ncells), 3)
                        #sex = sex,
                        #subsp = subsp,
                        #strain = strain
                      #quality?
                        
                        
)
qualAP_mouse_table <- na.omit(qualAP_mouse_table)

qualAP_mouse_table <- qualAP_mouse_table[qualAP_mouse_table$Ncells > 5,]


qualAP_mouse_table$sex <- factor(qualAP_mouse_table$sex, levels = c("male", "female"))
qualAP_mouse_table$strain <- factor(qualAP_mouse_table$strain)
qualAP_mouse_table$subsp <-  factor(qualAP_mouse_table$subsp, levels=c("Dom", "Musc"))

model2 <- lme(mean_co ~ sex * subsp, data=qualAP_mouse_table, random=list(strain=pdDiag(~sex)) ) 

#summary(model2)
#ranef(model2)
```

For this version of cleaned data, the effect of Musc on the mean MLH1 is lower.
