---
title: "Effects"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
    toc_float: yes
    
---

```{r setup, include=FALSE}
#setwd("C:/Users/alpeterson7/Documents/MLH1repo/") #this wd is different than where the file is ... this kinda causes errors
#setwd("C:/Users/April/Desktop/MLH1repo")
#load(file="data/MLH1/MLH1_data_setup.RData")

library(knitr)
library(ggplot2)
library(plyr)
library(lattice)
library(dplyr)
library(raster)
library(lme4)
library(nlme)
library(RLRsim)
library(ggpubr)
library(reshape2)
library(lubridate)#for dates / months

#load main data file

load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/MLH1/MLH1_data_setup_1.5.20.RData")#added batch18

#clean up total SC
load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/total_SC_1.6.20.RData")#total SC data

#load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/MLH1/MLH1_data_setup_12.20.19.RData")#fixing bugs, formating
#load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/total_SC_30.12.19.RData")#total SC data

#load(file="data/MLH1/MLH1_data_setup_11.12.19.RData")
#save.image("~./MLH1repo/data/MLH1/MLH1_data_setup_12.3.19.RData")
```





```{r setupdata, echo=FALSE}
AP_mouse_table_w.Ages <- add_category(AP_mouse_table_w.Ages)
#remove NAs
AP_mouse_table_w.Ages <- AP_mouse_table_w.Ages[!(is.na(AP_mouse_table_w.Ages$Nmice) | AP_mouse_table_w.Ages$Nmice==""), ]

```



# Cell Quality Effects

> Main points

1. There is a positive relationship with quality and MLH1 count (better cells have more MLH1)  

2. The effect of Quality on mean MLH1 count is larger in males

> Open quesitons

 - Are quality score less accurate/consistant for females? 

 - Should I weight mouse COs averages by the quality ratio? 

 - Exclude lowest quality cells in males, but keep them in female dataset?

 - Does the effect for males still hold when Q5 cells are removed? 

The the plots below, each point is a single mouse's mean MLH1 count per cell across each quality score bin. 

```{r MLH1.histogram.2, echo=FALSE, eval=FALSE,include=FALSE}
#thse plots not shown
#remake the pooled MLH1 histgoram plot from above but facet by quality

#PWD male, MSM male
#LEW female, WSB female
mean.MLH1.obs_qual <- ddply(.data=MLH1_data, 
                 .(category, quality),
                 summarize, 
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
#what's the point of the above table? -- add vlines?

#I think I should do some t-tests across the groups of quality bins to better asess the amount of quality effect

histM_qual.KAZ_male <- ggplot(data=MLH1_data[MLH1_data$category == "KAZ male",],(aes(x=adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ quality, ncol = 5)+ggtitle("KAZ male Pooled Cell Histograms by quality")+ geom_vline(xintercept=mean.MLH1.obs_qual$mean.MLH1[mean.MLH1.obs_qual$category == "KAZ male"],color="red")
histM_qual.KAZ_male


histM_qual.PWD_male <- ggplot(data=MLH1_data[MLH1_data$category == "PWD male",],(aes(x=adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ quality, ncol = 5)+ggtitle("PWD male Pooled Cell Histograms by quality")+ geom_vline(xintercept=mean.MLH1.obs_qual$mean.MLH1[mean.MLH1.obs_qual$category == "PWD male"],color="red")
histM_qual.PWD_male

histM_qual.MSM_male <- ggplot(data=MLH1_data[MLH1_data$category == "MSM male",],(aes(x=adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ quality, ncol = 5)+ggtitle("MSM male Pooled Cell Histograms by quality")+geom_vline(xintercept=mean.MLH1.obs_qual$mean.MLH1[mean.MLH1.obs_qual$category == "MSM male"], color="red")
histM_qual.MSM_male

histM_qual.WSB_female <- ggplot(data=MLH1_data[MLH1_data$category == "WSB female",],(aes(x=adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ quality, ncol = 5)+ggtitle("WSB female Pooled Cell Histograms by quality")+ geom_vline(xintercept=mean.MLH1.obs_qual$mean.MLH1[mean.MLH1.obs_qual$category == "WSB female"],color="red")
histM_qual.WSB_female

histM_qual.LEW_female <- ggplot(data=MLH1_data[MLH1_data$category == "LEW female",],(aes(x=adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ quality, ncol = 5)+ggtitle("LEW female Pooled Cell Histograms by quality")+ geom_vline(xintercept=mean.MLH1.obs_qual$mean.MLH1[mean.MLH1.obs_qual$category == "LEW female"],color="red")
histM_qual.LEW_female


#plot.pvals.L <- ggplot(bunchOpvals.L, aes(bunchOpvals.L) )+geom_histogram(bins = 50)+ ggtitle("1000 rep t-tests sample size 25, High vs Low Leptotene")+geom_vline(xintercept=ttest.HighLow.L$p.value, linetype="dotted", color="red")


#when I try to add the mean lines, error returned that it can't find the adj_MLH1 ....?
#histM <- histM +  geom_line(data=mean.MLH1.obs, aes(y=mean.MLH1.obs$mean.MLH1))
  
#ad
#  geom_smooth(method = lm, se = FALSE
 # geom_smooth(method = lm, formula = mean.MLH1.obs$mean.MLH1 ~ mean.MLH1.obs$category, se = FALSE)
```


```{r qual.tables, echo=FALSE}

#make a similart plot as the ages
#for each mouse and quality, calq the mean MLH1
mouse.table.mean.MLH1.obs_qual <- ddply(.data=MLH1_data, 
                 .(mouse, quality),
                 summarize, 
                 ncells =  length(unique(Original.Name)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)


mouse.table.mean.MLH1.obs_qual <- add_category(mouse.table.mean.MLH1.obs_qual)
mouse.table.mean.MLH1.obs_qual <- add_strain(mouse.table.mean.MLH1.obs_qual)
mouse.table.mean.MLH1.obs_qual <- add_sex(mouse.table.mean.MLH1.obs_qual)
mouse.table.mean.MLH1.obs_qual <- add_subsp(mouse.table.mean.MLH1.obs_qual)

```


```{r qual.plot, echo=FALSE}

mm <- mouse.table.mean.MLH1.obs_qual[mouse.table.mean.MLH1.obs_qual$sex == "male",]
age.effect.plot.mm <- ggplot(mm, aes(y=mean.MLH1, x=quality, color=(strain) ))+geom_jitter(width = 0.16)+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Male quality and mean CO")+facet_wrap(~subsp)+
  theme(legend.position="none")

age.effect.plot.mm


ff <- mouse.table.mean.MLH1.obs_qual[(mouse.table.mean.MLH1.obs_qual$sex == "female"),]
ff <- ff[ff$strain != "CAST",]

age.effect.plot.ff <- ggplot(ff, aes(y=mean.MLH1, x=quality, color=(strain) ))+geom_jitter(width = 0.16)+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+
  #are the lines
  ggtitle("Female quality and mean CO")+facet_wrap(~subsp)+theme(legend.position="none")

age.effect.plot.ff

```


These plots show that generally there is a positive relationship between good quality and more MLH1 counts.


```{r qual.effect.sex, echo=FALSE}
#compare the quality effect by sex
#an issue with comparing sexes is they have different ranges of MLH1 means
#do other analysis 

#plots show lm for observations from mouse.table.mean.MLH1.obs_qual
#glm

blah.lm.ff <- lm( mean.MLH1 ~ quality + ncells + subsp + strain, data=ff)
#quality bin is significant to predict count in ff (remeber these are binned averages)
# -0.85303,  3.61e-14 ***


blah.lm.mm <- lm( mean.MLH1 ~ quality + ncells + subsp + strain, data=mm)
#quality co Eff,   -8.863e-01, < 2e-16 ***


mm.low <- mm[!( (mm$strain == "MSM") | (mm$strain == "PWD") ), ]

blah.lm.mm.low <- lm( mean.MLH1 ~ quality + ncells + subsp + strain, data=mm.low)
#quality sig, so strain (unlike female (probably bc greater range))

# -8.881e-01,  < 2e-16 ***


#the coefficient is 10x higher in males, p value max-out low 
#females the quality co-E is much smaller and p.value larger  
#quality effect on mean co's is larger in males

```

I ran lm of the data from the plots above and found that the coefficient is 10x higher in males, p value max-out low and in females the quality co-efficicent is much smaller and p.value larger.



## Cell Quality effect on SC

In progress. Examine image quality or other scores to test how well the python scripts segment the SC area for all the images. 


```{r SC.qual, echo=FALSE, eval=FALSE}
#use the SC table

#all of skel and bin are not num
MLH1.merge.Skel$skel_size <- as.character(MLH1.merge.Skel$skel_size)
MLH1.merge.Skel$skel_size <- as.numeric(MLH1.merge.Skel$skel_size)

MLH1.merge.Skel$bin_size <- as.character(MLH1.merge.Skel$bin_size)
MLH1.merge.Skel$bin_size <- as.numeric(MLH1.merge.Skel$bin_size)

#mouse.level.skel

#MLH1.merge.Skel, hist of all skel values


#test with removing crop == 'no', MLH1.merge.Skel[MLH1.merge.Skel$REDO.crop == "no",]
mouse.table.mean.skel.obs_qual <- ddply(.data=MLH1.merge.Skel, 
                 .(mouse, quality),
                 summarize, 
                 ncells =  length(unique(Original.Name)),
                 mean.skel = mean(skel_size, na.rm = TRUE),
                 mean.bin = mean(bin_size)
                # var.skel = var(skel_size, na.rm = TRUE) #var not useful, many NA/1 obs
)


mouse.table.mean.skel.obs_qual <- add_category(mouse.table.mean.skel.obs_qual)
mouse.table.mean.skel.obs_qual <- add_strain(mouse.table.mean.skel.obs_qual)
mouse.table.mean.skel.obs_qual <- add_sex(mouse.table.mean.skel.obs_qual)
mouse.table.mean.skel.obs_qual <- add_subsp(mouse.table.mean.skel.obs_qual)

```


```{r SC.hitograms, echo=FALSE, eval=FALSE, fig.width = 4, fig.height=1}
#try adjusting the size for thi..

skel.histgram <- ggplot(MLH1.merge.Skel, aes(x=skel_size)) +  geom_histogram(bins=50)+ggtitle("width 4, height 1")
skel.histgram
```

```{r more.SC.hist, echo=FALSE, eval=FALSE}

#length(MLH1.merge.Skel$Random.Name[MLH1.merge.Skel$skel_size > 30000])#67 large SC cells

MLH1.merge.Skel <- add_category(MLH1.merge.Skel)
MLH1.merge.Skel <- add_strain(MLH1.merge.Skel)
MLH1.merge.Skel <- add_sex(MLH1.merge.Skel)
MLH1.merge.Skel <- add_subsp(MLH1.merge.Skel)

MLH1.merge.Skel <- MLH1.merge.Skel[MLH1.merge.Skel$skel_size < 30000,]

skel.histgrams.2.DOM <- ggplot(MLH1.merge.Skel[MLH1.merge.Skel$subsp == "Dom",], aes(x=skel_size)) +  geom_histogram(bins=50)+facet_grid(sex~strain)
skel.histgrams.2.DOM


skel.histgrams.2.MUSC <- ggplot(MLH1.merge.Skel[MLH1.merge.Skel$subsp == "Musc",], aes(x=skel_size)) +  geom_histogram(bins=50)+facet_grid(sex~strain)
skel.histgrams.2.MUSC

```


```{r sc.qual.plots, echo=FALSE, eval=FALSE}
skel.mm <- mouse.table.mean.skel.obs_qual[mouse.table.mean.skel.obs_qual$sex == "male",]
skel.mm <- skel.mm[skel.mm$mean.skel < 50000,]

skel.qual.effect.plot.mm <- ggplot(skel.mm, aes(y=mean.bin, x=quality, color=(strain) ))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Male quality and mean CO")+facet_wrap(~subsp)
skel.qual.effect.plot.mm
```

Each point is a single mouse

```{r G.plot, echo=FALSE, eval=FALSE}
Bin.qual.effect.plot.mm.G <- ggplot(skel.mm[skel.mm$strain == "G",],
                           aes(y=mean.bin, x=quality, size= ncells, color=strain))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Quality and mean SC (bin) ")+facet_wrap(~mouse)

Bin.qual.effect.plot.mm.G


skel.qual.effect.plot.mm.G <- ggplot(skel.mm[skel.mm$strain == "G",],
                           aes(y=mean.skel, x=quality, size= ncells, color=strain))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Quality and mean SC (bin) ")+facet_wrap(~mouse)

```

The mouse 22jun15_G_m2 has strange pattern, investigate the Python SC outputs.  

Some of the pattern goes away when redo.crop is set to equal 'no'.

```{r female.skel.plot, echo=FALSE, eval=FALSE}

skel.ff <- mouse.table.mean.skel.obs_qual[mouse.table.mean.skel.obs_qual$sex == "female",]

skel.qual.effect.plot.ff <- ggplot(skel.ff, aes(y=mean.bin, x=quality, color=(strain) ))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female quality and mean CO")+facet_wrap(~subsp)

skel.qual.effect.plot.ff


skel.qual.effect.plot.ff.MSM <- ggplot(skel.ff[skel.ff$strain == "MSM",], aes(y=mean.bin, x=quality, color=(strain), size=ncells ))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female quality and mean CO")+facet_wrap(~mouse)


skel.qual.effect.plot.ff.G <- ggplot(skel.ff[skel.ff$strain == "G",], aes(y=mean.bin, x=quality, color=(strain), size=ncells ))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female quality and mean CO")+facet_wrap(~mouse)

skel.qual.effect.plot.ff.PWD <- ggplot(skel.ff[skel.ff$strain == "PWD",], aes(y=mean.skel, x=quality, color=(strain), size=ncells ))+geom_point()+ 
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female quality and mean CO")+facet_wrap(~mouse)

```



# Age Effect (male)

Some papers have documented age effects for male genome-wide recombination rate [@zelazowski2017age] (after maturity, there's a negative correlation with age and recombination).

> Main Points

 1. Weak evidence for age effect on MLH1 counts for male mice.
 
 - Dom, no significant effects for age.  

 - Musc low, no significant effect for strain or age.  

 - Musc high, no significant age effects on mean CO count


My previous dataset showed age effect for SKIVE males due to unbalanced data. There were only 3 mice of 7,16, and 41 weeks. The models using this dataset had signifcant age effects. The updated data set now has ~4 mice of 7 weeks and no significant age effect.

I tested the age effects with 3 sets of models,  for 3 groupings of mice: dom, musc.high and musc.low 


```{r age.hists, echo=FALSE, eval=FALSE,  warning=FALSE}
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
meta.data$DOB <- as.Date(meta.data$DOB, format= "%m/%d/%Y")#%Y 2000, %y '18,

#make Mouse meta data work .. rename these
MouseMetaData.wrkin <- meta.data[,c(1,4)]
colnames(MouseMetaData.wrkin) <- c("mouse", "DOB")
MouseMetaData.wrkin <- MouseMetaData.wrkin[!(is.na(MouseMetaData.wrkin$mouse)|MouseMetaData.wrkin$mouse==""),]
#do this for the mouse table instead of the MLH1 table
MLH1.imprv <- merge(MLH1_data, MouseMetaData.wrkin)#don't apply the all parameters
#DOB is date
MLH1.imprv <- add_euth_date(MLH1.imprv)
#good euth date..

#make backup date col #add euth date for calculating age
MLH1.imprv$euth.date2 <- MLH1.imprv$euth.date
MLH1.imprv <- add_age(MLH1.imprv)
#age works

#remove mice that are older than 20 weeks
MLH1.imprv.male <- MLH1.imprv[MLH1.imprv$sex == "male", ]
MLH1.imprv.male <- MLH1.imprv.male[MLH1.imprv.male$age.weeks < 20, ]

age.hist <- ggplot(MLH1.imprv[MLH1.imprv$sex == "male", ], aes(age.weeks))+geom_histogram()+facet_wrap(~category)+ggtitle("Male Age and MLH1 counts by subspecies")
age.hist

```


$$mouse .mean CO \sim age + strain + \varepsilon$$

```{r age.effect.model.setupdata, echo=FALSE}
#run a age effect linear regression!
male.data <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$sex.y == "male",]

#remove all nas

#unorder the factors
class(male.data$strain.x) <- "factor"
class(male.data$subsp.x) <- "factor"

male.data.dom <- male.data[male.data$subsp.y == "Dom",]
male.data.dom <- male.data.dom[!(is.na(male.data.dom$Nmice) | male.data.dom$Nmice==""), ]


#MOLF is a low strain
male.data.musc.low <- male.data[(male.data$strain.x == "KAZ" | male.data$strain.x == "TOM" | male.data$strain.x == "AST" | male.data$strain.x == "MOLF"),]
male.data.musc.low <- male.data.musc.low[!(is.na(male.data.musc.low$Nmice) | male.data.musc.low$Nmice==""), ]


male.data.musc.high <- male.data[(male.data$strain.x == "PWD" | male.data$strain.x == "MSM" | male.data$strain.x == "SKIVE"),]
male.data.musc.high <- male.data.musc.high[!(is.na(male.data.musc.high$Nmice) | male.data.musc.high$Nmice==""), ]


male.data.outgroup <- male.data[(male.data$subsp.y == "Spretus" | male.data$subsp.y == "Spic" | male.data$subsp.y == "Caroli"),]
male.data.outgroup <- male.data.outgroup[!(is.na(male.data.outgroup$Nmice) | male.data.outgroup$Nmice==""), ]

```



```{r age.models, echo=FALSE}

lm.me.dom  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.dom)

lm.me.musc.low  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.musc.low)

lm.me.musc.high  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.musc.high)
#significant differences across strains in musc high

lm.me.OG  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.outgroup)

#summary(lm.me.OG)
as.data.frame( round(  summary(lm.me.dom)$coefficients, 6 ) )

as.data.frame( round(  summary(lm.me.musc.low)$coefficients, 6 ) )

as.data.frame( round(  summary(lm.me.musc.high)$coefficients, 6 ) )
```

The plot below shows mouse averages as single points, showing the mean MLH1 and age in weeks. The lines and shading show the smoothed lm for each strain.


```{r age.effect.plot, warning=FALSE, echo=FALSE}
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

#AP_mouse_table_w.Ages <- add_category(AP_mouse_table_w.Ages)
#remove NAs
#AP_mouse_table_w.Ages <- AP_mouse_table_w.Ages[!(is.na(AP_mouse_table_w.Ages$Nmice) | #AP_mouse_table_w.Ages$Nmice==""), ]

#make sure the right dataset 
male.data <- AP_mouse_table_w.Ages[(AP_mouse_table_w.Ages$sex.y == "male") & (AP_mouse_table_w.Ages$category.y != "other"),]
#lots of NA rows... ugh .. remove them
male.data <- male.data[!(is.na(male.data$Nmice) | male.data$Nmice==""), ]

#other removed, no points,
male.data <- male.data[male.data$Ncells > 10,]

age.effect.plot <- ggplot(male.data, aes(y=mean_co, x=age.weeks, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Male Age and mean CO")+facet_wrap(~subsp.y)
age.effect.plot
#no longer has 'other', #yay I added purtty standard colors
#there is an NA
#todo add line to strain.y

```


The models and mostly flat slopes indecate that there isn't a strong age effect on MLH1 for these mice. (there might be a KAZ male outlier (10jul19_KAZ_m3), double check this). Change the colors for KAZ, TOM, AST, and CZECH they're too similar.

While many slopes are different than 0, I am not convinced there is a clear age effect. Most strains don't have more than 2 ages. I will double check some of these mice and check a general linear model.


# Age Effect (female)

Female ages most logically group into neonate or embryo, so I choose to apply a logistic regression to test for age effects. Not all strains have both embryo and neonate female samples, so just, WSB, G, LEW, and PWD are examined.

> Main Point

 - MLH1 counts don't differ between neonates and embryos


Below are the tests for the model (can CO number predict the age stage). I ran these comparisons for cell count and mouse averages. The plots show the points and smoothed curves with age on the y axis, 0 = embryo and 1 = neonate.

$$ Age .Stage \sim CO .number$$

```{r female.age.setup, echo=FALSE}
#compile this dataset
#all female -- meta.dissections has emb or neonate?
#which sheet has this informaiton?

#clean.Meta.Data.txt
clean.meta.data <- read.csv("~./MLH1repo/data/clean.Meta.Data.txt", header = TRUE, sep='\t')
female.age.DF <- clean.meta.data[clean.meta.data$sex == "female",]#166

mergeFULL_F.mlh1 <- merge(female.age.DF, MLH1_data, by = 'mouse')

merge_F.mlh1_cell <- mergeFULL_F.mlh1[ ( (mergeFULL_F.mlh1$strain.x == 'WSB') |
                                       (mergeFULL_F.mlh1$strain.x == 'G') |
                                       (mergeFULL_F.mlh1$strain.x == 'LEW') |
                                  (mergeFULL_F.mlh1$strain.x == 'PWD') ), ]#901

#mouse level
mergeFULL_F.mlh1_mouse <- merge(female.age.DF, AP_mouse_table.HQ, by = 'mouse')#69 mice

merge_F.mlh1_mouse <- mergeFULL_F.mlh1_mouse[ ( (mergeFULL_F.mlh1_mouse$strain.x == 'WSB') |
                                       (mergeFULL_F.mlh1_mouse$strain.x == 'G') |
                                       (mergeFULL_F.mlh1_mouse$strain.x == 'LEW') |
                                  (mergeFULL_F.mlh1_mouse$strain.x == 'PWD') ), ]#42

```



```{r female.age.test_cells, echo=FALSE}
#logistic regression for MLH1 ~ emb | neonate 

#code emb and neonate to 0,1
merge_F.mlh1_cell$age.stage <- ifelse(grepl("emb", merge_F.mlh1_cell$female.stage), 0, 
                       ifelse(grepl("neonate",merge_F.mlh1_cell$female.stage), 1, "other"))
merge_F.mlh1_cell$age.stage <- as.numeric(merge_F.mlh1_cell$age.stage)

logr_age.stage.CELLS <- glm(age.stage ~ nMLH1.foci, data=merge_F.mlh1_cell[merge_F.mlh1_cell$strain.x == "WSB",], family=binomial(link="logit"))
summary(logr_age.stage.CELLS)$coefficients

#
plot.blah.Cells <- ggplot(merge_F.mlh1_cell, aes(x=nMLH1.foci, y=age.stage)) + geom_point() +   stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE) + ggtitle("Cell counts Female age logistic regression \nemb=0, neonate =1")+facet_wrap(~strain.x)
plot.blah.Cells

```



For the cell level curves  (all strains pooled) the p value is not significant. When I isolate the WSB observations, the p value is 0.0778.


```{r female.age.test_mouse, echo=FALSE}

merge_F.mlh1_mouse$age.stage <- ifelse(grepl("emb", merge_F.mlh1_mouse$female.stage), 0, 
                       ifelse(grepl("neonate",merge_F.mlh1_mouse$female.stage), 1, "other"))
merge_F.mlh1_mouse$age.stage <- as.numeric(merge_F.mlh1_mouse$age.stage)

#model fomula
logr_age.stage.MOUSE <- glm(age.stage ~ mean_co, data=merge_F.mlh1_mouse, family=binomial(link="logit"))
#logr_age.stage.MOUSE <- glm(age.stage ~ mean_co, data=merge_F.mlh1_mouse[merge_F.mlh1_mouse$strain.x == "WSB",], family=binomial(link="logit"))
summary(logr_age.stage.MOUSE)$coefficients

plot.blah.MOUSE <- ggplot(merge_F.mlh1_mouse, aes(x=mean_co, y=age.stage)) + geom_point() +   stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE) + ggtitle("Mouse Female age logistic regression \nemb=0, neonate = 1")+facet_wrap(~strain.x)
plot.blah.MOUSE
```

The mouse curves are more slanted, but the logistic regressions are not significant. None of the indiviual strains had significant p values when compared by themselves.


# Room effect

When this project was started the main mouse room for vendor purchased mice was Biotech. The mouse room changed in summer 2017. The Gough mice were always housed in Charmony. Of the final data set there are three strains had mice housed in different rooms; WSB, LEW, and MSM. (not balanced/ limited comparisons / )  


The main questions to address in this section: is there a significant GxE effect due to room?

> Main Points

 - There is some evidence for room effect on MLH1 counts per cell for WSB and LEW female and LEW and MSM male. 

 - No support of room effect for mouse means.


For the cell counts of MLH1, Two of three are in the same direction. Sample size might be having an effect.

There might be more mice/data that can be added to these tests, need to comfirm the move date and verify with lab note book.

```{r ROOM.effect.setup, echo=FALSE, warning=FALSE}
#pull data from the 3 strains
room.effect.DF <- MLH1_data[(MLH1_data$strain == "WSB") | (MLH1_data$strain == "LEW") | (MLH1_data$strain == "MSM"), ]

original_DF <- add_mouse(original_DF)
original_DF <- add_strain(original_DF)

OG.room.effect.DF <- original_DF[(original_DF$strain == "WSB") | (original_DF$strain == "LEW") | (original_DF$strain == "MSM"), ]

#mark / notch which room
#Charmony, MSC3040, Biotech B2420, 

#load in file, merge with the DFs from above
OG.RoomData = read.csv("~./MLH1repo/data/RoomData.csv", header = TRUE)
RoomData = subset(OG.RoomData, select = c(mouse,room)) 

#merge with the DFs from above for cell level data
FULL.room.data = merge(RoomData, room.effect.DF, by= "mouse")
FULL.room.data.OG = merge(RoomData, OG.room.effect.DF, by= "mouse")

#make mouse.level tables
mouse.level.MLH1 <- ddply(.data=FULL.room.data, 
                 .(mouse),
                 summarize, 
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

mouse.level.room.data <- merge(RoomData, mouse.level.MLH1, by="mouse")
mouse.level.room.data <- add_category(mouse.level.room.data)

```


```{r room.effect.tests, echo=FALSE, warning=FALSE}
library(ggsignif)

mouse.level.room.data <- mouse.level.room.data[!(is.na(mouse.level.room.data$mean.MLH1)|mouse.level.room.data$mean.MLH1==""),]

#note the mouse level tests are all throwing errors because not enough samples

#Wlcx.ROOM_WSB.female  <- wilcox.test(FULL.room.data$mean.MLH1[ ( (FULL.room.data$category == "WSB female") & (FULL.room.data$room == "B2420") ) ], 
#            FULL.room.data$mean.MLH1[ ( (FULL.room.data$category == "WSB female") & (FULL.room.data$room == "Charmony") ) ]  ) #raws for compare means match


Wlcx.ROOM_LEW.male  <- wilcox.test(FULL.room.data$nMLH1.foci[ ( (FULL.room.data$category == "LEW male") & (FULL.room.data$room == "B2420") ) ], 
           FULL.room.data$nMLH1.foci[ ( (FULL.room.data$category == "LEW male") & (FULL.room.data$room == "MSC 3040") ) ]  )



#boxplots, facet by 
geom.sig_df.cells = compare_means(nMLH1.foci ~ room, group.by = "category", data = FULL.room.data) %>% mutate(y_pos = 40)

room.boxplots.cell <- ggplot(data=FULL.room.data, aes(x = room, y = nMLH1.foci))+geom_jitter()+geom_boxplot(alpha=.5)+facet_wrap(~category)+
   #test bars
  ggsignif::geom_signif(
    data=geom.sig_df.cells, 
    aes(xmin=group1, xmax=group2, annotations=p, y_position=y_pos),
    manual=TRUE)+
  ggtitle("Boxplots of room effects,\nsingle cell counts, raw p value")
room.boxplots.cell

#needed for comparing means ect.
geom.sig_df.mouse = compare_means(mean.MLH1 ~ room, group.by = "category", data = mouse.level.room.data) %>% mutate(y_pos = 31)

#  ggsignif::

room.boxplots.mouse <- ggplot(mouse.level.room.data, aes(x=room, y=mean.MLH1))+geom_boxplot(alpha=.5)+facet_wrap(~category)+geom_jitter()+
  #test bars
geom_signif(
    data=geom.sig_df.mouse, 
    aes(xmin=group1, xmax=group2, annotations= p, y_position= y_pos ), manual=TRUE) +  ggtitle("Boxplots of room effects,\nmouse means, raw p values")
room.boxplots.mouse

#look up the warning about cols, beccause of %>%?

#remake the boxplots with compare means in the ggplot, to see if that changes the values.
#geom.sig_df.mouse = compare_means(mean.MLH1 ~ room, group.by = "category", data = mouse.level.room.data) %>% mutate(y_pos = 31)



#MORE TESTS TO consider
#the boxplots show different ranges
#room.boxplots.OG <- ggplot(mergy.room.data.OG)
#tukey / post hoc paired comparison
```


The brackets in the plots above reflect the output of 'compare_means()' which uses a wilcox.test.

I double checked the wilcox p values for wilcox.test and compare_means, they're similar.

WSB single wilcox test pvalue is  Wlcx.ROOM_WSB.female$p.value` which is the same as the raw from compare_means(). The compare_means table shows that WSB is multiplied by 2.


The values look a little strange to me, I don't understand the p.adj values yet, (p values multiplied by the number of comparisons). To me it seems like there are 5 t.tests, . I don't know why there are only 3 values of adjusted p-values)


There are significant room effects in the cell level data set. This effect decreases when comparing the mouse level means.  

I think these results indicate that there is not a strong room effect. Also considering that 



# Maternal Age effect


> Main Point

 - Qualitatively, there is unlikely to be a maternal age effect, but these data are underpowered.

```{r mat.age.effect, echo=FALSE}
#pause evaluation -- needs debugging

#this would be the best one so far
meta.data.file_FULL = read.csv("C:/Users/alpeterson7/Documents/MLH1repo/data/DandM_8.30.19.csv", header = TRUE)#updated with a couple more

#are there duplicate mice names?
mat.age_dupies <- meta.data.file_FULL[duplicated(meta.data.file_FULL$mouse),]
#these are blank mouse things 

#try updating the D and M document, #clean up the data
#only those with mat age
meta.data.file_mat.age <- meta.data.file_FULL[!(is.na(meta.data.file_FULL$maternal_DOB)|meta.data.file_FULL$maternal_DOB==""),]
#meta.data.file <- droplevels(meta.data.file)

#needs mouse DOB
meta.data.file_mat.age <- meta.data.file_mat.age[!(is.na(meta.data.file_mat.age$DOB)|meta.data.file_mat.age$DOB==""),]#140

#check the date formats 
meta.data.file_mat.age$mat_DOB.for <- as.Date(meta.data.file_mat.age$maternal_DOB, format= "%m/%d/%Y")
#length(meta.data.file_mat.age$mouse)#152

meta.data.file_mat.age$maternal_DOB <- as.Date(meta.data.file_mat.age$maternal_DOB, format= "%m/%d/%Y")
meta.data.file_mat.age$DOB <- as.Date(meta.data.file_mat.age$DOB, format= "%m/%d/%Y")

#mat.age = euth date - mat.DOB
meta.data.file_mat.age <- add_mat_age(meta.data.file_mat.age)
#DOB, maternal_DOB .. got the 

#merge this mat age file with mlh1 and mouse means!!
mergeFULL_mat.age_cells <- merge(meta.data.file_mat.age, MLH1_data, by = 'mouse')#952 (fewer than last time)

mergeFULL_mat.age_mouse <- merge(meta.data.file_mat.age, AP_mouse_table.HQ, by = 'mouse')#41


#now look at signal / pattern / #hist of data
mat.age.hist.plot <- ggplot(mergeFULL_mat.age_mouse, aes(mat.age.days))+geom_histogram()+facet_wrap(~category)+ggtitle("Maternal ages of females")

mat.age.hist.plot_cells <- ggplot(mergeFULL_mat.age_cells, aes(mat.age.days))+geom_histogram()+facet_wrap(~category)+ggtitle("Maternal ages of females cells")

#plot with MLH1 data
mat.age_MLH1_cells <- ggplot(mergeFULL_mat.age_cells, aes(x = mat.age.days, y=nMLH1.foci, color = mouse))+geom_jitter(alpha=.3, width = 2)+facet_wrap(sex~subsp)+ggtitle("Maternal ages and MLH1")+theme(legend.position = 'none')

mat.age_MLH1_cells

mat.age_MLH1_mouse <- ggplot(mergeFULL_mat.age_mouse, aes(x = mat.age.days, y=mean_co, color = mouse))+geom_jitter(alpha=.3, width = 2)+facet_wrap(sex~subsp)+ggtitle("Maternal ages and MLH1")+theme(legend.position = 'none')

#mat.age_MLH1_cells.KAZ <- ggplot(mergeFULL_mat.age_cells[mergeFULL_mat.age_cells$category == "KAZ male",], aes(x = mat.age.days, y=nMLH1.foci, color = mouse))+geom_jitter()+facet_wrap(~category)+ggtitle("subset mice for maternal ages")+theme(legend.position = 'none')
#mat.age_MLH1_cells.KAZ
```


```{r mat.format.rand, echo=FALSE, eval=FALSE}

#format this meta.data.file
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

meta.data.file.w.mat.DOB <- add_mouse(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_category(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_strain(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_sex(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_subsp(meta.data.file.w.mat.DOB)

#check if date format's been applied before tryung the age functions
#str(meta.data.file.w.mat.DOB)

#DOB and Mat.DOB need to be date formated, make sure that the dates are consistant in the original file
#the dates in my file are not all standardized... year is somethimes 2 - sometimes 4


meta.data.file.w.mat.DOB <- add_euth_date(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_age(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_mat_age(meta.data.file.w.mat.DOB)


#visualize the data
meta.data.file.w.mat.DOB.female <- meta.data.file.w.mat.DOB[meta.data.file.w.mat.DOB$sex == "female",]
meta.data.file.w.mat.DOB.male <- meta.data.file.w.mat.DOB[meta.data.file.w.mat.DOB$sex == "male",]




mat.age.hist.male <- ggplot(meta.data.file.w.mat.DOB.male, aes(mat.age.days))+geom_histogram()+facet_wrap(~category)+ggtitle("Maternal ages of males")
mat.age.hist.male


#remove mice that might have low quality
see.whatcha.do.HQ <- see.whatcha.do[see.whatcha.do$Ncells > 14,]

#age by mean_co (these aren't working)
mat.age.effect.plot.female <- ggplot(see.whatcha.do[see.whatcha.do$sex == "female",], aes(y=mean_co, x=mat.age.days, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female Materinal Age and Mean CO (offsping)")+facet_wrap(~subsp.y)
mat.age.effect.plot.female

mat.age.effect.plot.male <- ggplot(see.whatcha.do.HQ[see.whatcha.do.HQ$sex == "male",], aes(y=mean_co, x=mat.age.days, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Maternal Age and mean CO, male offspring")+facet_wrap(~subsp.y)

#
ALLmat.age.effect.plot.male <- ggplot(see.whatcha.do[see.whatcha.do$sex == "male",], aes(y=mean_co, x=mat.age.days, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Maternal Age and mean CO, male offspring")
+facet_wrap(~subsp.y)

#is there a correlation with proband age and maternal age?
#there is a big lack of maternal age data...
#some of the values reference the original breeding pair..
#from notes on original BPs(males), assigning maternal ages

```


For the topics below, Maternal age, litter and dissection effect are all related, I need to outline/distinguish how and decide if these are worth further investigation.

## Litter effect

Compare female spreads made on the same day, but from different mothers/litters.
```{r litter.effect, eval=FALSE}
#compile this data set

```


## Dissection spread Effect

right now the only independent variable is month dissected. Should I enter info about PFA? time in humid chamber? 


```{r dissection.effect.data.setup, echo=FALSE, warning=FALSE}

#AP_mouse_table_w.Ages$euth.date

mouse.table.female <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$sex.x == "female",]

mouse.table.female <- mouse.table.female[!(is.na(mouse.table.female$mouse) | mouse.table.female$mouse==""), ]

mouse.table.female <- mouse.table.female[!(is.na(mouse.table.female$euth.date) | mouse.table.female$euth.date==""), ]


#add euth dates to MLH1_data
test.this <- MLH1_data[ MLH1_data$mouse %in% mouse.table.female$mouse, ]

mlh1.euth.date.female <- merge(mouse.table.female, MLH1_data, by = "mouse")

```


```{r plot.dissection, echo=FALSE, warning=FALSE}

male.data$euth.date <- as.Date(male.data$euth.date, "%m/%d/%Y")

male.euth.date <- ggplot(male.data, aes(y=mean_co, x=euth.date, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Male Age and mean CO")+facet_wrap(~subsp.y)
male.euth.date


#look at musc
musc.male.euth.date <- ggplot(male.data[male.data$subsp.x == "Musc",], aes(y=mean_co, x=euth.date, color=(age.weeks) ))+geom_point()+ ylim(c(19,34))+
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Musc Male Age and mean CO")+facet_wrap(~strain.x)
musc.male.euth.date

```


```{r dissection.female, echo=FALSE, warning=FALSE}

female.data <- AP_mouse_table_w.Ages[(AP_mouse_table_w.Ages$sex.y == "female") & (AP_mouse_table_w.Ages$category.y != "other"),]
female.data$euth.date <- as.Date(female.data$euth.date, "%m/%d/%Y")

female.euth.date.plot <- ggplot(female.data[female.data$subsp.x == "Musc",], aes(y=mean_co, x=euth.date, color=(strain.y) ))+geom_point()+
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Male Age and mean CO")+facet_wrap(~subsp.y)

female.euth.date.plot


DOM.female.euth.date.plot <- ggplot(female.data[female.data$subsp.x == "Dom",], aes(y=mean_co, x=euth.date, color=(strain.y) ))+geom_point()+
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female Age and mean CO")+facet_wrap(~subsp.y)

DOM.female.euth.date.plot


#female / male, sex.x
#mouse.table.male <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$sex.x == "male",]

test.this <- MLH1_data[ MLH1_data$mouse %in% mouse.table.female$mouse, ]

mlh1.euth.date.female <- merge(mouse.table.female, MLH1_data, by = "mouse")

```


### Total SC

Testing the effects of mean total SC per mouse with when they were dissected. This is mean to be a follow up to peromyscus findings, Where summer caught mice had lower SC area per cell, compared to winter and fall caught. But there were few data points.


```{r total.sc, echo=FALSE, warning=FALSE}
#check out effects of month dissected on SC
#load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/MLH1/MLH1_data_setup_12.20.19.RData")#fixing bugs, formating
#from total SC

#merge
ll <- merge(mouse.level.skel, AP_mouse_table_w.Ages, by = "mouse")  #no
ll$euth.date.2 <- as.Date(ll$euth.date, "%m/%d/%Y")
#ncells is from the full MLH1 DF
#Ncells is from the cleaned, HQ DF

ll <- ll[!(is.na(ll$mean.skel) | ll$mean.skel==""), ]
ll <- ll[!(is.na(ll$sex.y) | ll$sex.y==""), ]

ll <- subset(ll, select = -c(strain.x,strain.y, category.x, category.y, sex.x, sex.y, subsp.x, subsp.y, mouse.1, nmice) )

#ADD month number
ll$month.2 <- month(ll$euth.date.2)

ll.plot <- ggplot(ll, aes(y=mean.skel, x=euth.date.2, color=(strain) ))+geom_point()+
 scale_color_manual(values=colors_of_strains)+
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("")+facet_wrap(~sex)

ll.month.plot <- ggplot(ll, aes(y=mean.skel, x=month.2, color=(strain) ))+geom_point()+
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+
  ggtitle("")+facet_wrap(~sex)

ll.month.plot

```


```{r total.sc.all.cells, echo=FALSE, include=FALSE}
#try ploting all cells

#uu <- merge(MLH1.merge.Skel,AP_mouse_table_w.Ages,by="mouse"  )

#uu$euth.date.2 <- as.Date(uu$euth.date, "%m/%d/%Y")
#uu$month.2 <- month(uu$euth.date.2)

#uu <- uu[!(is.na(uu$skel_size) | uu$skel_size==""), ]
#uu <- uu[!(is.na(uu$sex.x) | uu$sex.x==""), ]

#uu.month.plot.DOM <- ggplot(uu[uu$subsp.x == "Dom",], aes(y=skel_size, x=month.2, color=(mouse) ))+
#  geom_jitter()+  theme(legend.position="none")+
#  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("")+
#  facet_wrap(~sex.x)

```


So, there doesn't seem to be an effect of month dissected on SC area across mice. This might be the start of testing for 'technical effects / humidity effects'. BUT, I don't really have month by month dissections of mice of the same age, etc.

For mice strains that have a similar MLH1 level (control for strain MLH1 effect), check if a month effect for MLH1 count (as seen in Peromyscus).


# Stain Effect

At least 3 slides were made per mouse and I rarely included slides from the same mouse when running the statining protocol. Different staining batch might have effects on the background noise and brightness of the MLH1 foci (these could also be affected by post processing of images to a lesser extent). A siginificant stain effect would indecate technical error / I wasn't consistant in running the staining protocol).

**collect data set for mice with multiple spreads (sp1, sp2 make ddply table that counts a gerp for 'sp1', sp2, ect)**

These data might also be underpowered, since I mostly used 1 spread and it was rare for me to collect over ~20 cells from multiple spreads from the same mouse.
Compare observations from the same mouse, but different MLH1 stains.  First need to identify data that can be used.

```{r stain.effects.SC, eval=FALSE}

#compile this dataset

```

