---
title: "mouse level quality plots"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---


```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
#library(pwr)
library(plyr)
library(lattice)
library(dplyr)

setwd("~./MLH1repo/")
#setwd("C:/Users/alpeterson7/Documents/MLH1repo/")

#setwd("C:/Users/April/Desktop/MLH1repo")
#load(file="data/MLH1/MLH1_data_setup.RData")

#load main data file

load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/MLH1/MLH1_data_setup_1.10.20.RData")#edits to OG.original.DF
#load(file="C:/Users/alpeterson7/Documents/MLH1repo/data/MLH1/MLH1_data_setup_1.5.20.RData")#added batch18
#load(file="data/MLH1/MLH1_data_setup_11.12.19.RData")#added batch17
#load(file="data/MLH1/MLH1_data_setup_9.26.19.RData")#added batch16
#load(file="data/MLH1/MLH1_data_setup_8.29.19.RData")#batch15 isn't showing up
#load(file="data/MetaData.RData")#this Rdata was replacing the most current batch.. agg!

#load functions
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

knitr::opts_chunk$set(echo = TRUE)

#main data frame should be original_DF then changes made to MLH1_data

#remove other!
original_DF <- original_DF[original_DF$strain != "other",]

original_DF <- droplevels(original_DF)
```


```{r clean.OG.DF, echo=FALSE}
#because I want to display the MLH1 means from the OG list
#Have have to do a bit of clean up

#for this doc / report, remove 'X's (these changes to the DF won't be passed on)
original_DF <- original_DF[ !grepl("X", original_DF$X) , ]
original_DF <- original_DF[!(is.na(original_DF$nMLH1.foci) | original_DF$nMLH1.foci==""), ]

original_DF <- original_DF[!(is.na(original_DF$n) | original_DF$n != 20), ]

original_DF <- original_DF[original_DF$nMLH1.foci != "X",]
original_DF <- original_DF[original_DF$nMLH1.foci != "x",]

#
original_DF$n <- as.character(original_DF$n)
original_DF$nMLH1.foci<- as.character(original_DF$nMLH1.foci)
original_DF$quality<- as.character(original_DF$quality)

#remove non-number chrs
original_DF$n <- as.numeric(original_DF$n)
original_DF$nMLH1.foci<- as.numeric(original_DF$nMLH1.foci)
original_DF$quality<- as.numeric(original_DF$quality)

#when first ran there were alot of empty mouse -squares

original_DF <- droplevels(original_DF)

#num are nums, there are still Q5 cells
```


This rmd file shows the cell counts for mouse level for MLH1 count and quality. The black lines are the strain means and the red lines are the mouse level means. Points are colored by the quantification batch.

These plots are meant to asses which mice can be removed from the final dataset for too few or low quality count data.  

The main data frame for these results is original_Df, which is a step removed from the final analysis DF. All of the mice of the data set are shown, to give a better idea of what is take out for the analysis dataset. ('X' labeled cells have been removed, Q5 cells remain).  

Yellow colored boxes are mice that will be exclude from the final (HQ) dataset for low quality cells (5).




### Updating plots

*1. check which category levels do not have data, and enter that index into 'df_list'. Otherwise the loop will be broken.*

*2. Run the code chunks.*



```{r mouse.specific.Qplot, echo=FALSE, message=FALSE, results='hide', warning=TRUE}
### to integrate 'pass'/fail
### this should be in setup data

exclude_mice_list <- c("10mar15_WSB_m2", "8oct14_WSB_f1", "8oct14_WSB_f3", "18nov17_WSB_f5",
                  "8jun15_G_f3", "8jun15_G_f4",
                  "4jan17_LEW_f2",
                  "8oct14_PWD_f3", "1apr15_PWD_f2", "8oct14_PWD_f5",
                  "12sep16_MSM_f3","31aug16_MSM_m2",
                  "27oct18_MOLF_m3",
                  "26oct18_SKIVE_f1","26oct18_SKIVE_f2","26oct18_SKIVE_f3",
                  "27aug18_CZECH_m1","8jun18_CZECH_m1",
                  "3sep18_AST_m1",
                  "3jel18_TOM_m1","3sep18_TOM_m1",
                  "31jul17_HMI_m1","3sep18_HMI_m1","3sep18_HMI_m2",
                 "21aug17_SPI_f1", "30may18_SPIC_f1", "30oct17_SPIC_m1", "8jun18_SPIC_m2"
                  )

#based on this plot make a list of mice to exclude, and figure out code to outline in red
#mostly excluding based on number of 5quality cells


#mice.to.exclude <- 

#WSB; "10mar15_WSB_m2", "8oct14_WSB_f1", "8oct14_WSB_f3", "18nov17_WSB_f5",
#G;  "8jun15_G_f3", "8jun15_G_f4"
#LEW; "4jan17_LEW_f2"
#PWD; "8oct14_PWD_f3", "1apr15_PWD_f2", "8oct14_PWD_f5"
#MSM; "12sep16_MSM_f3",#"14jul17_MSM_f1"
#MOLF; "27oct18_MOLF_m3"
#SKIVE; "26oct18_SKIVE_f1","26oct18_SKIVE_f2","26oct18_SKIVE_f3"
#CZECH; "27aug18_CZECH_m1","8jun18_CZECH_m1"
#AST: "3sep18_AST_m1"
#TOM; "3jel18_TOM_m1","3sep18_TOM_m1"
#HMI; "31jul17_HMI_m1"
#SPIC; "21aug17_SPI_f1", "30may18_SPIC_f1", #"30oct17_SPIC_m1", "8jun18_SPIC_m2", 

#these plots are filled in yellow, but a different alpha/transparency is being applied - I don't know why

#this loop makes a quant_status col for a list of mice (THERE'S AN ARGUMENT FOR Drawing a box around the mouse blocks )
#switch this loop to ex

#shouldn't the DF be the OG DF?

for(i in 1:length(original_DF$mouse)){
  original_DF$quant_status[i] <- ifelse( is.element(original_DF$mouse[i], exclude_mice_list), "exclude", NA)
}


#CZECH is not in this list!!!

df_list <- split(original_DF, (original_DF$category))
#remove sections which are in category but have no data
#this is where you remove the non-data data!
df_list <- df_list[ -c(24, 29) ]

#12 MOLF female, 18 CZECH female?, 24 HMI female, 29 CAROLI female? 31 other
#

#df list, is a list of df's which were split() from BIG df by category
df_list 
o=0
i=0

#MLH1_data$quant_status <- as.factor(MLH1_data$quant_status)

#make a new empty df. create a ddply thing with mean calculations (this is like a list for matching up later)
for(i in 1:(length(df_list))){
 # only include data with quality values, then create a ddply for specific sub-df that calqs mean by each mouse
  df_list[[i]] <- df_list[[i]][!(is.na(df_list[[i]]$quality) | df_list[[i]]$quality==""), ]
  sub_mouse_means <- ddply(df_list[[i]], .(mouse), summarise,
                      mouse_nMLH1 = mean(nMLH1.foci)
  )
# this loop is going though each row of dataframes within the df.list and assigning the mouse mean
  for(o in 1:length(df_list[[i]]$Original.Name)){
    df_list[[i]]$mouse_mean_MLH1[o] <- sub_mouse_means$mouse_nMLH1[ (df_list[[i]]$mouse[o] == sub_mouse_means$mouse) ]
        }
}


plot_list = list()
for (h in 1:length(df_list)) {
  pf <- ggplot(data = df_list[[h]], aes(colour = factor(Batch)), width = 0.25)+ 
    geom_jitter(aes(y= nMLH1.foci, x= quality)) + xlim(c(0.5,5.5))+
  
    #put a box over strain plots based on the col, 'quant_status'
      geom_rect(data = df_list[[h]], aes(fill= quant_status), alpha= 0.045, xmin=-100, xmax=100, ymin=-100, ymax=100)+
  
      scale_fill_manual(values=c("yellow"), breaks=NULL) +   
        
    facet_wrap(~ mouse, drop = TRUE) + 
    geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") +
  

  
      geom_hline(yintercept = c( mean(df_list[[h]]$nMLH1.foci) ), color="black" )
  #theme(plot.background = element_rect(fill = "green")) #theme for indiviual mice, 
  #make an empty ggplot? for missing data
  
  plot_list[[h]] =   pf
}

#orig (I think this is the same as above)
#plot_list = list()
#for (h in 1:length(df_list)) {
#  pf <- ggplot(df_list[[h]],(aes(y= adj_nMLH1.foci, x= quality)))
#  pf <- pf +geom_rect(data = df_list[[h]], aes(fill=quant_status), xmin=-100, xmax=100, ymin=-100, ymax=100, alpha=0.005)

#    pf <- pf + geom_jitter(width = 0.25, aes(colour = factor(Batch)) )
#  pf <- pf + geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
#  pf <- pf + facet_wrap(~ mouse) + geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") + 
    
 #   scale_fill_manual(values=alpha(c("red"), .005), breaks=NULL) +

    #theme for indiviual mice, 
#theme(plot.background = element_rect(fill = "green"))
#  plot_list[[h]] =   pf
#}
#can't change the alpha/transparency of the red rec

#aes must be same length ---   #geom_point(stat = "identity") +
# the last one is correct....?

#so plot list is some wride dataframe, but indeces 1:12 in plot list are ggplots
```



```{r, echo=FALSE, message=FALSE,results='hide', warning=FALSE}
geom_hline(aes(yintercept = med, group = gr), colour = 'red')
#no plot is made that goes in the list -- so it can't be shown
for (gg in 1:length(plot_list) ){
  show(plot_list[gg])
 # invisible(lapply(obj, function(x) plot(x,main="some plot")))
}
```


