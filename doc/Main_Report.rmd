---
title: "MLH1 Data Report"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
    toc_float: yes
  pdf_document: default
bibliography: refs_Main_Report.bib
---

```{r setup, echo=FALSE, include = FALSE}
library(knitr)
library(ggplot2)
#library(pwr)
library(plyr)
library(lattice)
library(dplyr)
setwd("C:/Users/alpeterson7/Documents/MLH1repo/")
#setwd("C:/Users/April/Desktop/MLH1repo")
#load(file="data/MLH1/MLH1_data_setup.RData")

#load main data file


load(file="data/MLH1/MLH1_data_setup_12.3.19.RData")#removed exclude mice
load(file="data/MLH1/MLH1_data_setup_11.12.19.RData")#added batch17
#load(file="data/MLH1/MLH1_data_setup_11.11.19.RData")#deleted DUP image
#load(file="data/MLH1/MLH1_data_setup_9.26.19.RData")#added batch16
#load(file="data/MLH1/MLH1_data_setup_8.29.19.RData") #

#load(file="data/MetaData.RData") #this was replacing most updated data file

#load functions
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
```

# Research Description

Measure nMLH1 foci per meiotic cell to estimate recombination rate for diverse strains of house mice and related rodents. Comparison the differences in recombination rates across sexes and genetic background to inform models of how meiotic recombination rates evolve. 

Cell images are quantified in batches after file names are anonymized. The number of MLH1 foci, number of "achiasmate" and asynasped bivalents are quantified. A quality score is given; 1 to 5 (best to worst). All cell image file names are anonymized and moved into batches of a few hundred images.


```{r organizing.data, echo=FALSE }
#set the order of another column, based on another variable (so that when)

MLH1_data <- MLH1_data %>%
  arrange(strain, sex, category, mouse) %>%
  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match

MLH1_data <- with(MLH1_data, MLH1_data[order(sex, strain),])

# sort your dataframe, by the focal categories
MLH1_data$mouse <- factor(MLH1_data$mouse, levels=unique(MLH1_data$mouse))
#use the above line for when order is out of wak


#count the non-quality measures,  #remove non qualit
#length(MLH1_data[ !(is.na(MLH1_data$quality) | MLH1_data$quality==""), ] )  #15 rows with out quality scores, remove.
#MLH1_data <- MLH1_data[ !(is.na(MLH1_data$quality) | MLH1_data$quality==""), ]

#MLH1_by_F_strain <- MLH1_data[MLH1_data$sex == "female", ]
#MLH1_by_M_strain <- MLH1_data[MLH1_data$sex == "male", ]

#MLH1_data <- MLH1_data %>%
#  arrange(category) %>%
#  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match

#MLH1_data <- with(MLH1_data, MLH1_data[order(category),])

```



```{r missing.mice, echo=FALSE, warning=FALSE, eval=FALSE}
#This section shows the number of mice which haven't been stained or quantified yet.

setwd("C:/Users/alpeterson7/Documents/MLH1repo/")
setwd("~./MLH1repo/")
#other lists

Image_dirs <- list.files(path = "C:/Users/alpeterson7/Documents/Images")
#write this out so that I can access it

#remove the non-mouse folders
Dissection.File = read.csv("~./MLH1repo/data/Disections_53019.csv", header = TRUE)
Dissection.File <- Dissection.File[!(is.na(Dissection.File$mouse)|Dissection.File$mouse==""),]

#print the name with the date of the file somewhere
Dissection.list <- Dissection.File$mouse
Dissection.list <- as.character(Dissection.list)

#load metadata .. start decerning which mice are missing information... and which should be used
Meta.Data.File = read.csv("~./MLH1repo/data/ALP_MouseMetadata.csv", header = TRUE)

#remove file name, and original name .. this is just a mouse level DF
Meta.Data.File <- Meta.Data.File[!(is.na(Meta.Data.File$mouse)|Meta.Data.File$mouse==""),]
#make sure that the DOB is a date


meta.data.file2 = read.csv("~./MLH1repo/data/MouseMetaData61019.csv", header = TRUE)
meta.data.file2$DOB <- as.Date(meta.data.file2$DOB, format= "%m/%d/%y")


jl <- unique(Meta.Data.File$mouse[(Meta.Data.File$mouse %in% Dissection.File$mouse)])
BD.w.meta <- Meta.Data.File[(Meta.Data.File$mouse %in% Dissection.File$mouse), ]


#figure out a way to incorporate the staining... to get a better idea of which slides 
#to do next, #remove the pero mice?

#length(unique(MLH1_data$mouse) )

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
original_DF$fileName <- (original_DF$Original.Name)
original_DF <- add_mouse(original_DF)
#length(unique(original_DF$mouse) )
#131 mice have been quant total, 124 mice have passed into the final version

# make a list for the failed slides

#Dissection.list - Image/dirs
NonImaged.mice <- unique(Dissection.File$mouse[(Dissection.File$mouse %in% Image_dirs)])
#231 mice dissected which need images

#ImageFolder - MLH1.Quant
NonQuant.mice <- unique(Image_dirs[(Image_dirs %in% MLH1_data$mouse )])
#length(NonQuant.mice)
#123 mice that need to get into anon-batch


#make Dataframe to put into a table
mouse.number.DF <- data.frame( category = 
              c("Passed Quantified", "Total Quantified", "Non-Quantified", "Non-Imaged"),
              number.of.mice = c(length(unique(MLH1_data$mouse)),
                length(unique(original_DF$mouse) ),
                        length(NonQuant.mice),
                         length(NonImaged.mice)  )  )

kable(mouse.number.DF)
```



```{r basic.numbers, echo=FALSE, eval=FALSE}

kable(table(AP_mouse_table$category), col.names = c("Category", "mice"), label = "Number of mice by category" )


kable(table(MLH1_data$category), col.names = c("Category","Cells"), label = "Number of Cells by category" )

```


```{r rand, echo=FALSE, include=FALSE}

str(AP_mouse_table_w.Ages)

AP_mouse_table.HQ$var <- as.numeric(AP_mouse_table.HQ$var)

#remove sex.x == na, and strain.x=na or F1
AP_mouse_table.HQ <- AP_mouse_table.HQ[!(is.na(AP_mouse_table.HQ$sex) | AP_mouse_table.HQ$sex==""), ]

AP_mouse_table.HQ <- AP_mouse_table.HQ[!(is.na(AP_mouse_table.HQ$var) | AP_mouse_table.HQ$var==""), ]
#plot variance and mean (facet sex)

#AP_mouse_table_w.Ages <- AP_mouse_table_w.Ages[!( AP_mouse_table_w.Ages$strain.x =="F1"), ]

VandMean.mouse <- ggplot(aes(x=mean_co, y = var), data=AP_mouse_table.HQ )+geom_point(aes(color=strain))+facet_wrap(~sex)+ggtitle("mouse MLH1 averages; variance by mean")

cVandMean.mouse <- ggplot(aes(x=mean_co, y = cV), data=AP_mouse_table.HQ )+geom_point(aes(color=strain))+facet_wrap(~sex)+ggtitle("mouse MLH1 averages; cV by means")

str(AP_mouse_table.HQ)

cor(AP_mouse_table.HQ$mean_co[AP_mouse_table.HQ$sex == "female"], AP_mouse_table.HQ$var[AP_mouse_table.HQ$sex == "female"])
#[1] 0.5750399
cor(AP_mouse_table.HQ$mean_co[AP_mouse_table.HQ$sex == "male"], AP_mouse_table.HQ$var[AP_mouse_table.HQ$sex == "male"])
#0.321601

cor(AP_mouse_table.HQ$mean_co[AP_mouse_table.HQ$sex == "female"], AP_mouse_table.HQ$cV[AP_mouse_table.HQ$sex == "female"])
# 0.3515544
cor(AP_mouse_table.HQ$mean_co[AP_mouse_table.HQ$sex == "male"], AP_mouse_table.HQ$cV[AP_mouse_table.HQ$sex == "male"])
#-0.03713536

cor.test(AP_mouse_table.HQ$mean_co[AP_mouse_table.HQ$sex == "male"], 
    AP_mouse_table.HQ$var[AP_mouse_table.HQ$sex == "male"] )
# p-value = 8.623e-09

cor.test(AP_mouse_table.HQ$mean_co[AP_mouse_table.HQ$sex == "male"], 
    AP_mouse_table.HQ$cV[AP_mouse_table.HQ$sex == "male"] )


#remove mice with fewer than 10 cells

AP_mouse_table.HQ.10plus <- AP_mouse_table.HQ[AP_mouse_table.HQ$Ncells >= 10,]

VandMean.mouse.10plus <- ggplot(aes(x=mean_co, y = var), data=AP_mouse_table.HQ.10plus )+geom_point(aes(color=strain))+facet_wrap(~sex)+ggtitle("10 plus mouse MLH1 averages; variance by mean")



cor(AP_mouse_table.HQ.10plus$mean_co[AP_mouse_table.HQ.10plus$sex == "female"], AP_mouse_table.HQ.10plus$cV[AP_mouse_table.HQ.10plus$sex == "female"])


cor.test(AP_mouse_table.HQ.10plus$mean_co[AP_mouse_table.HQ.10plus$sex == "female"], 
    AP_mouse_table.HQ.10plus$var[AP_mouse_table.HQ.10plus$sex == "female"] )



```




## Repeatability of Human Quantification


Let's talk about the subjective nature of scoring the MLH1 foci. Sources of error or variance across scoring come from background noise (false positives), faint foci (false negatives) and just human error. A general anecdote is that if the quality of the cell staining is high, then the repeatability is near 100%. When the quality is less than perfect, some foci can ambigous and cause the repeatability to decrease.


In the original_DF and MLH1 DF's there are ~400 and X respectively of cells (filenames) that are duplicated, or cells that have been counted in more than 1 quant batch

-re-count of Beth's data,  cells that were counted first then in batch 0 (anonimized)
Datasets / sources of repeat measures
-cell counts from chrm proportions vs batch
-multiple batch counts (later than batch0) *focus on this dataset for now. since its >100 and fairly easy to compile
-old and new (old counts and anonimized batch0)

Some points I still need to address

> Does the amount of error differ across strains or sexes? (female might have a higher error rate)

> What sort of adjustments or tests should be made to results or analyses given the known error rate?


```{r quant.repeatability_rep1, echo=FALSE, include=TRUE, message=FALSE, warning=FALSE}
#set up data for combining replicate counts
#1. replicates in DF, (17 mice, across 10 batches), focus on those from original for now

#isolate the duplicates (fileName) from main MLH1 DFs
n_occur <- data.frame(table(original_DF$fileName))
n_occur[n_occur$Freq > 1,]
original_DF_duplicates <- original_DF[original_DF$fileName %in% n_occur$Var1[n_occur$Freq > 1],]#2 is the max freq of duplicates, 

#are there any batch, fileName duplicates?
original_DF_duplicates$unique.key <-  paste(original_DF_duplicates$fileName, original_DF_duplicates$Batch, sep = "_")
anyDuplicated(original_DF_duplicates$unique.key)#31 duplicated fileName_batch ... really 2?

n_occur <- data.frame(table(original_DF_duplicates$unique.key))
n_occur[n_occur$Freq > 1,]
double.trouble <- original_DF_duplicates[original_DF_duplicates$unique.key %in% n_occur$Var1[n_occur$Freq > 1],]
#2 fileNames from batch 0 appear 2x, remove them from DF

original_DF_duplicates <- original_DF_duplicates[ ! original_DF_duplicates$fileName %in% double.trouble$fileName, ]#removes 4 rows

#seperated duplicates into categories out in Excel (write to /results, moved final file to /data)
#This data frame was made ... with Jered's sugg
#write the duplicate file to csv/excel
#sort by file name
#need to remove '?' -- deal with the ? and X's
#write.table(original_DF_duplicates, "~./MLH1repo/results/orginal_DF_duplicates.csv", sep=",", row.names = FALSE)

original_DF_duplicates.notes = read.csv("~./MLH1repo/data/orginal_DF_duplicates.csv", header = TRUE)
#copies of fileNames can be distinguished with the 'separate.DF' column

#remove '?' that I stupidly left in
original_DF_duplicates.notes$nMLH1.foci = gsub("\\?", "", original_DF_duplicates.notes$nMLH1.foci)
original_DF_duplicates.notes$quality = gsub("\\?", "", original_DF_duplicates.notes$quality)
#these lines change col to chr

original_DF_duplicates.notes <- droplevels(original_DF_duplicates.notes)
#now there should be no more '?' going forward

#original_DF_duplicates.notes$quality <- as.factor(original_DF_duplicates.notes$quality)

#make lists of rows with "" or X's so I can remove all fileNames for those
#these lists just have na
quality.na.list <- original_DF_duplicates.notes$fileName[which(is.na(original_DF_duplicates.notes$quality) | original_DF_duplicates.notes$quality=="")] #16

MLH1.na.list <- original_DF_duplicates.notes$fileName[which(is.na(original_DF_duplicates.notes$nMLH1.foci) | original_DF_duplicates.notes$nMLH1.foci=="") ]#22

X.list <- original_DF_duplicates.notes$fileName[grepl("X", original_DF_duplicates.notes$X)]#40


#make DF which only has 
matches.only <- original_DF_duplicates.notes[ ! original_DF_duplicates.notes$fileName %in% quality.na.list, ]
matches.only <- matches.only[ ! matches.only$fileName %in% MLH1.na.list, ]
matches.only <- matches.only[ ! matches.only$fileName %in% X.list, ]

#str(matches.only)
#clean up match list (chr to num)
matches.only$nMLH1.foci <- as.numeric(matches.only$nMLH1.foci)
matches.only$quality <- as.numeric(matches.only$quality)

#levels(matches.only$nMLH1.foci) #leves don't appear in num?.. move on, dwabt

#check that the 1, and 2 are equal number
#length(matches.only$Original.Name[matches.only$separate.DF == 1]) #both 178

#i want to measure correleation of MLH1 across bins of quality (1,2,3,4,5)
#make new df with filename and MLH1.1 and mlh1.2

dups.here <- data.frame(  FN = unique(matches.only$Original.Name), MLH1.1 = matches.only$nMLH1.foci[matches.only$separate.DF == 1], MLH1.2 = matches.only$nMLH1.foci[matches.only$separate.DF == 2],
                        qual.1 = matches.only$quality[matches.only$separate.DF == 1] , 
                        qual.2 = matches.only$quality[matches.only$separate.DF == 2]
                          ) #OMG this worked!!!
dups.here$diff <- abs(dups.here$MLH1.1 - dups.here$MLH1.2) #the aveage difference is pretty small, but some have very high difference
#the high differences could potentially be mix ups


repeatability.table <- ddply(.data=dups.here, 
                 .(qual.1, qual.2),
                 summarize, 
                 ncells = length(unique(FN)),
                 plain_cor_MLH1 = cor(MLH1.1,MLH1.2)
)
#this table shows how many cells went changed into different qual score bins
#easiest patter, 1-1, 1-2 (high correlation in MLH1)
#5-5 lowest, (5-3 also low)
#4-5 has high corr? (direction shouldn't matter)
#4-2 has negative corr?

#of the different quality permutation bins, 37% don't change quality bin, 44% of cells change by 1 (either direction)

no.change = c(14,13,17,13,10)#67
change.1 = c(10,7,8,20,9,14,4,7)#79

repeatability.table.qual1 <- ddply(.data=dups.here, 
                 .(qual.1),
                 summarize, 
                 ncells = length(unique(FN)),
                 plain_cor_MLH1 = cor(MLH1.1,MLH1.2),
                 dif = mean(MLH1.1 - MLH1.2)
)

repeatability.table.qual2 <- ddply(.data=dups.here, 
                 .(qual.2),
                 summarize, 
                 ncells = length(unique(FN)),
                 plain_cor_MLH1 = cor(MLH1.1,MLH1.2)
)
#These tables show that qual1 cells have the highest corrleation of MLH1
dups.here.plain_cor_qual <- cor(dups.here$qual.1, dups.here$qual.2)


#nMLHJ1, quality are factors
original_DF_duplicates.notes$quality2 = gsub("\\?", "", original_DF_duplicates.notes$quality)

original_DF_duplicates.notes <- droplevels(original_DF_duplicates.notes)

#factor > chr > number  (this col is now chr is can go to num)
#original_DF_duplicates.notes$MLH1.foci2 <- as.numeric(original_DF_duplicates.notes$MLH1.foci2)
#original_DF_duplicates.notes$quality2 <- as.numeric(original_DF_duplicates.notes$quality2)


#one <- original_DF_duplicates.notes[original_DF_duplicates.notes$separate.DF == 1,]
#two <- original_DF_duplicates.notes[original_DF_duplicates.notes$separate.DF == 2,]
#rename this
#plain_cor_MLH1 <- cor(one$MLH1.foci2,two$MLH1.foci2,use = "complete.obs")
#.857
#plain_cor_qual <- cor(one$quality2,two$quality2,use = "complete.obs")
#.63

#What's the relationship of MLH1 cor with quality?
#what the rpeat of quality score?
#what are the correlations across quality score bins?


#issues that complicate the plain calculation
#some duplicates were 'x'ed and some weren't -- this causes different numbers
#connected with above, some duplicates have mlh1 scores, other don't -- this kinda messes up correlation


original_DF_duplicates.notes <- original_DF_duplicates.notes[ !grepl("X", original_DF_duplicates.notes$X) , ]
original_DF_duplicates.notes <- original_DF_duplicates.notes[!(is.na(original_DF_duplicates.notes$nMLH1.foci) | original_DF_duplicates.notes$nMLH1.foci==""), ]
#this causes unequal lengths

original_DF_duplicates.notes <- droplevels(original_DF_duplicates.notes)
original_DF_duplicates.notes$nMLH1.foci <- as.character(original_DF_duplicates.notes$nMLH1.foci)

original_DF_duplicates.notes$nMLH1.foci <- as.numeric(original_DF_duplicates.notes$nMLH1.foci)


#correlationsnMLH1 
#one <- original_DF_duplicates.notes[original_DF_duplicates.notes$separate.DF == 1,]
#two <- original_DF_duplicates.notes[original_DF_duplicates.notes$separate.DF == 2,]
#plain_cor <- cor(one$nMLH1.foci,two$nMLH1.foci)
#old.master.MLH1 <- original_DF[ ! original_DF$fileName %in% ll$fileName, ]


#check that all batches are distinguishable across duplicate fileNames
#make unique key fileName_batch -- then check for duplicate of that 
#original_DF$Batch <- factor(original_DF$Batch, ordered = TRUE, levels = c("Batch0", "Batch1", "Batch2", "Batch3", "Batch4","Batch5","Batch6",  "Batch7", "Batch8","Batch9","Batch10", "Batch11","Batch12", "Batch13", "Batch14","Batch15"))
#after doing this, original_DF$Batch[2000] > original_DF$Batch[10] will be evaluated!

```


```{r repeatability_rep2, echo=FALSE, include=FALSE, eval=FALSE, message=FALSE}
#2. old vs new, (remove duplicates and merge batch0 with old_master_mlh1)
#load, clean up and mat one of the master.MLH1count sheets
#master
old.master.MLH1 = read.csv("~./MLH1repo/data/old_master_MLH1_nov15.csv", header = TRUE)
#remove all with 'X'
#create a real fileName col, add rev.tif, 
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

old.master.MLH1 <- add_mouse(old.master.MLH1)
old.master.MLH1 <- add_strain(old.master.MLH1)
old.master.MLH1 <- add_sex(old.master.MLH1)
old.master.MLH1 <- add_category(old.master.MLH1)
old.master.MLH1$fileName2 <- old.master.MLH1$fileName

test.old.master <- rbind(head(old.master.MLH1), tail(old.master.MLH1) )
test.old.master$fileName <- as.character(test.old.master$fileName)

test.old.master$stain <- as.character(test.old.master$stain)

#str(test.old.master)

#paste together file name, requires mouse, strain
#this might also need some character / factor stuff ... filename and stain MUST be charaecter!
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
#wrote add_fullFileName to make the file names for the old excel sheets

old.master.MLH1 <- add_fullFileName(old.master.MLH1)
old.master.MLH1$fileName <- old.master.MLH1$file.name_full

#merge and match to MLH1

#need to test for duplicates before mergeing?
n_occur <- data.frame(table(old.master.MLH1$file.name_full))
n_occur[n_occur$Freq > 1,]
ll <- old.master.MLH1[old.master.MLH1$file.name_full %in% n_occur$Var1[n_occur$Freq > 1],]
old.master.MLH1 <- old.master.MLH1[ ! old.master.MLH1$fileName %in% ll$fileName, ]

n_occur <- data.frame(table(original_DF$fileName))
n_occur[n_occur$Freq > 1,]
original_DF_duplicates <- original_DF[original_DF$fileName %in% n_occur$Var1[n_occur$Freq > 1],]
table(original_DF_duplicates$mouse)#17 mice 

old.master.MLH1 <- original_DF[ ! original_DF$fileName %in% ll$fileName, ]


#old.master.MLH1 <- original_DF[ ! original_DF$fileName %in% ll$fileName, ]


#there are duplicates in original_DF and MLH1

uutesting2 <- merge(old.master.MLH1, original_DF, by.x = fileName, by.y = Original.Name)
#match old.full.filname with MLH1$fileName
```


```{r repeatability_rep3, echo=FALSE, include=FALSE, message=FALSE}
chrm.class.DF = read.csv("~./MLH1repo/data/ChrmClassProportions.csv", header = TRUE)
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
#what are the target columns for this excel sheet?
#espically for getting repeat data
#MLH1.dif  same_count  quality

chrm.class.DF$fileName <- (chrm.class.DF$Original.Name)
chrm.class.DF <- add_mouse(chrm.class.DF)
chrm.class.DF <- add_strain(chrm.class.DF)
chrm.class.DF <- add_sex(chrm.class.DF)
chrm.class.DF <- add_category(chrm.class.DF)

#assessing error,
#number for same_count == TRUE
#length(chrm.class.DF$Original.Name[chrm.class.DF$same_count == "TRUE"])
#length(chrm.class.DF$Original.Name)

#cor of first count and calq count
#cor(chrm.class.DF$nMLH1.foci, chrm.class.DF$MLH1.sum.check)
#.87


#the true false might have to be changed first
#chrm.class.DF$same_count_num <- as.numeric(chrm.class.DF$same_count)

#regression of quality and MLH1.dif
#lmreg <- lm(abs(MLH1.dif) ~ quality + nMLH1.foci, data= chrm.class.DF)
#summary(lmreg)
#according to this linear regression, quality is not a significant 

#make regression for just same counts
#I tried making a  binomial regression model, 
#but quality is bad predictor, only 5 levels)
#lmreg2 <- glm(same_count ~ quality, data= chrm.class.DF, family=binomial(link="logit"))
#summary(lmreg2)
#to plot the model / bimodal data
#fit = glm(same_count_num ~ as.numeric(quality), data=chrm.class.DF, family=binomial)
#newdat <- data.frame(quality=seq(min(chrm.class.DF$quality), max(chrm.class.DF$quality),len=102))
#newdat$vs = predict(fit, data=newdat, type="response")
#the prediction is not going 1 or 0 -- so doesn't fit logistic
#plot(vs ~ quality, data=newdat, col="red4")
#lines(vs ~ quality, newdat, col="green4", lwd=2)


hist_error_plot <- ggplot(data=chrm.class.DF, aes(MLH1.dif))+geom_histogram()+ggtitle("Distribution of foci count differences across 2 count versions")

#
quality_error_plot <- ggplot(data=chrm.class.DF, aes(x=quality, y=abs(MLH1.dif)  ))+geom_jitter()+ggtitle("Repeatability by quality score")+ylab("difference in quality score")+xlab("quality score")

error_count_plot <- ggplot(data=chrm.class.DF, aes(y=nMLH1.foci, x=abs(MLH1.dif)  ))+geom_jitter()+ggtitle("Error by MLH1 number")+xlab("difference in two counts")+ylab("MLH1 count")

#in the chrm proportions data is another set for eastimating error
```

Data use for this repeatabiity estimate is from smaller dataset where the proportions of chromosome/bivalent classes (0CO bivalents ect.) were quantified. (The focus of one count was cell total, while the other focus was classifying bivalents).

This data has `r length(chrm.class.DF$Original.Name)` cells from mice across these categories

`r kable(table(droplevels(chrm.class.DF$category)))`


```{r show.hist_error_plot, echo=FALSE,  fig.width=10, fig.height=5, warning=FALSE, message=FALSE}
hist_error_plot
```


From this histogram we see most of the cells in this dataset have a difference of less than 2, or `r length(chrm.class.DF$Original.Name[( abs( chrm.class.DF$MLH1.dif) <= 2)]) / length(chrm.class.DF$Original.Name)`%.

```{r show.quality_error_plot, echo=FALSE,  fig.width=10, fig.height=5, message=FALSE}
quality_error_plot
```


There is a positive relationship with the absolute difference and quality score (where 1 is best and 5 is worst quality) (i.e. poorer quality cells are more likely to have more error acorss multiple counts). The proportion of the cells which had the same count is `r length(chrm.class.DF$Original.Name[chrm.class.DF$same_count == "TRUE"]) / length(chrm.class.DF$Original.Name)`%. The correlation between the two versions of MLH1 counts for the same cell is `r cor(chrm.class.DF$nMLH1.foci, chrm.class.DF$MLH1.sum.check)`.

```{r show.error_count_plot, echo=FALSE,  fig.width=10, fig.height=5}
error_count_plot
```
There doesn't seem to be a bias across cells with more foci. 


```{r model.repeat, include=FALSE, eval=FALSE}
#add model -- logisitc regression?
#I tried doing a logistic regression for same_count = true or false depending on the quality score. I am having trouble making a plot the makes sense to confirm the binomial nature of the model.
```



```{r Effects.on.the.dataset, eval=FALSE, echo=FALSE}

#*age effects* (male, maternal age)

#*litter effect*

#*mouse room effect* (Charmony, MSC)

#*quantification repeatability*

#*spread batch and staining effects*

#*power analysis on number of cells*

#*time of year effect (on spread)*

#*dominant effect* (F1s)

```


### Quality effect

There is a positive correlation with MLH1 number and quality. To quantify this effect, compare all of the counts from quality-1 cells across strains. check that the same patterns of means persist compared to the total-cell data.

```{r quality.effect, echo=FALSE}

setwd("C:/Users/alpeterson7/Documents/MLH1repo/doc/")
#compare all quality 1 cells across strains
#check that the means (or directions of differences is maintained)

Q12_MLH1_DF <- MLH1_data[MLH1_data$quality <= 2,]

#ddply
Q12_MLH1_means <- ddply(.data=Q12_MLH1_DF, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

tot.DF_MLH1_means <- ddply(.data=MLH1_data, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

mergy <- merge(Q12_MLH1_means, tot.DF_MLH1_means, by='category', all = F)
colnames(mergy) <- c("category","Q12ncells","Q12mice","Q12_MLH1_means","Q12MLH1var",
                     "Totncells","Totnmice","TotMLH1mean","TotMLH1var")

mergy$percent.diff <- (mergy$Q12_MLH1_means / mergy$TotMLH1mean)

Q12toTotal <- ggplot(mergy, aes(y=Q12_MLH1_means, x=TotMLH1mean))+geom_point(aes(size = Q12ncells) )+geom_abline(slope = 1, intercept = 0)+ggtitle("Quality 1 cells MLH1 mean to total MLH1 mean")+ylim(c(21,32))+xlim(c(21,32))

#Q12toTotal

#check that the directions are the same
#make tables for the 
#is the amount of 'polymorphism' the same

Q12_MLH1_means_males <- ddply(.data=Q12_MLH1_DF[Q12_MLH1_DF$sex == "male",], 
                 .(category,subsp),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci)
)

tot.DF_MLH1_means_males <- ddply(.data=MLH1_data[MLH1_data$sex == "male",], 
                 .(category,subsp),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci)
)

#kable(Q12_MLH1_means_males, caption = "High quality cells")

#kable(tot.DF_MLH1_means_males, caption = "Total Cell")

```

All the quality 1 cells produce a higher mean. The biggest difference in means is HMI male, LEW female and SPIC female means have ~10% differences.

When quality 1 to 2 is compared, the strains were closer to the line, but the means are still higher in the higher quality cells.
with 1-2 most all of the difference are below 10% (except SPRET female).

MOLF males have quite a big difference.

There seem to be the similar amount of polymorphism in the Dom and more conserved in Dom.

Ranges of category means across subspecies.

| Type | male Dom | female Dom | | male Musc low | male Musc high | Musc female | | male Outgroup | female outgroup |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Total cells | 22-24 |  24-27 |  | 23-31 | 25-31 | 26-29 | | 25-26 |27 |
| High quality cells | 23-25 | 25-29 | | 22-25 | 22-27 | 25 | | 26-27 | 29-31 |
(ASTmale in Musc high, has a 27 mean which might be an outlier)
I think the ranges across the groups is generally consistant.


```{r high.qual, fig.caption="boxplots of MLH1 distributions", fig.height=5, fig.width=5, echo=FALSE, warnings=FALSE, include=FALSE}

#MLH1_data$quality <- as.numeric(MLH1_data$quality) #this needs to be run for the subsetting to work
highest_qual_df <-  subset(MLH1_data, as.numeric(MLH1_data$quality) <= 2 )

#are there no KAZ cells of high quality?
qq <- ggplot(highest_qual_df, aes(x = mouse, y = adj_nMLH1.foci)) + geom_boxplot(data = highest_qual_df, aes(fill = factor(strain) ) ) +  ggtitle("Cells with quality scores of 2 or 1") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue",  "coral1", "#E69F00", "red","yellowgreen", "green","purple", "black", "grey", 
             "grey2","grey3","grey1","grey","grey","grey"))
high_qual_boxplot <- qq + facet_wrap(~ sex, scales="free") #this is breaking the kniting... 
#high_qual_boxplot
#these boxplots look bad
```


> *How do the distributions change across different quality scores?*

Higher quality scored cells have more MLH1 foci. (some of the ranges get smaller with higher quality cells)

> *How do the distributions change across mice with a good number of cells?*

(was I referring to normale distributions?)
means all shift up, what about variance, range, lowest cut off

> *Do the directions of the differences across groups change due to quality scores?*

(polymorphism vs divergence patterns)


### Age Effect (male)

Some papers have documented age effects for male genome-wide recombination rate [@zelazowski2017age].

The initial analysis uses plots. This should be double checked with a general linear model as well.


```{r age.hists, echo=FALSE, eval=FALSE,  warning=FALSE}
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
meta.data$DOB <- as.Date(meta.data$DOB, format= "%m/%d/%Y")#%Y 2000, %y '18,

#make Mouse meta data work .. rename these
MouseMetaData.wrkin <- meta.data[,c(1,4)]
colnames(MouseMetaData.wrkin) <- c("mouse", "DOB")
MouseMetaData.wrkin <- MouseMetaData.wrkin[!(is.na(MouseMetaData.wrkin$mouse)|MouseMetaData.wrkin$mouse==""),]
#do this for the mouse table instead of the MLH1 table
MLH1.imprv <- merge(MLH1_data, MouseMetaData.wrkin)#don't apply the all parameters
#DOB is date
MLH1.imprv <- add_euth_date(MLH1.imprv)
#good euth date..

#make backup date col #add euth date for calculating age
MLH1.imprv$euth.date2 <- MLH1.imprv$euth.date
MLH1.imprv <- add_age(MLH1.imprv)
#age works

#remove mice that are older than 20 weeks
MLH1.imprv.male <- MLH1.imprv[MLH1.imprv$sex == "male", ]
MLH1.imprv.male <- MLH1.imprv.male[MLH1.imprv.male$age.weeks < 20, ]

age.hist <- ggplot(MLH1.imprv[MLH1.imprv$sex == "male", ], aes(age.weeks))+geom_histogram()+facet_wrap(~category)+ggtitle("Male Age and MLH1 counts by subspecies")
age.hist

```



```{r age.effect.model, include=FALSE}
#run a age effect linear regression!

male.data <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$sex.y == "male",]

male.data.dom <- male.data[male.data$subsp.y == "Dom",]

male.data.musc.low <- male.data[(male.data$strain.x == "KAZ" | male.data$strain.x == "TOM" | male.data$strain.x == "AST"),]

male.data.musc.high <- male.data[(male.data$strain.x == "PWD" | male.data$strain.x == "MSM" | male.data$strain.x == "MOLF" | male.data$strain.x == "SKIVE"),]

male.data.outgroup <- male.data[(male.data$subsp.y == "Spretus" | male.data$subsp.y == "Spic" | male.data$subsp.y == "Caroli"),]

lm.me.dom  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.dom)

lm.me.musc.low  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.musc.low)

lm.me.musc.high  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.musc.high)
#significant differences across strains in musc high

lm.me.OG  <- lm(mean_co ~ age.weeks+strain.x, data = male.data.outgroup)

summary(lm.me.OG)
#for all models, mostly it was that the intercept was significant, and mot much else
```



```{r female.age.effect, echo=FALSE}
#start thinking of the maternal age effect

#female age effect

#female.meta.data <- meta.data[meta.data$sex == "female",]
#how much data to I have to work with?
#there's a fair number of rows without emb or neonate
#I could probably assume all of these are neonates

#length( !is.na(female.meta.data$female.stage) )
  

#female.meta.data <- female.meta.data[female.meta.data$female.stage]

#how much formating do I have to do?
#can't use AP_mouse_table since that is summarized
#meta.data
#grepl notes, "neo"

#some have e-number for embryonic
#I might have to 

```




```{r age.effect.plot, warning=FALSE, echo=FALSE}
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

AP_mouse_table_w.Ages <- add_category(AP_mouse_table_w.Ages)
#remove NAs
AP_mouse_table_w.Ages <- AP_mouse_table_w.Ages[!(is.na(AP_mouse_table_w.Ages$Nmice) | AP_mouse_table_w.Ages$Nmice==""), ]

#make sure the right dataset 
male.data <- AP_mouse_table_w.Ages[(AP_mouse_table_w.Ages$sex.y == "male") & (AP_mouse_table_w.Ages$category.y != "other"),]
#lots of NA rows... ugh .. remove them
male.data <- male.data[!(is.na(male.data$Nmice) | male.data$Nmice==""), ]

#other removed, no points,
male.data <- male.data[male.data$Ncells > 10,]

age.effect.plot <- ggplot(male.data, aes(y=mean_co, x=age.weeks, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Male Age and mean CO")+facet_wrap(~subsp.y)
age.effect.plot
#no longer has 'other', #yay I added purtty standard colors
#there is an NA
#todo add line to strain.y

```


While many slopes are different than 0, I am not convinced there is a clear age effect. Most strains don't have more than 2 ages. I will double check some of these mice and check a general linear model.


### Age Effect (female)

Compare embryonic to neonate (logistic regression). I don't think my embyonic stage estimates are very accurate, so I'll bin all embryos into 1.

```{r female.age, eval=FALSE}
#compile this dataset
```



### Maternal Age effect

Check if there is a maternal age effect for females and males.

```{r mat.age.effect, echo=FALSE, eval=FALSE}
#pause evaluation -- needs debugging
meta.data.file = read.csv("~./MLH1repo/data/DandM_8.30.19.csv", header = TRUE)

meta.data.file <- meta.data.file[!(is.na(meta.data.file$mouse)|meta.data.file$mouse==""),]
#445? -- probably extras at bottom not good

#how many mice have maternal DOB
meta.data.file.w.mat.DOB <- meta.data.file[!(is.na(meta.data.file$maternal_DOB)|meta.data.file$maternal_DOB==""),]
#151

#format this meta.data.file
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

meta.data.file.w.mat.DOB <- add_mouse(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_category(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_strain(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_sex(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_subsp(meta.data.file.w.mat.DOB)

#check if date format's been applied before tryung the age functions
#str(meta.data.file.w.mat.DOB)

#DOB and Mat.DOB need to be date formated, make sure that the dates are consistant in the original file
#the dates in my file are not all standardized... year is somethimes 2 - sometimes 4
meta.data.file.w.mat.DOB$DOB <- as.Date(meta.data.file.w.mat.DOB$DOB, format= "%m/%d/%Y")#%Y 2000, %y '18,
meta.data.file.w.mat.DOB$maternal_DOB <-as.Date(meta.data.file.w.mat.DOB$maternal_DOB, format= "%m/%d/%Y")

#str(meta.data.file.w.mat.DOB)

meta.data.file.w.mat.DOB <- add_euth_date(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_age(meta.data.file.w.mat.DOB)
meta.data.file.w.mat.DOB <- add_mat_age(meta.data.file.w.mat.DOB)

#merge meta data with MLH1 -- rename this
see.whatcha.do <- merge(AP_mouse_table_w.Ages, meta.data.file.w.mat.DOB, by.x = 'mouse', by.y = 'mouse',all = FALSE )
#remove anything without mean_CO
see.whatcha.do <- see.whatcha.do[!(is.na(see.whatcha.do$mean_co)|see.whatcha.do$mean_co==""),]
see.whatcha.do <- see.whatcha.do[!(is.na(see.whatcha.do$mat.age.days)|see.whatcha.do$mat.age.days==""),]
#what did I do with this DF...?

#visualize the data
meta.data.file.w.mat.DOB.female <- meta.data.file.w.mat.DOB[meta.data.file.w.mat.DOB$sex == "female",]
meta.data.file.w.mat.DOB.male <- meta.data.file.w.mat.DOB[meta.data.file.w.mat.DOB$sex == "male",]


#hist of data
mat.age.hist.female <- ggplot(meta.data.file.w.mat.DOB.female, aes(mat.age.days))+geom_histogram()+facet_wrap(~category)+ggtitle("Maternal ages of females")
mat.age.hist.female

mat.age.hist.male <- ggplot(meta.data.file.w.mat.DOB.male, aes(mat.age.days))+geom_histogram()+facet_wrap(~category)+ggtitle("Maternal ages of males")
mat.age.hist.male


#remove mice that might have low quality
see.whatcha.do.HQ <- see.whatcha.do[see.whatcha.do$Ncells > 14,]

#age by mean_co (these aren't working)
mat.age.effect.plot.female <- ggplot(see.whatcha.do[see.whatcha.do$sex == "female",], aes(y=mean_co, x=mat.age.days, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Female Materinal Age and Mean CO (offsping)")+facet_wrap(~subsp.y)
mat.age.effect.plot.female

mat.age.effect.plot.male <- ggplot(see.whatcha.do.HQ[see.whatcha.do.HQ$sex == "male",], aes(y=mean_co, x=mat.age.days, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Maternal Age and mean CO, male offspring")+facet_wrap(~subsp.y)

#
ALLmat.age.effect.plot.male <- ggplot(see.whatcha.do[see.whatcha.do$sex == "male",], aes(y=mean_co, x=mat.age.days, color=(strain.y) ))+geom_point()+ ylim(c(19,34))+
  #trying this
  scale_color_manual(values=colors_of_strains)+ #this list in setupdata
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Maternal Age and mean CO, male offspring")
+facet_wrap(~subsp.y)

#is there a correlation with proband age and maternal age?
#there is a big lack of maternal age data...
#some of the values reference the original breeding pair..
#from notes on original BPs(males), assigning maternal ages

```




### Litter effect

Compare female spreads made on the same day, but from different mothers/litters.
```{r litter.effect, eval=FALSE}
#compile this data set

```



### Spread and Stain Effects


> *month dissected*

For mice strains that have a similar MLH1 level (control for strain MLH1 effect), check if a month effect for MLH1 count (as seen in Peromyscus).

> *staining batches*

Compare observations from the same mouse, but different MLH1 stains.

```{r stain.effects, eval=FALSE}

#compile this dataset

```



### Room effect

```{r ROOM.effect, eval=FALSE}

#COMPILE THIS datasets
#3 different rooms used to house mice. I should have some data on when the switch was. This would be limited to, WSB, LEW and PWD


```



### Cell number (power analysis results)

Insert the code and results for effects of cell number/observations on MLH1 means.




### Distributions of MLH1 counts

> *Are the MLH1 distributions close to normal?*


```{r MLH1.histogram.2421, echo=FALSE, fig.caption= "histograms", warning=FALSE, fig.align='center', eval=FALSE}


#gg <- data.frame(weight=rep(x,nrow(df)),df)
#gg$y <- with(gg,dnorm(x,mean,sd))
#gg$y <- gg$y * aggregate(weight~sex, weight,length)$weight * #diff(range(weight$weight))/30

mean.MLH1.obs <- ddply(.data=MLH1_data, 
                 .(category),
                 summarize, 
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)


histM <- ggplot(MLH1_data,(aes(adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ category)+ggtitle("Pooled Cell Histograms")+
  geom_line(data=mean.MLH1.obs, aes(y=mean.MLH1.obs$mean.MLH1))
  
#  geom_smooth(method = lm, se = FALSE
 # geom_smooth(method = lm, formula = mean.MLH1.obs$mean.MLH1 ~ mean.MLH1.obs$category, se = FALSE)
  
histM

#function = glm(y ~ x, family = poisson)
#add Poission curve behind
#geom_smooth(method = lm, formula = y ~ splines::bs(x, 3), se = FALSE)
#not sure how to add Expected poisson curve

```


```{r passing.mice.dont.use, echo=FALSE, warning=FALSE}
q_cutoff_table <- ddply(MLH1_data, .(mouse), summarise,
                        total =  length(adj_nMLH1.foci),
                        q5 = sum(as.numeric(quality) >= 4, na.rm = TRUE ), 
                        above5 = sum(as.numeric(quality) <= 4, na.rm = TRUE )
                       # q_l3 = sum(as.numeric(as.numeric(quality)) <= 4, na.rm = TRUE )
)
#q_cutoff_table
passed_mice <- as.vector(q_cutoff_table[q_cutoff_table$above5 > 15,]$mouse)

not_passed <- as.vector(unique(MLH1_data[!(unique(MLH1_data$mouse) %in% passed_mice),]$mouse) )

#mnake dataframe with just passing mice -- so that it can be ploted
passed_mice_df <- MLH1_data[ (as.numeric(MLH1_data$quality) < 5), ]
```


Human quantification seems to be biased towards rating cells with more MLH1 foci as higher quality. Unbiased cell quality assignment, would not show a positive correlation with quality and nMLH1. (CAST female data is fake)



I plotted the mean of each quality bin with a red dot. From the pattern of the red dots, there is definitely a negative relationship with quality and nMLH1 foci across the data. This is most pronounced in MSM males and least pronounced in G males. The CAST female data is dummy data.



# Initial Results

```{r first.boxplots, echo=FALSE, fig.align='center'}


#the below ordering works!! keep it
MLH1_data$strain<- factor(MLH1_data$strain, levels =c("G", "LEW","WSB",
              "PWD","CZECH","SKIVE",
              "KAZ","TOM","AST",
              "MSM","MOLF",
              "CAST","HMI","SPRET","SPIC", "other"), order=T )
#order the data frame
MLH1_data <- with(MLH1_data, MLH1_data[order(sex, strain),])



#never make boxplot with mouse on X. mouse level boxplots should be faceted by subspecies 
#can't re-order the miceagg
#ff <- ggplot(MLH1_data[order(MLH1_data$strain), ], 
#             aes(x = as.factor(mouse), y = adj_nMLH1.foci, fill= strain ))+geom_boxplot()+ ggtitle("Boxplots of MLH1 distributions by mouse") + theme(axis.title.x=element_blank(),
#        axis.text.x=element_blank(),
#        axis.ticks.x=element_blank()) +scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue", #"coral4","coral1", "#E69F00","red", "red4", "red3","purple","grey1", "grey", 
#        "grey","grey","grey",  "grey","grey","grey" )) +
# ylim( c((min(MLH1_data$adj_nMLH1.foci)-3) ), (max(MLH1_data$adj_nMLH1.foci)+5)) + facet_wrap(species~ sex, scales="free")
#don't show M.musculus by mouse
#scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue", "coral4","coral1", "#E69F00","red", "red3", "red4","orange","yellow", "yellow3", 
 #       "green","green4","grey",  "grey","grey","grey" )) +

#order MLH1_data by strain!!
#colors_of_strains, colors .. 
#there is no order to 'mouse' so it looks shitty

justMuscu <- ggplot(MLH1_data[MLH1_data$species == "M.musculus", ])+
  geom_boxplot(aes(x = as.factor(strain), y = adj_nMLH1.foci, fill= strain,alpha=0.5) )+ ggtitle("Boxplots of MLH1 distributions") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
 ylim( c((min(MLH1_data$adj_nMLH1.foci)-3) ), (max(MLH1_data$adj_nMLH1.foci)+3)) +   scale_fill_manual(values=colors_of_strains)
#facet_grid(~sex, scales="free_x")+scale_color_manual(values=colors_of_strains)+

justMuscu <- justMuscu   + facet_wrap(~ sex, scales="free")

#scales="free_y"
#this is ok except for the set placement of mice on x axis
#if the full dataset was ordered correctly, this would kinda fix it


#boxplots by strain
ss <- ggplot(MLH1_data, aes(x = as.factor(strain), y = adj_nMLH1.foci, fill= strain )) + geom_boxplot(aes(alpha=0.5))  + ggtitle("Boxplots of MLH1 distributions by strain") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  ylim( c( (min(MLH1_data$adj_nMLH1.foci)-3), (max(MLH1_data$adj_nMLH1.foci)+5)) )+scale_fill_manual(values=colors_of_strains)

ss <- ss   + facet_wrap(~ sex, scales="free")

#these plot currently look bad
ss
```



```{r variance.boxplots, echo=FALSE}
#plot of variance


var.boxplot <- ggplot(DF.HetC.MixedModel.HQ, aes(x = as.factor(mouse), y = var, fill= strain,alpha=0.5))+ geom_point()+
 ggtitle("Boxplots of MLH1 distributions") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
 ylim( c((min(MLH1_data$adj_nMLH1.foci)-3) ), (max(MLH1_data$adj_nMLH1.foci)+3)) +   scale_fill_manual(values=colors_of_strains)
var.boxplot <- var.boxplot   + facet_wrap(sex ~ strain, scales="free")


#plot by sex / seperately
# HQ data DF.HetC.MixedModel.HQ

var.male <- ggplot(DF.HetC.MixedModel.HQ[DF.HetC.MixedModel.HQ$sex == "male",], aes(x = as.factor(mouse), y = var, fill= strain,alpha=0.5))+ geom_point()+
 ggtitle("Male variance levels") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  scale_fill_manual(values=colors_of_strains)+  ylim( c( 5, 20) )

var.male <- var.male   + facet_wrap( ~ strain, scales="free")



cV.male <- ggplot(DF.HetC.MixedModel.HQ[DF.HetC.MixedModel.HQ$sex == "male",], aes(x = as.factor(mouse), y = cV, fill= strain,alpha=0.5))+ geom_point()+
 ggtitle("Male variance levels") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  scale_fill_manual(values=colors_of_strains)+  ylim( c( 5, 20) )

cV.male <- cV.male   + facet_wrap( ~ strain, scales="free")


```

There are 2 MSM males with high (20) variance and cV, G seems to have more variance across mouse level variance too. 

Check out these mice in comparison to other mice
30sep16_MSM_m1 -- staining might not be the best, MLH1 signal is spottiny in some cells

30may17_MSM_m1 - quite a bit of green noise across these cells. 

Gough and KAZ males has a bit more variation across mice for mouse level variation.


*What is the initial picture of Heterochiasmy across mouse strains?*

For the strain level plots
  -facet,sex by species

```{r HetC.rates, echo=FALSE, include=FALSE, warning=FALSE}
#calculate the initial HetC levels from best quality mice and cells (compare both levels (cell and mouse average levels))

#subset MLH1_DF, remove non passing mice (as diagnoised from plots)
#remove quality 5 cells

#outgroups
#SPIC
HetC.SPIC <- MLH1_data[(MLH1_data$strain == "SPIC")&(MLH1_data$quality < 5),]
#unique(HetC.SPIC$mouse)
#non-passing mice
SPIC.remove.mice <- c("30may18_SPIC_f1", "8jun18_SPIC_m2")
HetC.SPIC <- HetC.SPIC[ ! HetC.SPIC$mouse %in% SPIC.remove.mice, ]
#calq sex mean
SPIC.mean.MLH1.obs <- ddply(.data=HetC.SPIC, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
SPIC.HETC.val <- SPIC.mean.MLH1.obs$mean.MLH1[1] / SPIC.mean.MLH1.obs$mean.MLH1[2]

#SPRET
HetC.SPRET <- MLH1_data[(MLH1_data$strain == "SPRET")&(MLH1_data$quality < 5),]
#unique(HetC.SPRET$mouse)
#non-passing mice
#SPRET.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
SPRET.mean.MLH1.obs <- ddply(.data=HetC.SPRET, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

SPRET.HETC.val <- SPRET.mean.MLH1.obs$mean.MLH1[1] / SPRET.mean.MLH1.obs$mean.MLH1[2]

#CAROLI
HetC.CAROLI <- MLH1_data[(MLH1_data$strain == "CAROLI")&(MLH1_data$quality < 5),]
#unique(HetC.CAROLI$mouse)
#non-passing mice
#SPRET.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
CAROLI.mean.MLH1.obs <- ddply(.data=HetC.CAROLI, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

#cast
HetC.CAST <- MLH1_data[(MLH1_data$strain == "CAST")&(MLH1_data$quality < 5),]
#unique(HetC.CAST$mouse)
#non-passing mice
#X.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
CAST.mean.MLH1.obs <- ddply(.data=HetC.CAST, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
CAST.HETC.val <- CAST.mean.MLH1.obs$mean.MLH1[1] / CAST.mean.MLH1.obs$mean.MLH1[2]

#HMI
HetC.HMI <- MLH1_data[(MLH1_data$strain == "HMI")&(MLH1_data$quality < 5),]
#unique(HetC.HMI$mouse)
#non-passing mice
#X.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
HMI.mean.MLH1.obs <- ddply(.data=HetC.HMI, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

#dom

#WSB
HetC.WSB <- MLH1_data[(MLH1_data$strain == "WSB")&(MLH1_data$quality < 5),]
#unique(HetC.WSB$mouse)
#non-passing mice
WSB.remove.mice <- c("8oct14_WSB_f1", "18nov17_WSB_f5", "16jun15_WSB_f3","10mar15_WSB_m2")
HetC.WSB <- HetC.WSB[ ! HetC.WSB$mouse %in% WSB.remove.mice, ]
#calq sex mean
WSB.mean.MLH1.obs <- ddply(.data=HetC.WSB, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

WSB.HETC.val <- WSB.mean.MLH1.obs$mean.MLH1[1] / WSB.mean.MLH1.obs$mean.MLH1[2]


#LEW
HetC.LEW <- MLH1_data[(MLH1_data$strain == "LEW")&(MLH1_data$quality < 5),]
unique(HetC.LEW$mouse)
#non-passing mice
LEW.remove.mice <- c("4jan17_LEW_f2")
HetC.LEW <- HetC.WSB[ ! HetC.LEW$mouse %in% LEW.remove.mice, ]

#calq sex mean
LEW.mean.MLH1.obs <- ddply(.data=HetC.LEW, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

LEW.HETC.val <- LEW.mean.MLH1.obs$mean.MLH1[1] / LEW.mean.MLH1.obs$mean.MLH1[2]


#G
HetC.G <- MLH1_data[(MLH1_data$strain == "G")&(MLH1_data$quality < 5),]
#unique(HetC.G$mouse)
#non-passing mice
G.remove.mice <- c("8jun15_G_f3","8jun15_G_f4")
HetC.G <- HetC.G[ ! HetC.G$mouse %in% G.remove.mice, ]

#calq sex mean
G.mean.MLH1.obs <- ddply(.data=HetC.G, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
G.HETC.val <- G.mean.MLH1.obs$mean.MLH1[1] / G.mean.MLH1.obs$mean.MLH1[2]


#PERC
HetC.PERC <- MLH1_data[(MLH1_data$strain == "PERC")&(MLH1_data$quality < 5),]
#unique(HetC.PERC$mouse)
#non-passing mice
#G.remove.mice <- c("8jun15_G_f3","8jun15_G_f4")
#HetC.G <- HetC.PERC[ ! HetC.PERC$mouse %in% PERC.remove.mice, ]

#calq sex mean
PERC.mean.MLH1.obs <- ddply(.data=HetC.PERC, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
G.HETC.val <- G.mean.MLH1.obs$mean.MLH1[1] / G.mean.MLH1.obs$mean.MLH1[2]

#MUSC

#PWD
HetC.PWD <- MLH1_data[(MLH1_data$strain == "PWD")&(MLH1_data$quality < 5),]
#unique(HetC.PWD$mouse)
#non-passing mice
PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
PWD.mean.MLH1.obs <- ddply(.data=HetC.PWD, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
PWD.HETC.val <- PWD.mean.MLH1.obs$mean.MLH1[1] / PWD.mean.MLH1.obs$mean.MLH1[2]

# CZECH
HetC.CZECH <- MLH1_data[(MLH1_data$strain == "CZECH")&(MLH1_data$quality < 5),]
#unique(HetC.CZECH$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
CZECH.mean.MLH1.obs <- ddply(.data=HetC.CZECH, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

CZECH.HETC.val <- CZECH.mean.MLH1.obs$mean.MLH1[1] / CZECH.mean.MLH1.obs$mean.MLH1[2]


# SKIVE
HetC.SKIVE <- MLH1_data[(MLH1_data$strain == "SKIVE")&(MLH1_data$quality < 5),]
#unique(HetC.SKIVE$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
SKIVE.mean.MLH1.obs <- ddply(.data=HetC.SKIVE, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

SKIVE.HETC.val <- SKIVE.mean.MLH1.obs$mean.MLH1[1] / SKIVE.mean.MLH1.obs$mean.MLH1[2]



# KAZ
HetC.KAZ <- MLH1_data[(MLH1_data$strain == "KAZ")&(MLH1_data$quality < 5),]
#unique(HetC.KAZ$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
KAZ.mean.MLH1.obs <- ddply(.data=HetC.KAZ, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
KAZ.HETC.val <- KAZ.mean.MLH1.obs$mean.MLH1[1] / KAZ.mean.MLH1.obs$mean.MLH1[2]


#TOM
HetC.TOM <- MLH1_data[(MLH1_data$strain == "TOM")&(MLH1_data$quality < 5),]
#unique(HetC.TOM$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
TOM.mean.MLH1.obs <- ddply(.data=HetC.TOM, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
TOM.HETC.val <- TOM.mean.MLH1.obs$mean.MLH1[1] / TOM.mean.MLH1.obs$mean.MLH1[2]



#AST
HetC.AST <- MLH1_data[(MLH1_data$strain == "AST")&(MLH1_data$quality < 5),]
#unique(HetC.AST$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
AST.mean.MLH1.obs <- ddply(.data=HetC.AST, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
AST.HETC.val <- AST.mean.MLH1.obs$mean.MLH1[1] / AST.mean.MLH1.obs$mean.MLH1[2]


#Molosinus

#MSM
HetC.MSM <- MLH1_data[(MLH1_data$strain == "MSM")&(MLH1_data$quality < 5),]
unique(HetC.MSM$mouse)

#non-passing mice
MSM.remove.mice <- c("12sep16_MSM_f3")
HetC.MSM <- HetC.MSM[ ! HetC.MSM$mouse %in% MSM.remove.mice, ]

#calq sex mean
MSM.mean.MLH1.obs <- ddply(.data=HetC.MSM, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

MSM.HETC.val <- MSM.mean.MLH1.obs$mean.MLH1[1] / MSM.mean.MLH1.obs$mean.MLH1[2]


#MOLF
HetC.MOLF <- MLH1_data[(MLH1_data$strain == "MOLF")&(MLH1_data$quality < 5),]
unique(HetC.MOLF$mouse)

#non-passing mice
MOLF.remove.mice <- c("27oct18_MOLF_m3")
HetC.MOLF <- HetC.MOLF[ ! HetC.MOLF$mouse %in% MOLF.remove.mice, ]

#calq sex mean
MOLF.mean.MLH1.obs <- ddply(.data=HetC.MOLF, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

MOLF.HETC.val <- MOLF.mean.MLH1.obs$mean.MLH1[1] / MOLF.mean.MLH1.obs$mean.MLH1[2]

```



```{r HetC.plot, echo=FALSE, warning=FALSE}
#HETC plot

#make scatter plot for HetC
#color by strain

#set up data
#make female male plot

HetC_strain_table.M <- ddply(MLH1_data[(MLH1_data$quality < 5)&(MLH1_data$sex == "male"),], c("strain"), summarise,
                         Nmice = length(unique(mouse)),
                         Ncells  = length(adj_nMLH1.foci),
                         mean_co = format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3),
                         var = format(round(   var(nMLH1.foci),3), nsmall=3),
                         sd   = round(sd(adj_nMLH1.foci), 3),
                         se   = round(sd / sqrt(Ncells), 3),
                         cV = round( (as.numeric(sd) / as.numeric(mean_co) ),3)
)
#
#HetC_strain_table.M <- HetC_strain_table.M[ -c(7, 4, 10,11,12, 14, 17, 18,19), ]

HetC_strain_table.F <- ddply(MLH1_data[(MLH1_data$quality < 5)&(MLH1_data$sex == "female"),], c("strain"), summarise,
                         Nmice = length(unique(mouse)),
                         Ncells  = length(adj_nMLH1.foci),
                         mean_co = format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3),
                         var = format(round(   var(nMLH1.foci),3), nsmall=3),
                         sd   = round(sd(adj_nMLH1.foci), 3),
                         se   = round(sd / sqrt(Ncells), 3),
                         cV = round( (as.numeric(sd) / as.numeric(mean_co) ),3)
)
#HetC_strain_table.F <- HetC_strain_table.F[ -c(11), ]

HetC_strain_table.M$sex <- "male"
HetC_strain_table.F$sex <- "female"

HetC_strain_table <- merge(HetC_strain_table.M, HetC_strain_table.F, by= "strain")

HetC_strain_table <- add_subsp(HetC_strain_table)

#HetC_strain_table$subsp <- c("Dom", "Dom", "Dom", "Musc", "Musc","Musc","Musc", "Cast", "Outgroup","Outgroup")

HetC_strain_table$mean_co.x <- as.numeric(HetC_strain_table$mean_co.x)
HetC_strain_table$mean_co.y <- as.numeric(HetC_strain_table$mean_co.y)
#str(HetC_strain_table)

Het.C.plot <- ggplot(data= HetC_strain_table, aes(x= mean_co.x, y=mean_co.y, color = subsp ))+ geom_point(aes(size=2)) + xlim(c(20,35)) + ylim(c(20, 35)) + geom_abline(slope = 1, intercept = 0)+labs(x="male MLH1 mean",y="female MLH1 mean")+ggtitle("Heterochiasmy Plot")+
  scale_color_manual(values=c("royalblue", "limegreen",  "tomato", "slategray2", "plum", "grey"))

#musc - coral, Dom - cadetblue (grey blue), 

Het.C.plot
#this plot is missing several 

```


3 of my Musc strains have male biased patter; SKIVE, PWD and MSM.
1 of the musc strains has female biased heterochiasmy, KAZ. 



#### Distributions by mouse

> *Is there mouse level MLH1 quality score bias?*

Below are code chunks that make a big dfs of CO count by quality score plot. The code has been commented out, and moved to it's own doc.

```{r mouse.specific.Qplot, echo=FALSE, message=FALSE, results='hide', warning=TRUE, include=FALSE, eval=FALSE}
### to integrate 'pass'/fail
### this should be in setup data

#mice that don't have female data will break the chain-loop
#MOLF female, HMI, CZECH female, CAROLI female, Tom male

#instead of adding fake data, remove the categories from list

#filler_data_MOLF.f = c("BatchX", "1jan19_fake_MOLF_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_MOLF_f1_sp1_rev.tif",
#                       "fake_MOLF_f1", "MOLF female", "MOLF","female","Musc", "20","")
#filler_data_HMI.f = c("BatchX", "1jan19_fake_HMI_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_HMI_f1_sp1_rev.tif",
#                       "fake_HMI_f1", "HMI female", "HMI","female","Cast", "20","")
#filler_data_CZECH.f = c("BatchX", "1jan19_fake_CZECH_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_CZECH_f1_sp1_rev.tif",
#                       "fake_CZECH_f1", "CZECH female", "CZECH","female","Musc", "20","")
#filler_data_CAROLI.f = c("BatchX", "1jan19_fake_CAROLI_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_CAROLI_f1_sp1_rev.tif",
#                       "fake_CAROLI_f1", "CAROLI female", "CAROLI","female","Caroli", "20","")
#MLH1_data_table <- rbind(MLH1_data, filler_data_MOLF.f,filler_data_HMI.f,filler_data_CZECH.f,filler_data_CAROLI.f)#error from dataset thing

pass_mice <- c("28sep18_CZECH_m3","26oct18_MOLF_m1","22jun15_G_m2")


#this loop makes a quant_status col for a list of mice
for(i in 1:length(MLH1_data$mouse)){
  MLH1_data$quant_status[i] <- ifelse( is.element(MLH1_data$mouse[i], pass_mice), "pass", NA)
}


df_list <- split(MLH1_data, (MLH1_data$category))
#remove sections which are in category but have no data
#this is where you remove the non-data data!
df_list <- df_list[ -c(7,12,14,18,20,21,22,24,26,28,30) ]

#7 PERC, 12 MOLF female, 
#

#df list, is a list of df's which were split() from BIG df by category
df_list 
o=0
i=0

MLH1_data$quant_status <- as.factor(MLH1_data$quant_status)

#make a new empty df. create a ddply thing with mean calculations (this is like a list for matching up later)
for(i in 1:(length(df_list))){
 # only include data with quality values, then create a ddply for specific sub-df that calqs mean by each mouse
  df_list[[i]] <- df_list[[i]][!(is.na(df_list[[i]]$quality) | df_list[[i]]$quality==""), ]
  sub_mouse_means <- ddply(df_list[[i]], .(mouse), summarise,
                      mouse_nMLH1 = mean(adj_nMLH1.foci)
  )
# this loop is going though each row of dataframes within the df.list and assigning the mouse mean
  for(o in 1:length(df_list[[i]]$Original.Name)){
    df_list[[i]]$mouse_mean_MLH1[o] <- sub_mouse_means$mouse_nMLH1[ (df_list[[i]]$mouse[o] == sub_mouse_means$mouse) ]
        }
}


plot_list = list()
for (h in 1:length(df_list)) {
  pf <- ggplot(data = df_list[[h]], aes(colour = factor(Batch)), width = 0.25)+ 
    geom_jitter(aes(y= adj_nMLH1.foci, x= quality)) + 
    geom_rect(data = df_list[[h]], aes(fill=as.factor(quant_status)), alpha=0.5, xmin=-100, xmax=100, ymin=-100, ymax=100)+
    facet_wrap(~ mouse, drop = TRUE) + 
    geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") +scale_fill_manual(values=c(NA, "red"), breaks=NULL) +    geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
  #theme(plot.background = element_rect(fill = "green")) #theme for indiviual mice, 
  #make an empty ggplot? for missing data
  
  plot_list[[h]] =   pf
}

#orig (I think this is the same as above)
#plot_list = list()
#for (h in 1:length(df_list)) {
#  pf <- ggplot(df_list[[h]],(aes(y= adj_nMLH1.foci, x= quality)))
#  pf <- pf +geom_rect(data = df_list[[h]], aes(fill=quant_status), xmin=-100, xmax=100, ymin=-100, ymax=100, alpha=0.005)

#    pf <- pf + geom_jitter(width = 0.25, aes(colour = factor(Batch)) )
#  pf <- pf + geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
#  pf <- pf + facet_wrap(~ mouse) + geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") + 
    
 #   scale_fill_manual(values=alpha(c("red"), .005), breaks=NULL) +

    #theme for indiviual mice, 
#theme(plot.background = element_rect(fill = "green"))
#  plot_list[[h]] =   pf
#}
#can't change the alpha/transparency of the red rec

#aes must be same length ---   #geom_point(stat = "identity") +
# the last one is correct....?

#so plot list is some wride dataframe, but indeces 1:12 in plot list are ggplots
```

```{r show.plots, echo=FALSE, message=FALSE,results='hide', warning=FALSE, include=FALSE, eval=FALSE}
geom_hline(aes(yintercept = med, group = gr), colour = 'red')
#no plot is made that goes in the list -- so it can't be shown
for (gg in 1:length(plot_list) ){
  show(plot_list[gg])
 # invisible(lapply(obj, function(x) plot(x,main="some plot")))
}

#this stops at MSM
```

The mouse specific scatter plots aren't show here because there are too bulky. These plots are in a different document.

Making all of these scatter plots, allows us to look at the whole distributions of the data for each mouse. The distance of the red line from the black could be a indicator of slides or mice with slide specific technical noise.


# Research Questions



### Difference in proportion of chrm classes

generate smaller data set of chrm proportions (0CO, 1CO,2CO ect)
10 cells from each musc category. Add Molf male.


```{r draw.rand.cells, echo=FALSE}
#ss <- sample(MLH1_data[MLH1_data$category == "PWD male",1:4], 10, replace = FALSE)
#ii <- MLH1_data[ sample( which(MLH1_data$category=='G male'), 10 ), ]
```


```{r chrm_prop_data, echo=FALSE}

chrm.class.DF = read.csv("~./MLH1repo/data/ChrmClassProportions.csv", header = TRUE)

chrm.class.DF$fileName <- (chrm.class.DF$Original.Name)
chrm.class.DF <- add_mouse(chrm.class.DF)
chrm.class.DF <- add_strain(chrm.class.DF)
chrm.class.DF <- add_sex(chrm.class.DF)
chrm.class.DF <- add_category(chrm.class.DF)
#chrm.class.DF <- add_euth_date(meta.data.file2)
#chrm.class.DF <- add_age(meta.data.file2)

#table(chrm.class.DF$category)
#str(chrm.class.DF)

#summarize by category
proportion_stats_category  <- ddply(.data=chrm.class.DF[chrm.class.DF$sex == "male",], 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                  tot_biv  = sum(biv.sum.check),

                 n0CO = sum(n0CO),
                  n1CO = sum(n1CO),
                  n2CO = sum(n2CO),
                  n3CO = sum(n3CO),
                  n4CO = sum(n4CO),
                 
                 per0CO = sum(n0CO) / tot_biv,                 
                 per1CO= sum(n1CO)/ tot_biv,
                 per2CO= sum(n2CO)/ tot_biv,
                 per3CO= sum(n3CO)/ tot_biv,
                 per4CO= sum(n4CO)/ tot_biv,
                 
                 mean.MLH1.foci = mean(MLH1.sum.check),
                 mean.MLH1.foci2 = mean(nMLH1.foci),
                 meanQ = mean(quality)

)
#str(this_thing2)

#this first one is the 'first' MLH1 count
oopp2 <- lm( mean.MLH1.foci2 ~ per0CO+ per1CO +per2CO +per3CO, data = proportion_stats_category)
#summary(oopp2)
#none of the classes are significant


#mean is the new calculated-- mean 0CO is significant and intercept
oopp <-  lm( mean.MLH1.foci ~ per0CO+ per1CO +per2CO +per3CO, data = proportion_stats_category)
#summary(oopp)
#not sure if these are inter-correlated
#I don't know why 0COs and the intercept are significant..
#0CO and 1CO are significant when only chrm classes are included (and intercept)


#no longer significant when used
#lm regression indicates that the proportions aren't significant contributers to meanMLH1 -- but this could be due to error
#after added more MSM data, tot_biv is not significant
#0CO is now more significant, and 2CO is sightly significant


#2CO proportion is the most significant, 1CO is second most significat, 3CO doesn't have enough power - total bivalents is also significant, there might be a bias

#MSM needs more bialent observations

#use melt to put all propotions 

#display / visualize / compare proportions

melt.table = read.csv("~./MLH1repo/data/ChrmClassProportions_melt.csv", header = TRUE)
melt.table$fileName <- (melt.table$Original.Name)

#melt.table <- add_mouse(melt.table)
#melt.table <- add_strain(melt.table)
#melt.table <- add_sex(melt.table)
#melt.table <- add_category(melt.table)

melt.table$strain<- factor(melt.table$strain,levels =c("LEW",
                      "WSB","G", "TOM","AST","KAZ", "SKIVE","PWD","MSM"), order=T )

melt.table <- with(melt.table, melt.table[order(strain),])

other_thing <- ggplot(data = melt.table, aes(y = value, x = strain, fill=as.factor(type)) ) + geom_col(position = "dodge")+facet_grid(sex~subsp)

other_thing


chrm.class.DF$perBiv0 <-chrm.class.DF$n0CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv1<-chrm.class.DF$n1CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv2<-chrm.class.DF$n2CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv3<-chrm.class.DF$n3CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv4<-chrm.class.DF$n4CO/chrm.class.DF$biv.sum.check

#chrm.class.DF$biv.sum.check
```

High musc males have half 1CO and 2CO bivalents.
For following up on the biv stuff, find ways to compare the 1CO to 2COs in Dom and Musc. (sis-coten, length, distance from centromere).


# Building Mixed Models

todo: make model with strain as fixed effect (since, there are interesting strain effects)

The mixed model lets us sperate effects to see how they effect a mouse mean CO count. This seperation can also serve as proxies for divergence and polymorphism.

Initial results indicate that male MLH1 counts have less variance within subspecies but more between subspecies compared to female data.

```{r MxMdl.DF.setup, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
library(lme4)
library(nlme)


#change molossinus to it's own subsp (grepl)
DF.HetC.MixedModel2 <- DF.HetC.MixedModel

#pull out values / other things
#summary(model.ff2)# indeces for this object: [1]-structure
#ranef(model.ff2)
#after coding subsp to chr from factor, the co-efficients are 


DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "PERC",]

DF.HetC.MixedModel <- droplevels(DF.HetC.MixedModel)
#table(DF.HetC.MixedModel$strain, DF.HetC.MixedModel$sex)

#after initial analysis look into quality of these mice and ages

#clean up the DF, remove extra cols

#colnames(DF.HetC.MixedModel)
DF.HetC.MixedModel <- subset(DF.HetC.MixedModel, select= -c(sex.y,sex.x,
                                                            subsp.y,subsp.x,
                                                            category.y, category.x,
                                                            strain.x,strain.y, mouse.1  )  )


```


For mouse averages of MLH1 counts, only strain with observations for both sexes and are from Mus species. (maybe I'll look at Species level with spicilegus...?)

subspecies levels: 2, Musc and Domesticus (maybe Molossinus soon)
strain levels: Dom: 3, Musc: 4
sex: 2 female male

`r kable(table(DF.HetC.MixedModel$sex, DF.HetC.MixedModel$strain))`

> Mouse average Models

List of mixed models with mean_co

1. mean_co (chr coded)
2. mean_co.HQ
3. mean_co with Mol
4. sub-sampling



```{r mixed.models.setup, echo=FALSE}
library(raster)
#make are the DFs for the models
# seperate the data, both sexes, only Mus
# decide on Musc - Molossinus
AP_mouse_table_w.Ages$strain <- AP_mouse_table_w.Ages$strain.x
AP_mouse_table_w.Ages$sex <- AP_mouse_table_w.Ages$sex.x
AP_mouse_table_w.Ages$subsp <- AP_mouse_table_w.Ages$subsp.x

#main file, make everything unordered factors
AP_mouse_table_w.Ages <- add_species(AP_mouse_table_w.Ages)
DF.HetC.MixedModel <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$species == "M.musculus",]

DF.HetC.MixedModel <- subset(DF.HetC.MixedModel, select= -c(sex.x, sex.y,
                                                            subsp.y,subsp.x,
                                                            category.y, category.x,
                                                            strain.x,strain.y, mouse.1  )  )

#make dummy MOLF data, average of Musc females?
#no MOLF male data?
female.musc.cells <- MLH1_data[( MLH1_data$sex == "female") & (MLH1_data$subsp == "Musc" ), ]
table(female.musc.cells$quality)

female.musc.mice.table <- ddply(female.musc.cells, c("sex"), summarise,
                        Nmice = length(unique(mouse)),
                        Ncells  = length(adj_nMLH1.foci),
                        mean_co = as.numeric(format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3) ),
                        cV = cv(adj_nMLH1.foci),
                        var = format(round(   var(adj_nMLH1.foci),3), nsmall=3),
                        sd   = round(sd(adj_nMLH1.foci), 3),
                        se   = round(sd / sqrt(Ncells), 3)
                        #quality?
)#just 1 entry

female.musc.mice.table$mouse <- "1jan20_MOLF_f99"
female.musc.mice.table$DOB <- as.Date("1/1/2020")

female.musc.mice.table$strain <- "MOLF"
female.musc.mice.table$subsp <- "Musc"
female.musc.mice.table$species <- "M.musculus"

female.musc.mice.table$female.stage <- "emb"
female.musc.mice.table$age.days <-""
female.musc.mice.table$age.weeks <- ""
female.musc.mice.table$ID <- ""
female.musc.mice.table$notes <- ""
female.musc.mice.table$euth.date <- ""

DF.HetC.MixedModel <- rbind(DF.HetC.MixedModel, female.musc.mice.table)

DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$subsp != "Cast",]
#remove musc strains
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "AST",]
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "TOM",]
#remove PERC, MOLF, CZECH, (no females)
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "CZECH",]
DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "PERC",]
#DF.HetC.MixedModel <- DF.HetC.MixedModel[DF.HetC.MixedModel$strain != "MOLF",]


DF.HetC.MixedModel <- droplevels(DF.HetC.MixedModel)
DF.HetC.MixedModel <- DF.HetC.MixedModel[!(is.na(DF.HetC.MixedModel$mouse) | DF.HetC.MixedModel$mouse==""), ]

#main df with variables coded as chr
DF.HetC.MixedModel <- DF.HetC.MixedModel
DF.HetC.MixedModel$subsp <- factor(DF.HetC.MixedModel$subsp, ordered = FALSE)
DF.HetC.MixedModel$sex <- factor(DF.HetC.MixedModel$sex, ordered = FALSE)
DF.HetC.MixedModel$strain <- factor(DF.HetC.MixedModel$strain, ordered = FALSE)

#mean_co.HQ  (this might remove some of the MOLF males)
DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel[DF.HetC.MixedModel$Ncells > 9,]
DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel.HQ[DF.HetC.MixedModel.HQ$age.weeks < 25,]
DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel.HQ[!(is.na(DF.HetC.MixedModel.HQ$mouse) | DF.HetC.MixedModel.HQ$mouse==""), ]

#mean_co.HQ.mol
DF.HetC.MixedModel.HQ.mol <- DF.HetC.MixedModel.HQ

DF.HetC.MixedModel.HQ.mol$subsp <- ifelse(grepl("MSM", DF.HetC.MixedModel.HQ.mol$strain), "Mol", 
        ifelse(grepl("MOLF", DF.HetC.MixedModel.HQ.mol$strain), "Mol", DF.HetC.MixedModel.HQ.mol$subsp))

DF.HetC.MixedModel.HQ.mol$subsp <- ifelse(grepl(1, DF.HetC.MixedModel.HQ.mol$subsp), "Dom", 
        ifelse(grepl(2, DF.HetC.MixedModel.HQ.mol$subsp), "Musc", DF.HetC.MixedModel.HQ.mol$subsp))

DF.HetC.MixedModel.HQ.mol <- DF.HetC.MixedModel.HQ.mol[!(is.na(DF.HetC.MixedModel.HQ.mol$mouse) | DF.HetC.MixedModel.HQ.mol$mouse==""), ]


#sub-sample (need to think about this one)

```


Peromyscus did everything as factors... (but unordered)

random effects were tested with 
 #rand LRT
this function might not support MM, (and needs linear models instead)

also throws an error about only looking at 1 random effect

Species.COcount.mixed <- lmer(nMLH1.foci ~ species + quality + (1|mouse), data=MLH1.hq.lab, REML = TRUE)
Species.COcount.mixed.sum <- summary(Species.COcount.mixed)
SpeciesCOcount.fix.est <- drop1(Species.COcount.mixed, test="Chisq") 
SpeciesCOcount.Rand.est <- exactRLRT(Species.COcount.mixed)

(what does the significant random test mean) -- variance is not 0?


```{r BaseMixedModel, echo=FALSE}
library(RLRsim)
library(lme4)
#https://rcompanion.org/handbook/G_03.html
#testing random effects within lme


#strain as fixed
newnew <- lme(mean_co ~ sex * strain, data=DF.HetC.MixedModel )



HetC.MixedModel.mean_co <- lme(mean_co ~ subsp * sex, data=DF.HetC.MixedModel, random=list(strain=pdDiag(~sex) ) )

R.strain.HetC.MixedModel.mean_co <- lme(mean_co ~ subsp * sex, data=DF.HetC.MixedModel, random = ~1|strain)#musc-male fixed effect is now significant, and male

full.Reduced.HetC.MixedModel.mean_co <- gls(mean_co ~ subsp * sex, data=DF.HetC.MixedModel)


#CONTRAST models

#base vs strain
fullVstrain <- anova(HetC.MixedModel.mean_co, R.strain.HetC.MixedModel.mean_co)# <.0001

#strain vs no random full.reduce
fullVnon <- anova(HetC.MixedModel.mean_co, full.Reduced.HetC.MixedModel.mean_co) #<.0001

strain.vs.non <- anova(R.strain.HetC.MixedModel.mean_co, full.Reduced.HetC.MixedModel.mean_co)#<.0001

#fullreduce vs strain

#can't distinguish which random effects are more significant -- both tests are significant

fullVreduce22 <- anova(HetC.MixedModel.mean_co, full.Reduced.HetC.MixedModel.mean_co)


#random effects for base model
ranef(HetC.MixedModel.mean_co)
#random effect for just strain
ranef(R.strain.HetC.MixedModel.mean_co)

#reduced model's PWD radom effects is much smaller
#the full model's largest random effects are for PWD and MSM (and MOLF, KAZ for negative)

#fixed effects from full
anova(HetC.MixedModel.mean_co)#NS


#Check how the fixed effects change across these

HetC.MixedModel.mean_co2 <- lmer(mean_co ~ subsp * sex + (1|strain), data=DF.HetC.MixedModel)
#lmer(y~x1 + x2 + (1|g1), data=pbDat)

lmer.MM <- lmer(mean_co ~ subsp * sex + (1|strain), data=DF.HetC.MixedModel, REML = TRUE)

```


Full model, so significant fixed effects. (For the full model, The proportions of the random effects make sense looking at the average CO data
Models with random effects more significant than nulls (both just strain and no radom effects). The models with fewer random effects, the fixed effects, sex and sex*subspec (interaction) become significant.

```{r Base.strain.fixed, echo=FALSE}

#make mixed model with strain as fixed, since there are interesting results

HetC.MM.strain.fixed <- lm(mean_co ~ strain*sex, data= DF.HetC.MixedModel )
#this produces several significant factors

HetC.MM.strain.fixed2 <- lm(mean_co ~ (subsp/strain)*sex, data= DF.HetC.MixedModel )
summary(HetC.MM.strain.fixed2)
#(WSB and G have the most observations, maybe this is biasing the results (for WSB?))


summary(HetC.MM.strain.fixed)
#strainKAZ           -1.57392    0.86769  -1.814 0.071773 . 
#strainPWD           -1.98205    0.74191  -2.672 0.008420 ** 
#strainWSB           -3.09482    0.74191  -4.171 5.21e-05 *** 
#sexmale             -2.89186    0.73333  -3.943 0.000125 ***
#strainMSM:sexmale    6.83426    1.16149   5.884 2.69e-08 *** 
#strainPWD:sexmale    7.04433    1.11783   6.302 3.38e-09 ***  
#strainSKIVE:sexmale  4.04919    2.38756   1.696 0.092056 .   
#strainWSB:sexmale    2.85301    1.04317   2.735 0.007024 ** 

#male effect lowers the mean from intercept
#while strain effects 
```



```{r HQ.MixedModel, echo=FALSE}
table(DF.HetC.MixedModel$strain, DF.HetC.MixedModel$sex)

#mean_co.HQ  (this might remove some of the MOLF males)
DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel[DF.HetC.MixedModel$Ncells > 9,]
#DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel.HQ[DF.HetC.MixedModel.HQ$age.weeks < 25,]
DF.HetC.MixedModel.HQ <- DF.HetC.MixedModel.HQ[!(is.na(DF.HetC.MixedModel.HQ$mouse) | DF.HetC.MixedModel.HQ$mouse==""), ]

#these remove ALL male MSM!
table(DF.HetC.MixedModel.HQ$strain, DF.HetC.MixedModel.HQ$sex)

#mean.co.HQ
HetC.MixedModel.HQ <- lme(mean_co ~ subsp * sex, data=DF.HetC.MixedModel.HQ, random=list(strain=pdDiag(~sex) ) )

summary(HetC.MixedModel.HQ)
ranef(HetC.MixedModel.HQ)

#reduced models
Reduced.strain.HQ <- lme(mean_co ~ subsp * sex, data=DF.HetC.MixedModel.HQ, random = ~1|strain)
summary(Reduced.strain.HQ)
ranef(Reduced.strain.HQ)

Reduced.all.HQ <- gls(mean_co ~ subsp * sex, data=DF.HetC.MixedModel.HQ)
summary(Reduced.all.HQ)
ranef(Reduced.all.HQ)

#strain = fixed
strain.fixed.full <- lm(mean_co ~ subsp * sex * strain, data=DF.HetC.MixedModel.HQ)
summary(strain.fixed.full)
#when strain added as fixed, MSM, PWD and WSB are signifcant, subsp*sex is most significant
#sexmale:strainWSB p=  0.006740 **
#sexmale  p =  3.98e-05 ***
#strainWSB   p=0.000441 ***
#subspMusc:sexmale  p=  0.069493 . 
#non of the 3-way interactions are significant, very puzzeled that WSB is significant and non of ht ehigh Musc are 

strain.fixed <- lm(mean_co ~ sex * strain, data=DF.HetC.MixedModel.HQ)
summary(strain.fixed)

#sexmale  p= 3.98e-05 ***
#strainKAZ p=  0.052420 .  
#strainWSB  p= 0.000441 ***
#sexmale:strainMSM  p=3.42e-09 ***
#sexmale:strainPWD  p= 5.79e-08 ***
#sexmale:strainSKIVE p= 0.069493 .  
#sexmale:strainWSB  p=  0.006740 ** 

#maybe this WSB effec is just in the HQ data set?



#anova for comparing reduced and full models -- 1 of the models should be strain as fixed instead
full2strain <- anova(HetC.MixedModel.HQ, Reduced.strain.HQ)#slightly significant

full.v.fixed <- anova(HetC.MixedModel.HQ, strain.fixed)
#this comparison not useful when there are different fixed effects

full2noRandom <- anova(HetC.MixedModel.HQ, Reduced.all.HQ)# < .0001 

strain2noRandom <- anova(Reduced.strain.HQ, Reduced.all.HQ)#NS



```


Moatly matches the base model results. the same fixed effects are significant in the reduced models. the random effects make sense


```{r MolossinusMixedModel, echo=FALSE}
#base model with molossinus level

DF.HetC.MixedModel.mol <- DF.HetC.MixedModel
str(DF.HetC.MixedModel.mol)#subsp is factor with 2 levels

DF.HetC.MixedModel.mol$subsp <- as.character(DF.HetC.MixedModel.mol$subsp)

#turn to chr first?
#apparently ifelse doesn't retain class
library(data.table)

DF.HetC.MixedModel.mol$subsp <- if_else(grepl("MSM", DF.HetC.MixedModel.mol$strain), "Mol", 
        if_else(grepl("MOLF", DF.HetC.MixedModel.mol$strain), "Mol", DF.HetC.MixedModel.mol$subsp))

str(DF.HetC.MixedModel.mol)
DF.HetC.MixedModel.mol$subsp <- factor(DF.HetC.MixedModel.mol$subsp, ordered = FALSE)


#these remove ALL male MSM!
table(DF.HetC.MixedModel.HQ$strain, DF.HetC.MixedModel.HQ$sex)


#mean.co
HetC.MixedModel.mol <- lme(mean_co ~ subsp * sex, data=DF.HetC.MixedModel.mol, random=list(strain=pdDiag(~sex) ) )

summary(HetC.MixedModel.mol)
ranef(HetC.MixedModel.mol)

#mreducing the model (reducing the random effects)
Reduced.strain.mol <- lme(mean_co ~ subsp * sex, data=DF.HetC.MixedModel.mol, random = ~1|strain)
summary(Reduced.strain.mol)
ranef(Reduced.strain.mol)

Reduced.all.mol <- gls(mean_co ~ subsp * sex, data=DF.HetC.MixedModel.mol)
summary(Reduced.all.mol)

#anova tests
#full vs strain
full2strain.mol <- anova(HetC.MixedModel.mol, Reduced.strain.mol)# < .0001
#full vs non
full2noRandom.mol <- anova(HetC.MixedModel.mol, Reduced.all.mol)# < .0001
#strain vs non
strain2noRandom.mol <- anova(Reduced.strain.mol, Reduced.all.mol)# < .0001

anova(Reduced.strain.mol, Reduced.all.mol, HetC.MixedModel.mol)


#base vs mol model (this only makes sense if these are nested models)
anova(HetC.MixedModel.mean_co, HetC.MixedModel.mol)

```


Issue presented with is that we can see evolution across the strains, but it isn't predicted from mixed modles by strain.
make articifial data / models, like human labels



```{r Base.Variance.MM, echo=FALSE}
#there's 1 mouse with just 1 cell remove
DF.HetC.MixedModel <- DF.HetC.MixedModel[!(is.na(DF.HetC.MixedModel$var) | DF.HetC.MixedModel$var==""), ]

DF.HetC.MixedModel$var <-  as.numeric(DF.HetC.MixedModel$var)

#main var.CO
HetC.MixedModel.var_co <- lme(var ~ subsp * sex, data=DF.HetC.MixedModel, random=list(strain=pdDiag(~sex) ) )

summary(HetC.MixedModel.var_co)
ranef(HetC.MixedModel.var_co)

#main cV.CO
HetC.MixedModel.varco <- lme(var ~ subsp * sex, data=DF.HetC.MixedModel, random=list(strain=pdDiag(~sex) ) )

summary(HetC.MixedModel.cVco)
ranef(HetC.MixedModel.cVco)

just.strain.var_co <- lme(var ~ subsp * sex, data=DF.HetC.MixedModel, random = ~1|strain) 
summary(just.strain.cV_co)

full.Reduced.cv_co <- gls(cV ~ subsp * sex, data=DF.HetC.MixedModel)
summary(full.Reduced.cv_co)

#contrast models
full2strain.CV <- anova(HetC.MixedModel.varco, just.strain.var_co)#0.9997

full2noRandom.CV <- anova(HetC.MixedModel.varco, full.Reduced.var_co) #0.3012

strain2noRandom.CV <- anova(just.strain.var_co, full.Reduced.var_co)#0.1213
#for var, p = 0.0219

```




```{r Mixed.models.pooled.cells, echo=FALSE, eval=FALSE}

#pooled.cells
DF.HetC.MixedModel.pooled <- MLH1_data[MLH1_data$species == "M.musculus",]
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[DF.HetC.MixedModel.pooled$subsp != "Cast",]
#remove musc strains
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[DF.HetC.MixedModel.pooled$strain != "AST",]
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[DF.HetC.MixedModel.pooled$strain != "TOM",]

#remove PERC, MOLF, CZECH,
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[DF.HetC.MixedModel.pooled$strain != "CZECH",]
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[DF.HetC.MixedModel.pooled$strain != "MOLF",]
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[DF.HetC.MixedModel.pooled$strain != "PERC",]


#sex only has 2 levels and this breaks...
model.pooled <- lme(nMLH1.foci ~ subsp * sex, data=DF.HetC.MixedModel.pooled, random=list(strain=pdDiag(~sex) ) )

#pull out values / other things
summary(model.pooled)# indeces for this object: [1]-structure
ranef(model.pooled)

model.pooled$coefficients

#pooled cells,  DF.HetC.MixedModel.pooled
DF.HetC.MixedModel.pooled <- droplevels(DF.HetC.MixedModel.pooled)
DF.HetC.MixedModel.pooled <- DF.HetC.MixedModel.pooled[!(is.na(DF.HetC.MixedModel.pooled$mouse) | DF.HetC.MixedModel.pooled$mouse==""), ]


DF.HetC.MixedModel.pooled$sex <- factor(DF.HetC.MixedModel.pooled$sex, ordered = TRUE, levels =c("male", "female") )

DF.HetC.MixedModel.pooled$strain<- factor(DF.HetC.MixedModel.pooled$strain, ordered = TRUE, levels =c( "WSB", "G", "LEW", "PWD", "MSM", "SKIVE", "KAZ") )

DF.HetC.MixedModel.pooled <- droplevels(DF.HetC.MixedModel.pooled)


```



```{r HQ.var, echo=FALSE}

DF.HetC.MixedModel.HQ$var <-  as.numeric(DF.HetC.MixedModel.HQ$var)

#HQ var.CO
HetC.MixedModel.HQ.var_co <- lme(cV ~ subsp * sex, data=DF.HetC.MixedModel.HQ, random=list(strain=pdDiag(~sex) ) )

summary(HetC.MixedModel.HQ.var_co)
ranef(HetC.MixedModel.HQ.var_co)


HQjust.strain.var_co <- lme(cV ~ subsp * sex, data=DF.HetC.MixedModel.HQ, random = ~1|strain) 

summary(HQjust.strain.var_co)


HQfull.Reduced.cv_co <- gls(cV ~ subsp * sex, data=DF.HetC.MixedModel.HQ)
summary(HQfull.Reduced.cv_co)

#contrast models
full2strain.CV <- anova(HetC.MixedModel.HQ.var_co, HQjust.strain.var_co)#

full2noRandom.CV <- anova(HetC.MixedModel.HQ.var_co, HQfull.Reduced.cv_co)#

strain2noRandom.CV <- anova(HQjust.strain.var_co, HQfull.Reduced.cv_co)# 0.0469


```




- The MSM strain effec is 0, but the sex*strain for molossinus is 7 (this seems very high). This means there is 0 variance added to mean_CO to mean due to being MSM. Does this mean the model is very good at predicting MSM mean_CO. The fixed strain - sex effects are for musc are large. 
This will likely change with MOLF (male molf are low, so smaller fixed effect and )

- I think adding Mol, moves the highest strain into it's own category, so the coefficient is large.
In the first model MSM has largest random effect, since it's so far from WSB female.

-adding MOLF also doesn't have significant factors


The intercept level is Dom female.

`r kable(HetC.MixedModel.mean_co$coefficients$fixed, col.names = "coefficients", caption="Main mean_co model")`

`r kable(ranef(HetC.MixedModel.mean_co) )`

changed all to unordered factors.
all the variables are coded as ordered factors.
When the variables are kept factors, and unordered the names appear! yay!

Character assigned variables.  The values are now quite different. Male, sex coefficient is negative. The fixed sex coefficient is the sex effect independant of subspecies or strain.


`r kable(HetC.MixedModel.HQ$coefficients$fixed, caption="mean_co HQ model", col.names = "coefficients")`

`r kable(ranef(HetC.MixedModel.HQ) )`

Fixed and random effects



`r kable(HetC.MixedModel.HQ.mol$coefficients$fixed, caption="Main HQ model with molossinus", col.names = "coefficient")`

`r kable(ranef(HetC.MixedModel.HQ.mol) )`



### Another Heterochiasmy Plot

```{r HetC.plot22, echo=FALSE,  fig.width=10, fig.height=5, fig.caption="Sex-Specific MLH1 average"}


no_female <- c("HMI", "SKIVE", "CZECH", "MOLF", "CAROLI", "TOM","AST")

MixedModel_CO_data <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$strain.x != "other",]
CO_data_HetC_w.old <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$strain.x != "other",]
CO_data_HetC_w.old <- CO_data_HetC_w.old[ ! CO_data_HetC_w.old$strain.x %in% no_female, ]
CO_data_HetC_w.old <- CO_data_HetC_w.old[!(is.na(CO_data_HetC_w.old$Nmice) | CO_data_HetC_w.old$Nmice==""), ]

MixedModel_CO_data <- MixedModel_CO_data[MixedModel_CO_data$age.weeks < 15,]

MixedModel_CO_data <- MixedModel_CO_data[!(is.na(MixedModel_CO_data$mouse) | MixedModel_CO_data$mouse==""), ]


MixedModel_CO_data <- MixedModel_CO_data[ ! MixedModel_CO_data$strain.x %in% no_female, ]

kuku <- ggplot(MixedModel_CO_data, aes(y=mean_co, x=mouse, color=sex.y))+geom_point()+facet_wrap(~strain.x)

bubu <- ggplot(data=CO_data_HetC_w.old)+geom_point(aes(y=mean_co, x=mouse, color=sex.x))+facet_wrap(~strain.x)

#add titles
#use multiplot
#remove X axis

multiplot(kuku,bubu, cols=2)
```


## Total SC Measures

data has been collection for total SC per cell [@wang_2019_sc]. These results are consistant with the patterns seen in the bivalent level resutls. (total SC PWD > KAZ )



```{r RWscSkel, echo=FALSE}
#merge the sc.skel outputs with the master MLH1 measures
#match up random names with original names

#the skel output and scripts are in the SC_skel dir. it was run on all images in the anon_data folder. I haven't manually confirmed that the default parameters are skeletonizing the images correctly.


#some of richard's analysis show negative relationship with SC length and MLH1 (his QTL word doc). Could this be sign
# of pwd like regulation?

setwd("~./")
SC.skel = read.csv("~./SC_skeletonize/data/SCskel_output_sep19.csv", header = TRUE, strip.white = TRUE)


SC.skel$rand_name <- as.character(SC.skel$rand_name)

#check for duplicatations of the random name
original_DF$Random.Name <- as.character(original_DF$Random.Name)
duplies <- original_DF[duplicated(original_DF$Random.Name),]


blah <- anyDuplicated(original_DF$Random.Name)#there are 64 duplicated random names -- which looks like 3 rows of ""



#str(SC.skel)
#str(original_DF)

mlh1.skel.og <- merge(original_DF, SC.skel, by.x = "Random.Name", by.y = "rand_name", all= F)
#what if there are duplicate random names!!!

#for some reason this only worked after the chr and all = F

mlh1.skel.og <- mlh1.skel.og[ !grepl("X", mlh1.skel.og$Batch) , ]
mlh1.skel.og <- mlh1.skel.og[ !grepl("x", mlh1.skel.og$Batch) , ]
mlh1.skel.og <- mlh1.skel.og[!(is.na(mlh1.skel.og$quality) | mlh1.skel.og$quality==""), ]

mlh1.skel.og <- add_mouse(mlh1.skel.og)
mlh1.skel.og <- add_strain(mlh1.skel.og)
mlh1.skel.og <- add_sex(mlh1.skel.og)

mlh1.skel.og <- add_category(mlh1.skel.og)
mlh1.skel.og <- add_subsp(mlh1.skel.og)

#mlh1.skel.og <- add_euth_date(mlh1.skel.og)
#mlh1.skel.og <- add_age(mlh1.skel.og)

#str(mlh1.skel.og)
mlh1.skel.og$skel_size  <- as.numeric(mlh1.skel.og$skel_size)
mlh1.skel.og$bin_size <- as.numeric(mlh1.skel.og$bin_size)
mlh1.skel.og$nMLH1.foci <- as.numeric(mlh1.skel.og$nMLH1.foci)

#remove outliers
mlh1.skel <- mlh1.skel.og[mlh1.skel.og$skel_size < 25000,]
#first test file has ~1000 measures
#when I ran it, no sign of outliers (after removing all the X's cells)

looky <- ggplot(data = mlh1.skel.og[mlh1.skel.og$subsp == "Dom",], aes(y=skel_size, x=quality) ) + geom_jitter() + facet_wrap(sex~strain)


looky <- ggplot(data = mlh1.skel.og[mlh1.skel.og$subsp == "Musc",], aes(y=skel_size, x=nMLH1.foci, color=mouse) ) + geom_jitter() + facet_wrap(sex~strain)+theme(legend.position="none")  +ylim(c(0,2000))
#very possible that the dimesions and pixel density are skrewing with these values
# I am suspcious that there is such a wide range for the female data
looky

looky.DOM <- ggplot(data = mlh1.skel.og[mlh1.skel.og$subsp == "Dom",], aes(y=skel_size, x=nMLH1.foci, color=mouse) ) + geom_jitter() + facet_wrap(sex~strain)+theme(legend.position="none")  +ylim(c(0,2000))
looky.DOM

#mouse level
mouse.level.skel <- ddply(.data=mlh1.skel.og, 
                 .(mouse),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(nMLH1.foci),
                 mean.skel = mean(skel_size)
)

mouse.level.skel <- add_strain(mouse.level.skel)
mouse.level.skel <- add_sex(mouse.level.skel)
mouse.level.skel <- add_category(mouse.level.skel)
mouse.level.skel <- add_subsp(mouse.level.skel)


looky.mouse <- ggplot(data = mouse.level.skel[mouse.level.skel$subsp == "Musc",], aes(y=mean.skel, x=mean.MLH1, color=strain) ) + geom_jitter() +ylim(c(150,1200))+facet_wrap(subsp~sex)

looky.mouseDom <- ggplot(data = mouse.level.skel[mouse.level.skel$subsp == "Dom",], aes(y=mean.skel, x=mean.MLH1, color=strain) ) + geom_jitter() +ylim(c(150,1200))+facet_wrap(subsp~sex)

#theme(legend.position="none") 

#double check a way to visually inspect the python skel output
#
#repeat random numbers?
```



```{r test.BivData, echo=FALSE}
#bivdata
setwd("~./")
MSM_BivData.og = read.csv("~./MLH1repo/data/BivData/Curate_MSMmale_9.9.19.csv", header = TRUE, strip.white = TRUE )

MSM_BivData <- MSM_BivData.og[MSM_BivData.og$SC.pass ==1,]
MSM_BivData <- MSM_BivData[!(is.na(MSM_BivData$hand.foci.count) | MSM_BivData$hand.foci.count==""), ]

#MSM_BivDatam_CO2 <- MSM_BivData[MSM_BivData$hand.foci.count == 2,]
#MSM_BivDatam_CO2 <- MSM_BivDatam_CO2[!(is.na(MSM_BivDatam_CO2$fileName) | MSM_BivDatam_CO2$fileName==""), ]

#MSM_BivDatam_CO2$Foci1.PER <- MSM_BivDatam_CO2$Foci1 /MSM_BivDatam_CO2$chromosomeLength
#MSM_BivDatam_CO2$Foci2.PER <- MSM_BivDatam_CO2$Foci2 /MSM_BivDatam_CO2$chromosomeLength 

MSM_BivData <- add_IFD(MSM_BivData)
#add IFD2 is f-ing up 
MSM_BivData <- addIFD.2(MSM_BivData)

#this MSM PER.IFD, is similar to the PWD data

#new function is converting all hand.foci counts to 3
#it might be the IFD functions


source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
new_shiny <- add_SisCoTen(MSM_BivData)

new_shiny$rel_Siscoten <- new_shiny$SisCoTen / new_shiny$chromosomeLength

qq <- ggplot(data = new_shiny, aes(y=chromosomeLength, x=rel_Siscoten) ) + geom_jitter()

#ww <- ggplot(data = MSM_BivDatam_CO2, aes(y=IFD1_PER, x=mouse, color = fileName) ) + geom_jitter()+
#  geom_boxplot(aes(alpha=.3))

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
#KAZ and PWD data set is larger
PWD_KAZ_BivData.og = read.csv("~./MLH1repo/data/BivData/Merged_Curate_PWD.KAZ_BivData.csv", header = TRUE, strip.white = TRUE )

PWD_KAZ_BivData <- PWD_KAZ_BivData.og[PWD_KAZ_BivData.og$SC.pass == 1,]

PWD_KAZ_BivData <- add_IFD(PWD_KAZ_BivData)
PWD_KAZ_BivData <- addIFD.2(PWD_KAZ_BivData)
PWD_KAZ_BivData <- add_SisCoTen(PWD_KAZ_BivData)
PWD_KAZ_BivData$rel_Siscoten <- PWD_KAZ_BivData$SisCoTen / PWD_KAZ_BivData$chromosomeLength
PWD_KAZ_BivData <- add_mouse(PWD_KAZ_BivData)
PWD_KAZ_BivData <- add_strain(PWD_KAZ_BivData)

mouse_boxes <- ggplot(data = PWD_KAZ_BivData, aes(y=rel_Siscoten, x=mouse) ) + geom_jitter(aes( color=fileName))+
  geom_boxplot(aes(alpha=.3))+theme(legend.position="none")

mouse_boxes2 <- ggplot(data = PWD_KAZ_BivData, aes(y=SisCoTen, x=mouse) ) + geom_jitter(aes( color=fileName))+
  geom_boxplot(aes(alpha=.3))+theme(legend.position="none")

#mean relative and raw sisco-ten is higher in PWD compared to KAZ

biv_boxes <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=hand.foci.count, fill=hand.foci.count) ) + geom_jitter()+geom_boxplot(aes(x= hand.foci.count,alpha=.3))+
theme(legend.position="none")+facet_wrap(~strain)

biv_boxes22 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=as.factor(hand.foci.count)) )+ geom_jitter()+
  geom_boxplot(aes(alpha=.3))+theme(legend.position="none")+facet_wrap(~strain)


biv_boxes2 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=rel_Siscoten, x=hand.foci.count) ) + geom_jitter(aes( ))+
theme(legend.position="none")+facet_wrap(~strain)

regress <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=chromosomeLength) ) + geom_jitter(aes( color=as.factor(hand.foci.count) ))+ facet_wrap(~strain)




regress.1 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+ theme(legend.position="none")+ facet_wrap(~strain)
#, 1mar15_PWD_m1

regress.2 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+ theme(legend.position="none")+ facet_wrap(~strain)
#, 1mar15_PWD_m1

#

regress.1.KAZ <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$mouse == "21may18_KAZ_m2",], aes(y=SisCoTen, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+
 theme(legend.position="none")+ facet_wrap(~fileName)


#doesn't look like the sis-co-ten is conserved across bivs

```




```{r within.cell.corr, echo=FALSE}

#test telomere distance
#centromere distance
#SC length

#I want to test if SC lengths within cells cluster
#wouldn't ANOVA get at this..?

#cell level variance is significant predictor for SC length (telomere)

#PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",]
jjgg <- ddply(.data= PWD_KAZ_BivData,
                 .(fileName),
                 summarize, 
                 nbiv = length(unique(Obj.ID) ),
                  var.sc = var(chromosomeLength)
)

#reasons why this within cell correlation doesn't work well with bivalent data
  #different sets of chrms
#not enough resolution at cytology level

```


sis-coten metric:
I am currently missing a null model / test for this metric
(sis-co-ten from uniform placement of COs, and (some prob of draw for CO number))


there is a positive correlation with siscoten and chrm length 

there could be something about kinetochore sites differing across specific chromosomes that balance the force



# References