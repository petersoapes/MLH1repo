---
title: "MLH1 Data Report"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, echo=FALSE, include = FALSE}
library(knitr)
library(ggplot2)
#library(pwr)
library(plyr)
library(lattice)
library(dplyr)
setwd("C:/Users/alpeterson7/Documents/MLH1repo/")
#setwd("C:/Users/April/Desktop/MLH1repo")
#load(file="data/MLH1/MLH1_data_setup.RData")
load(file="data/MLH1/MLH1_data_setup_8.15.19.RData")

```

#### Research Description

Measure nMLH1 foci per meiotic cell to estimate recombination rate for diverse strains of house mice abd related rodents. Comparison the differences in recombination rates across sexes and genetic background to inform models of how meiotic recombination rates evolve. 

#### Description of Report

- Display plots and figures of distributions of MLH1 counts to assess intial overall patterns.

-  Report basic statistics of results and to help keep track of the number of images for each category and mouse

#### Discription of quantification process

Cell images are quantified in batches after file names are anonymized. The number of MLH1 foci, number of "achiasmate" and asynasped bivalents are quantified. A quality score is given; 1 to 5 (best to worst).

```{r organizing.data, echo=FALSE}
#set the order of another column, based on another variable (so that when)

MLH1_data <- MLH1_data %>%
  arrange(strain, sex, category, mouse) %>%
  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match

MLH1_data <- with(MLH1_data, MLH1_data[order(sex, strain),])

# sort your dataframe, by the focal categories
MLH1_data$mouse <- factor(MLH1_data$mouse, levels=unique(MLH1_data$mouse))
#use the above line for when order is out of wak


#count the non-quality measures,  #remove non qualit
#length(MLH1_data[ !(is.na(MLH1_data$quality) | MLH1_data$quality==""), ] )  #15 rows with out quality scores, remove.
#MLH1_data <- MLH1_data[ !(is.na(MLH1_data$quality) | MLH1_data$quality==""), ]

#MLH1_by_F_strain <- MLH1_data[MLH1_data$sex == "female", ]
#MLH1_by_M_strain <- MLH1_data[MLH1_data$sex == "male", ]

#MLH1_data <- MLH1_data %>%
#  arrange(category) %>%
#  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match

#MLH1_data <- with(MLH1_data, MLH1_data[order(category),])

```



```{r missing.mice, echo=FALSE}

setwd("C:/Users/alpeterson7/Documents/MLH1repo/")
setwd("~./MLH1repo/")
#other lists

Image_dirs <- list.files(path = "C:/Users/alpeterson7/Documents/Images")
#write this out so that I can access it

#remove the non-mouse folders
Dissection.File = read.csv("~./MLH1repo/data/Disections_53019.csv", header = TRUE)
Dissection.File <- Dissection.File[!(is.na(Dissection.File$mouse)|Dissection.File$mouse==""),]

#print the name with the date of the file somewhere
Dissection.list <- Dissection.File$mouse
Dissection.list <- as.character(Dissection.list)

#load metadata .. start decerning which mice are missing information... and which should be used
Meta.Data.File = read.csv("~./MLH1repo/data/ALP_MouseMetadata.csv", header = TRUE)

#remove file name, and original name .. this is just a mouse level DF
Meta.Data.File <- Meta.Data.File[!(is.na(Meta.Data.File$mouse)|Meta.Data.File$mouse==""),]
#make sure that the DOB is a date


meta.data.file2 = read.csv("~./MLH1repo/data/MouseMetaData61019.csv", header = TRUE)
meta.data.file2$DOB <- as.Date(meta.data.file2$DOB, format= "%m/%d/%y")


jl <- unique(Meta.Data.File$mouse[(Meta.Data.File$mouse %in% Dissection.File$mouse)])
BD.w.meta <- Meta.Data.File[(Meta.Data.File$mouse %in% Dissection.File$mouse), ]


#figure out a way to incorporate the staining... to get a better idea of which slides 
#to do next, #remove the pero mice?

#length(unique(MLH1_data$mouse) )

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
original_DF$fileName <- (original_DF$Original.Name)
original_DF <- add_mouse(original_DF)
#length(unique(original_DF$mouse) )
#131 mice have been quant total, 124 mice have passed into the final version

# make a list for the failed slides

#Dissection.list - Image/dirs
NonImaged.mice <- unique(Dissection.File$mouse[(Dissection.File$mouse %in% Image_dirs)])
#231 mice dissected which need images

#ImageFolder - MLH1.Quant
NonQuant.mice <- unique(Image_dirs[(Image_dirs %in% MLH1_data$mouse )])
#length(NonQuant.mice)
#123 mice that need to get into anon-batch


#make Dataframe to put into a table
mouse.number.DF <- data.frame( category = 
              c("Passed Quantified", "Total Quantified", "Non-Quantified", "Non-Imaged"),
              number.of.mice = c(length(unique(MLH1_data$mouse)),
                length(unique(original_DF$mouse) ),
                        length(NonQuant.mice),
                         length(NonImaged.mice)  )  )

kable(mouse.number.DF)
```


This is the number of mice that are through different parts of the pathway or quantification process.



```{r basic.numbers, echo=FALSE}

kable(table(AP_mouse_table$category), col.names = c("Category", "mice"), label = "Number of mice by category" )


kable(table(MLH1_data$category), col.names = c("Category","Cells"), label = "Number of Cells by category" )

```




These are the tables for the number of cells and mice which have been quantified.
The 'Other' are F1 crosses.





#### Initial Patterns from MLH1 distributions

```{r first.boxplots, echo=FALSE, fig.align='center'}
#what?
#MLH1_data <- MLH1_data[MLH1_data$strain]

#the below ordering works!! keep it
MLH1_data$strain<- factor(MLH1_data$strain, levels =c("G", "LEW","WSB",
              "PWD","MSM","MOLF","CZECH","SKIVE",
              "KAZ","TOM","AST",
              "CAST","HMI","SPRET","SPIC", "other"), order=T )
#order the data frame
MLH1_data <- with(MLH1_data, MLH1_data[order(sex, strain),])

#don't know why this won't do the right order...
#set the order of another column, based on another variable (so that when)

#try to make sure sacles are the same

#reduncant
#MLH1_data <- MLH1_data %>%
 # arrange(strain, sex, mouse) %>%
#  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match
# sort your dataframe, by the focal categories
#MLH1_data$mouse <- factor(MLH1_data$mouse, levels=unique(MLH1_data$mouse))

#try this for ordering
#MLH1_data[order(MLH1_data$strain), ]

#can't re-order the miceagg
ff <- ggplot(MLH1_data[order(MLH1_data$strain), ], 
             aes(x = as.factor(mouse), y = adj_nMLH1.foci, fill= strain ))+geom_boxplot()+ ggtitle("Boxplots of MLH1 distributions by mouse") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue", "coral4","coral1", "#E69F00","red", "yellowgreen", "green","purple","grey1", "grey", 
        "grey","grey","grey",  "grey","grey","grey" )) +
 ylim( c((min(MLH1_data$adj_nMLH1.foci)-3) ), (max(MLH1_data$adj_nMLH1.foci)+5)) + facet_wrap(~ sex, scales="free")

#boxplots by strain
ss <- ggplot(MLH1_data, aes(x = as.factor(strain), y = adj_nMLH1.foci, fill= strain )) + geom_boxplot()  + ggtitle("Boxplots of MLH1 distributions by strain") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue",  "coral1", "#E69F00","red", "yellowgreen", "green", "purple","grey1","grey" )) +
  ylim( c( (min(MLH1_data$adj_nMLH1.foci)-3), (max(MLH1_data$adj_nMLH1.foci)+5)) )

ss <- ss   + facet_wrap(~ sex, scales="free")

ff
ss
```




### Distributions of MLH1 counts



```{r, histogram, echo=FALSE, fig.caption= "histograms", warning=FALSE, fig.align='center'}
#consider making distribution with quality considered...

histM <- ggplot(MLH1_data,(aes(adj_nMLH1.foci))) + xlim(c(16, 38))
histM <- histM + geom_histogram(stat = "bin", binwidth = 1)
histM <- histM + facet_wrap(~ category)
histM
```



### Histograms of Mouse Ages



```{r age.hists, echo=FALSE}
#meta.data.file2 = read.csv("~./MLH1repo/data/MouseMetaData61119.csv", header = TRUE)
meta.data.file2 = read.csv("~./MLH1repo/data/Mouse_MetaData_6.12.19.csv", header = TRUE)
meta.data.file2 <- meta.data.file2[!(is.na(meta.data.file2$mouse)|meta.data.file2$mouse==""),] #375

meta.data.file2$DOB <- as.Date(meta.data.file2$DOB, format= "%m/%d/%Y")#%Y 2000, %y '18,

#make Mouse meta data work
MouseMetaData.wrkin <- meta.data.file2[,c(1,4)]
colnames(MouseMetaData.wrkin) <- c("mouse", "DOB")
MouseMetaData.wrkin <- MouseMetaData.wrkin[!(is.na(MouseMetaData.wrkin$mouse)|MouseMetaData.wrkin$mouse==""),]

#do this for the mouse table instead of the MLH1 table
MLH1.imprv <- merge(MLH1_data, MouseMetaData.wrkin)#don't apply the all parameters

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
MLH1.imprv <- add_euth_date(MLH1.imprv)
#
MLH1.imprv$euth.date2 <- MLH1.imprv$euth.date
MLH1.imprv$euth.date <- as.Date(as.character(MLH1.imprv$euth.date2), format='%d%b%y')

MLH1.imprv <- add_age(MLH1.imprv)

#remove mice that are older than 20 weeks
MLH1.imprv.male <- MLH1.imprv[MLH1.imprv$sex == "male", ]
MLH1.imprv.male <- MLH1.imprv.male[MLH1.imprv.male$age.weeks < 20, ]

pp <- ggplot(MLH1.imprv.male, aes(age.weeks))+geom_histogram()+facet_wrap(~category)+ggtitle("Age Distributions")
pp


#what is this meta.data.file?
#meta.data.file2 <- add_strain(meta.data.file2)
#meta.data.file2 <- add_sex(meta.data.file2)
#meta.data.file2 <- add_category(meta.data.file2)
#meta.data.file2 <- add_euth_date(meta.data.file2)
#meta.data.file2 <- add_age(meta.data.file2)

#qq <- ggplot(meta.data.file2[meta.data.file2$sex == "male",], aes(age.weeks))+geom_histogram()+facet_wrap(~category)+ggtitle("recorded ages of dissected mice")
#qq

```



#### Assesment of Quality Scores



```{r high qual, fig.caption="boxplots of MLH1 distributions", fig.height=5, fig.width=5, echo=FALSE, warnings=FALSE, include=FALSE}

#MLH1_data$quality <- as.numeric(MLH1_data$quality) #this needs to be run for the subsetting to work
highest_qual_df <-  subset(MLH1_data, as.numeric(MLH1_data$quality) <= 2 )

#are there no KAZ cells of high quality?
qq <- ggplot(highest_qual_df, aes(x = mouse, y = adj_nMLH1.foci)) + geom_boxplot(data = highest_qual_df, aes(fill = factor(strain) ) ) +  ggtitle("Cells with quality scores of 2 or 1") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue",  "coral1", "#E69F00", "red","yellowgreen", "green","purple", "black", "grey" ))
high_qual_boxplot <- qq + facet_wrap(~ sex, scales="free") #this is breaking the kniting... 
```




```{r, passing mice, echo=FALSE}
q_cutoff_table <- ddply(MLH1_data, .(mouse), summarise,
                        total =  length(adj_nMLH1.foci),
                        q5 = sum(as.numeric(quality) >= 4, na.rm = TRUE ), 
                        above5 = sum(as.numeric(quality) <= 4, na.rm = TRUE )
                       # q_l3 = sum(as.numeric(as.numeric(quality)) <= 4, na.rm = TRUE )
)
#q_cutoff_table
passed_mice <- as.vector(q_cutoff_table[q_cutoff_table$above5 > 15,]$mouse)

not_passed <- as.vector(unique(MLH1_data[!(unique(MLH1_data$mouse) %in% passed_mice),]$mouse) )

#mnake dataframe with just passing mice -- so that it can be ploted
passed_mice_df <- MLH1_data[ (as.numeric(MLH1_data$quality) < 5), ]
```



#### Comparison of MLH1 distributions


```{r,  show boxplots, fig.height=5, fig.width=8, echo=FALSE}
high_qual_boxplot
#not sure why order got messed up again...
```

After taking the data from 2 highest cell quality, some but not all mouse means converge. For some mice (mostly female) the majority of cells are excluded. This is especially true for PWD and WSB females.


#### Tests for quality and nMLH1 foci number

> *How do the distributions change across different quality scores?*

> *How do the distributions change across mice with a good number of cells?*


##### Effects of quality

Human quantification seems to be biased towards rating cells with more MLH1 foci as higher quality. Unbiased cell quality assignment, would not show a positive correlation with quality and nMLH1. (CAST female data is fake)

```{r, scatter plots of nMLH1 by score, echo=FALSE, fig.cap="MLH1 means across quality scores"}
#make lattice / plots seperated by strain and sex
#facet

#quality scores are now 1:7?
qual_means <- MLH1_data %>% 
        group_by(category, quality) %>% 
        summarise(
          adj_nMLH1.foci = mean(adj_nMLH1.foci)
        )

p <- ggplot(MLH1_data,(aes(adj_nMLH1.foci,quality)))
p <- p + geom_point(stat = "identity")
p <- p  + geom_point(data = qual_means, colour="red") 
p <- p + facet_wrap(~ category)
p

```

I ploted the mean of each quality bin with a red dot. From the pattern of the red dots, there is definately a negative relationship with quality and nMLH1 foci across the data. This is most pronounced in MSM males and least pronounced in G males. The CAST female data is dummy data.


#### Assessing the Distributions by mouse

latice plot of scatter plots for jitter plots of cell oberservations by quality. The category mean is in black and the mouse specific mean is in red.

```{r, echo=FALSE, message=FALSE, results='hide', warning=TRUE}
### to integrate 'pass'/fail
### this should be in setup data

#quant_status (this isn't saving)
#for(i in 1:length(MLH1_data$mouse)){
#  MLH1_data$quant_status[i] <- ifelse( is.element(MLH1_data$mouse[i], pass_mice), "pass", NA)
#}


#what is the purpose of this block
#df_list <- split(MLH1_data, (MLH1_data$category))
#remove sections which are in category but have no data
#df_list <- df_list[ -c(7,16,22) ]

#7: PERC male, (14:CAST female, fake data) 16:HMI female, 22 other
#

#df list, is a list of df's which were split() from BIG df by category
#df_list 
#o=0
#i=0

#MLH1_data$quant_status <- as.factor(MLH1_data$quant_status)

#make a new empty df. create a ddply thing with mean calculations (this is like a list for matching up later)
#for(i in 1:(length(df_list))){
 # only include data with quality values, then create a ddply for specific sub-df that calqs mean by each mouse
#  df_list[[i]] <- df_list[[i]][!(is.na(df_list[[i]]$quality) | df_list[[i]]$quality==""), ]
#  sub_mouse_means <- ddply(df_list[[i]], .(mouse), summarise,
 #                      mouse_nMLH1 = mean(adj_nMLH1.foci)
#  )
# this loop is going though each row of dataframes within the df.list and assigning the mouse mean
#  for(o in 1:length(df_list[[i]]$Original.Name)){
#    df_list[[i]]$mouse_mean_MLH1[o] <- sub_mouse_means$mouse_nMLH1[ (df_list[[i]]$mouse[o] == #sub_mouse_means$mouse) ]
#        }
#}


#plot_list = list()
#for (h in 1:length(df_list)) {
#  pf <- ggplot(data = df_list[[h]], aes(colour = factor(Batch)), width = 0.25)+ #geom_jitter(aes(y= adj_nMLH1.foci, x= quality))
  # +   geom_rect(data = df_list[[h]], aes(fill=as.factor(quant_status)), alpha=0.5)
#  + facet_wrap(~ mouse) + geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") +scale_fill_manual(values=c(NA, "red"), breaks=NULL)
  
# +    geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
  #theme for indiviual mice, 
  #+ theme(plot.background = element_rect(fill = "green"))
#  
#  plot_list[[h]] =   pf
#}

#orig
#plot_list = list()
#for (h in 1:length(df_list)) {
#  pf <- ggplot(df_list[[h]],(aes(y= adj_nMLH1.foci, x= quality)))
#  pf <- pf +geom_rect(data = df_list[[h]], aes(fill=quant_status), xmin=-100, xmax=100, #ymin=-100, ymax=100, alpha=0.005)

#    pf <- pf + geom_jitter(width = 0.25, aes(colour = factor(Batch)) )
#  pf <- pf + geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
#  pf <- pf + facet_wrap(~ mouse) + geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") #+ 
    
#    scale_fill_manual(values=alpha(c("red"), .005), breaks=NULL) 

    #theme for indiviual mice, 
  #+ theme(plot.background = element_rect(fill = "green"))
#  plot_list[[h]] =   pf
#}
#can't change the alpha/transparency of the red rec

#aes must be same length ---   #geom_point(stat = "identity") +
# the last one is correct....?

#so plot list is some wride dataframe, but indeces 1:12 in plot list are ggplots
```

```{r, echo=FALSE, message=FALSE,results='hide', warning=FALSE }
#geom_hline(aes(yintercept = med, group = gr), colour = 'red')
#
#for (gg in 1:length(plot_list) ){
#  show(plot_list[gg])
  #invisible(lapply(obj, function(x) plot(x,main="some plot")))
#}
```

Making all of these scatter plots, allows us to look at the whole distributions of the data for each mouse. The distance of the red line from the black could be a indicator of slides or mice with slide specific technical noise.

PWD females and a very large range. This is driven by data from 17apr15_PWD_f4. These data should be looked at more closely.

In some mice there seems to be bimodel cell populations, those of clearly high quality and those of lower quality. This may be due to the screening of images before quantification, and allowing more bad cells data remain in the data set, instead of deleting them.


#### Mice table

Table of the mice used and MLH1 stats.

```{r, fig.height=2, fig.width=4, echo=FALSE}
#this table is TOO big
#this table is saved in the .RData file
#use kable to make tables. warning this might not work for github Rmd.
n <- kable(AP_mouse_table)

```



