---
title: "MLH1 Data Report"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
    toc_float: yes
  pdf_document: default
---

```{r setup, echo=FALSE, include = FALSE}
library(knitr)
library(ggplot2)
#library(pwr)
library(plyr)
library(lattice)
library(dplyr)
setwd("C:/Users/alpeterson7/Documents/MLH1repo/")
#setwd("C:/Users/April/Desktop/MLH1repo")
#load(file="data/MLH1/MLH1_data_setup.RData")

#load main data file
load(file="data/MLH1/MLH1_data_setup_8.29.19.RData")

#load(file="data/MetaData.RData") #this was replacing most updated data file

#load functions
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
```

# Research Description

Measure nMLH1 foci per meiotic cell to estimate recombination rate for diverse strains of house mice and related rodents. Comparison the differences in recombination rates across sexes and genetic background to inform models of how meiotic recombination rates evolve. 

## Description of Report

- Show basics of the current data file

- Display plots and figures of distributions of MLH1 counts to assess initial overall patterns.

-  Report basic statistics of results and to help keep track of the number of images for each category and mouse.


## Discription of quantification process

Cell images are quantified in batches after file names are anonymized. The number of MLH1 foci, number of "achiasmate" and asynasped bivalents are quantified. A quality score is given; 1 to 5 (best to worst).

all cell image file names are anonymized and moved into batches of a few hundred images.



```{r organizing.data, echo=FALSE}
#set the order of another column, based on another variable (so that when)

MLH1_data <- MLH1_data %>%
  arrange(strain, sex, category, mouse) %>%
  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match

MLH1_data <- with(MLH1_data, MLH1_data[order(sex, strain),])

# sort your dataframe, by the focal categories
MLH1_data$mouse <- factor(MLH1_data$mouse, levels=unique(MLH1_data$mouse))
#use the above line for when order is out of wak


#count the non-quality measures,  #remove non qualit
#length(MLH1_data[ !(is.na(MLH1_data$quality) | MLH1_data$quality==""), ] )  #15 rows with out quality scores, remove.
#MLH1_data <- MLH1_data[ !(is.na(MLH1_data$quality) | MLH1_data$quality==""), ]

#MLH1_by_F_strain <- MLH1_data[MLH1_data$sex == "female", ]
#MLH1_by_M_strain <- MLH1_data[MLH1_data$sex == "male", ]

#MLH1_data <- MLH1_data %>%
#  arrange(category) %>%
#  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match

#MLH1_data <- with(MLH1_data, MLH1_data[order(category),])

```




## Missing Mice, finishing dataset

*Which mice are remaining and at what stage?*

This section shows the number of mice which haven't been stained or quantified yet.


```{r missing.mice, echo=FALSE}

setwd("C:/Users/alpeterson7/Documents/MLH1repo/")
setwd("~./MLH1repo/")
#other lists

Image_dirs <- list.files(path = "C:/Users/alpeterson7/Documents/Images")
#write this out so that I can access it

#remove the non-mouse folders
Dissection.File = read.csv("~./MLH1repo/data/Disections_53019.csv", header = TRUE)
Dissection.File <- Dissection.File[!(is.na(Dissection.File$mouse)|Dissection.File$mouse==""),]

#print the name with the date of the file somewhere
Dissection.list <- Dissection.File$mouse
Dissection.list <- as.character(Dissection.list)

#load metadata .. start decerning which mice are missing information... and which should be used
Meta.Data.File = read.csv("~./MLH1repo/data/ALP_MouseMetadata.csv", header = TRUE)

#remove file name, and original name .. this is just a mouse level DF
Meta.Data.File <- Meta.Data.File[!(is.na(Meta.Data.File$mouse)|Meta.Data.File$mouse==""),]
#make sure that the DOB is a date


meta.data.file2 = read.csv("~./MLH1repo/data/MouseMetaData61019.csv", header = TRUE)
meta.data.file2$DOB <- as.Date(meta.data.file2$DOB, format= "%m/%d/%y")


jl <- unique(Meta.Data.File$mouse[(Meta.Data.File$mouse %in% Dissection.File$mouse)])
BD.w.meta <- Meta.Data.File[(Meta.Data.File$mouse %in% Dissection.File$mouse), ]


#figure out a way to incorporate the staining... to get a better idea of which slides 
#to do next, #remove the pero mice?

#length(unique(MLH1_data$mouse) )

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
original_DF$fileName <- (original_DF$Original.Name)
original_DF <- add_mouse(original_DF)
#length(unique(original_DF$mouse) )
#131 mice have been quant total, 124 mice have passed into the final version

# make a list for the failed slides

#Dissection.list - Image/dirs
NonImaged.mice <- unique(Dissection.File$mouse[(Dissection.File$mouse %in% Image_dirs)])
#231 mice dissected which need images

#ImageFolder - MLH1.Quant
NonQuant.mice <- unique(Image_dirs[(Image_dirs %in% MLH1_data$mouse )])
#length(NonQuant.mice)
#123 mice that need to get into anon-batch


#make Dataframe to put into a table
mouse.number.DF <- data.frame( category = 
              c("Passed Quantified", "Total Quantified", "Non-Quantified", "Non-Imaged"),
              number.of.mice = c(length(unique(MLH1_data$mouse)),
                length(unique(original_DF$mouse) ),
                        length(NonQuant.mice),
                         length(NonImaged.mice)  )  )

kable(mouse.number.DF)
```


passed quantified - quantified mice (with enough cells)
total quantified -- all mice which have been (includes fail and passing mice)

non-quantified mice -- dissected mice / slides that haven't been quantified yet (all stained, but without image directory)

non-imaged -- mice without images, (might be stained and unstained)


This is the number of mice that are through different parts of the pathway or quantification process.


should I break down the categories into sex and strain?


```{r basic.numbers, echo=FALSE, eval=FALSE}

kable(table(AP_mouse_table$category), col.names = c("Category", "mice"), label = "Number of mice by category" )


kable(table(MLH1_data$category), col.names = c("Category","Cells"), label = "Number of Cells by category" )

```


These are the tables for the number of cells and mice which have been quantified.
The 'Other' are F1 crosses.


## Repeatability of Human quantification

*What is the Error in quantification across humans?*

A general anecdote is that if the quality of the cell staining / image is high, then the repeatability is near 100%. (using some of Beth's data). There is a subset of data which has been counted multiple times -- use that to test the repeatbility.

```{r quant.repeatability, echo=FALSE}

```




## Effects on the dataset

Main metric is mean CO count per mouse. Run tests to check if there are effects for the following effects.

*age effects* (male, maternal age)

*litter effect*

*mouse room effect* (Charmony, MSC)

*quantification repeatability*

*spread batch and staining effects*

*power analysis on number of cells*

*time of year effect (on spread)*

These aspects will be analyzed with a linear models on subsets of data (within category) and visualized with plots.


### Quality effect

there is a positive correlation with MLH1 number and quality
To test this effect, compare all of the counts from quality-1 cells across strains. check that the same patterns of means persist compared to the total-cell data.

### Age Effect

Some papers have documented age effects for male genome-wide recombination rate (cite).

The initial analysis uses plots. This should be double checked with a general linear model as well.


```{r age.hists, echo=FALSE, eval=FALSE,  warning=FALSE}
meta.data$DOB <- as.Date(meta.data$DOB, format= "%m/%d/%Y")#%Y 2000, %y '18,

#make Mouse meta data work
MouseMetaData.wrkin <- meta.data[,c(1,4)]
colnames(MouseMetaData.wrkin) <- c("mouse", "DOB")

MouseMetaData.wrkin <- MouseMetaData.wrkin[!(is.na(MouseMetaData.wrkin$mouse)|MouseMetaData.wrkin$mouse==""),]

#do this for the mouse table instead of the MLH1 table
MLH1.imprv <- merge(MLH1_data, MouseMetaData.wrkin)#don't apply the all parameters

#add euth date for calculating age

MLH1.imprv <- add_euth_date(MLH1.imprv)
#
MLH1.imprv$euth.date2 <- MLH1.imprv$euth.date
MLH1.imprv$euth.date <- as.Date(as.character(MLH1.imprv$euth.date2), format='%d%b%y')
#this is currently broken
MLH1.imprv <- add_age(MLH1.imprv)

#remove mice that are older than 20 weeks
MLH1.imprv.male <- MLH1.imprv[MLH1.imprv$sex == "male", ]
MLH1.imprv.male <- MLH1.imprv.male[MLH1.imprv.male$age.weeks < 20, ]

pp <- ggplot(MLH1.imprv.male, aes(age.weeks))+geom_histogram()+facet_wrap(~category)+ggtitle("Age Distributions")
pp


#what is this meta.data.file?
#meta.data.file2 <- add_strain(meta.data.file2)
#meta.data.file2 <- add_sex(meta.data.file2)
#meta.data.file2 <- add_category(meta.data.file2)
#meta.data.file2 <- add_euth_date(meta.data.file2)
#meta.data.file2 <- add_age(meta.data.file2)

#qq <- ggplot(meta.data.file2[meta.data.file2$sex == "male",], aes(age.weeks))+geom_histogram()+facet_wrap(~category)+ggtitle("recorded ages of dissected mice")
#qq

```


Make a subsetted dataset for plotting mean mouse (quality < 5) MLH1 count and age.

```{r age.effect.model, include=FALSE}
#run a age effect linear regression!

male.data <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$sex.y == "male",]

lm.me  <- lm(male.data$mean_co ~ male.data$age.weeks+male.data$strain.x)

#summary(lm.me)
```



```{r age.effect.plot, warning=FALSE, echo=FALSE}

#make sure the right dataset 
male.data <- AP_mouse_table_w.Ages[(AP_mouse_table_w.Ages$sex.y == "male") & (AP_mouse_table_w.Ages$category.y != "other"),]
#remove NAs

male.data <- male.data[male.data$Ncells > 10,]

age.effect.plot <- ggplot(male.data, aes(y=mean_co, x=age.weeks, color=strain.y))+geom_point()+ ylim(c(19,34))+
  geom_smooth(method='lm',alpha=0.1, size=0, span=0.5 )+ggtitle("Age and mean CO per mouse")+facet_wrap(~subsp.y)
age.effect.plot
#todo add line to strain.y

```


While many slopes are different than 0, I am not convinced there is a clear age effect. Most strains don't have more than 2 ages. I will double check some of these mice and check a general linear model.


### Maternal Age effect

Check if there is a maternal age effect for females and males.

```{r mat.age.effect, echo=FALSE}
#compile data from female (and male?) mice with maternal ages.

#start making a general linear model...? for mouse averages


```


### Litter effect

Compare female spreads made on the same day, but from different mothers/litters.


### Spread and Stain Effects


> *month dissected*

For mice strains that have a similar MLH1 level (control for strain MLH1 effect), check if a month effect for MLH1 count (as seen in Peromyscus).

> *staining batches*

Compare observations from the same mouse, but different MLH1 stains.


### Room effect (envioronment)


3 different rooms used to house mice. This will be tested in X manner.


### Cell number (power analysis results)

Insert the code and results for effects of cell number/observations on MLH1 means.



# Initial Results

```{r first.boxplots, echo=FALSE, fig.align='center'}


#the below ordering works!! keep it
MLH1_data$strain<- factor(MLH1_data$strain, levels =c("G", "LEW","WSB",
              "PWD","MSM","MOLF","CZECH","SKIVE",
              "KAZ","TOM","AST",
              "CAST","HMI","SPRET","SPIC", "other"), order=T )
#order the data frame
MLH1_data <- with(MLH1_data, MLH1_data[order(sex, strain),])

#don't know why this won't do the right order...
#set the order of another column, based on another variable (so that when)

#try to make sure sacles are the same

#reduncant
#MLH1_data <- MLH1_data %>%
 # arrange(strain, sex, mouse) %>%
#  mutate(Original.Name = factor(Original.Name)) #another category that you want the order to match
# sort your dataframe, by the focal categories
#MLH1_data$mouse <- factor(MLH1_data$mouse, levels=unique(MLH1_data$mouse))

#try this for ordering
#MLH1_data[order(MLH1_data$strain), ]

#never make boxplot with mouse on X. mouse level boxplots should be faceted by subspecies 
#can't re-order the miceagg
#ff <- ggplot(MLH1_data[order(MLH1_data$strain), ], 
#             aes(x = as.factor(mouse), y = adj_nMLH1.foci, fill= strain ))+geom_boxplot()+ ggtitle("Boxplots of MLH1 distributions by mouse") + theme(axis.title.x=element_blank(),
#        axis.text.x=element_blank(),
#        axis.ticks.x=element_blank()) +scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue", #"coral4","coral1", "#E69F00","red", "red4", "red3","purple","grey1", "grey", 
#        "grey","grey","grey",  "grey","grey","grey" )) +
# ylim( c((min(MLH1_data$adj_nMLH1.foci)-3) ), (max(MLH1_data$adj_nMLH1.foci)+5)) + facet_wrap(species~ sex, scales="free")
#don't show M.musculus by mouse

#order MLH1_data by strain!!


ff2 <- ggplot(MLH1_data[MLH1_data$species == "M.musculus", ])+
  geom_boxplot(aes(x = as.character(mouse), y = adj_nMLH1.foci, fill= strain,alpha=0.5) )+ ggtitle("Boxplots of MLH1 distributions by mouse") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue", "coral4","coral1", "#E69F00","red", "red3", "red4","orange","yellow", "yellow3", 
        "green","green4","grey",  "grey","grey","grey" )) +
 ylim( c((min(MLH1_data$adj_nMLH1.foci)-3) ), (max(MLH1_data$adj_nMLH1.foci)+3)) + 
  facet_grid(subsp~ sex, scales="free_x")#scales="free_y"
#this is ok except for the set placement of mice on x axis
#if the full dataset was ordered correctly, this would kinda fix it


#boxplots by strain
ss <- ggplot(MLH1_data, aes(x = as.factor(strain), y = adj_nMLH1.foci, fill= strain )) + geom_boxplot(aes(alpha=0.5))  + ggtitle("Boxplots of MLH1 distributions by strain") + theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue",  "coral1", "#E69F00","red", "yellowgreen", "green", "purple","grey1","grey","green", "purple","grey1","grey","white", "blue","orange" )) +
  ylim( c( (min(MLH1_data$adj_nMLH1.foci)-3), (max(MLH1_data$adj_nMLH1.foci)+5)) )

ss <- ss   + facet_wrap(~ sex, scales="free")

#these plot currently look bad
ss
```


*What is the initial picture of Heterochiasmy across mouse strains?*

For the strain level plots
  -facet,sex by species

```{r HetC.rates, echo=FALSE, include=FALSE, warning=FALSE}
#calculate the initial HetC levels from best quality mice and cells (compare both levels (cell and mouse average levels))

#subset MLH1_DF, remove non passing mice (as diagnoised from plots)
#remove quality 5 cells

#outgroups
#SPIC
HetC.SPIC <- MLH1_data[(MLH1_data$strain == "SPIC")&(MLH1_data$quality < 5),]
#unique(HetC.SPIC$mouse)
#non-passing mice
SPIC.remove.mice <- c("30may18_SPIC_f1", "8jun18_SPIC_m2")
HetC.SPIC <- HetC.SPIC[ ! HetC.SPIC$mouse %in% SPIC.remove.mice, ]
#calq sex mean
SPIC.mean.MLH1.obs <- ddply(.data=HetC.SPIC, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
SPIC.HETC.val <- SPIC.mean.MLH1.obs$mean.MLH1[1] / SPIC.mean.MLH1.obs$mean.MLH1[2]

#SPRET
HetC.SPRET <- MLH1_data[(MLH1_data$strain == "SPRET")&(MLH1_data$quality < 5),]
#unique(HetC.SPRET$mouse)
#non-passing mice
#SPRET.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
SPRET.mean.MLH1.obs <- ddply(.data=HetC.SPRET, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

SPRET.HETC.val <- SPRET.mean.MLH1.obs$mean.MLH1[1] / SPRET.mean.MLH1.obs$mean.MLH1[2]

#CAROLI
HetC.CAROLI <- MLH1_data[(MLH1_data$strain == "CAROLI")&(MLH1_data$quality < 5),]
#unique(HetC.CAROLI$mouse)
#non-passing mice
#SPRET.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
CAROLI.mean.MLH1.obs <- ddply(.data=HetC.CAROLI, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

#cast
HetC.CAST <- MLH1_data[(MLH1_data$strain == "CAST")&(MLH1_data$quality < 5),]
#unique(HetC.CAST$mouse)
#non-passing mice
#X.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
CAST.mean.MLH1.obs <- ddply(.data=HetC.CAST, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
CAST.HETC.val <- CAST.mean.MLH1.obs$mean.MLH1[1] / CAST.mean.MLH1.obs$mean.MLH1[2]

#HMI
HetC.HMI <- MLH1_data[(MLH1_data$strain == "HMI")&(MLH1_data$quality < 5),]
#unique(HetC.HMI$mouse)
#non-passing mice
#X.remove.mice <- c("", "")
#HetC.SPRET <- HetC.SPRET[ ! HetC.SPRET$mouse %in% SPRET.remove.mice, ]
#calq sex mean
HMI.mean.MLH1.obs <- ddply(.data=HetC.HMI, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

#dom

#WSB
HetC.WSB <- MLH1_data[(MLH1_data$strain == "WSB")&(MLH1_data$quality < 5),]
#unique(HetC.WSB$mouse)
#non-passing mice
WSB.remove.mice <- c("8oct14_WSB_f1", "18nov17_WSB_f5", "16jun15_WSB_f3","10mar15_WSB_m2")
HetC.WSB <- HetC.WSB[ ! HetC.WSB$mouse %in% WSB.remove.mice, ]
#calq sex mean
WSB.mean.MLH1.obs <- ddply(.data=HetC.WSB, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

WSB.HETC.val <- WSB.mean.MLH1.obs$mean.MLH1[1] / WSB.mean.MLH1.obs$mean.MLH1[2]


#LEW
HetC.LEW <- MLH1_data[(MLH1_data$strain == "LEW")&(MLH1_data$quality < 5),]
unique(HetC.LEW$mouse)
#non-passing mice
LEW.remove.mice <- c("4jan17_LEW_f2")
HetC.LEW <- HetC.WSB[ ! HetC.LEW$mouse %in% LEW.remove.mice, ]

#calq sex mean
LEW.mean.MLH1.obs <- ddply(.data=HetC.LEW, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

LEW.HETC.val <- LEW.mean.MLH1.obs$mean.MLH1[1] / LEW.mean.MLH1.obs$mean.MLH1[2]


#G
HetC.G <- MLH1_data[(MLH1_data$strain == "G")&(MLH1_data$quality < 5),]
#unique(HetC.G$mouse)
#non-passing mice
G.remove.mice <- c("8jun15_G_f3","8jun15_G_f4")
HetC.G <- HetC.G[ ! HetC.G$mouse %in% G.remove.mice, ]

#calq sex mean
G.mean.MLH1.obs <- ddply(.data=HetC.G, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
G.HETC.val <- G.mean.MLH1.obs$mean.MLH1[1] / G.mean.MLH1.obs$mean.MLH1[2]


#PERC
HetC.PERC <- MLH1_data[(MLH1_data$strain == "PERC")&(MLH1_data$quality < 5),]
#unique(HetC.PERC$mouse)
#non-passing mice
#G.remove.mice <- c("8jun15_G_f3","8jun15_G_f4")
#HetC.G <- HetC.PERC[ ! HetC.PERC$mouse %in% PERC.remove.mice, ]

#calq sex mean
PERC.mean.MLH1.obs <- ddply(.data=HetC.PERC, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
G.HETC.val <- G.mean.MLH1.obs$mean.MLH1[1] / G.mean.MLH1.obs$mean.MLH1[2]

#MUSC

#PWD
HetC.PWD <- MLH1_data[(MLH1_data$strain == "PWD")&(MLH1_data$quality < 5),]
#unique(HetC.PWD$mouse)
#non-passing mice
PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
PWD.mean.MLH1.obs <- ddply(.data=HetC.PWD, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
PWD.HETC.val <- PWD.mean.MLH1.obs$mean.MLH1[1] / PWD.mean.MLH1.obs$mean.MLH1[2]

# CZECH
HetC.CZECH <- MLH1_data[(MLH1_data$strain == "CZECH")&(MLH1_data$quality < 5),]
#unique(HetC.CZECH$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
CZECH.mean.MLH1.obs <- ddply(.data=HetC.CZECH, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

CZECH.HETC.val <- CZECH.mean.MLH1.obs$mean.MLH1[1] / CZECH.mean.MLH1.obs$mean.MLH1[2]


# SKIVE
HetC.SKIVE <- MLH1_data[(MLH1_data$strain == "SKIVE")&(MLH1_data$quality < 5),]
#unique(HetC.SKIVE$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
SKIVE.mean.MLH1.obs <- ddply(.data=HetC.SKIVE, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

SKIVE.HETC.val <- SKIVE.mean.MLH1.obs$mean.MLH1[1] / SKIVE.mean.MLH1.obs$mean.MLH1[2]



# KAZ
HetC.KAZ <- MLH1_data[(MLH1_data$strain == "KAZ")&(MLH1_data$quality < 5),]
#unique(HetC.KAZ$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
KAZ.mean.MLH1.obs <- ddply(.data=HetC.KAZ, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
KAZ.HETC.val <- KAZ.mean.MLH1.obs$mean.MLH1[1] / KAZ.mean.MLH1.obs$mean.MLH1[2]


#TOM
HetC.TOM <- MLH1_data[(MLH1_data$strain == "TOM")&(MLH1_data$quality < 5),]
#unique(HetC.TOM$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
TOM.mean.MLH1.obs <- ddply(.data=HetC.TOM, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
TOM.HETC.val <- TOM.mean.MLH1.obs$mean.MLH1[1] / TOM.mean.MLH1.obs$mean.MLH1[2]



#AST
HetC.AST <- MLH1_data[(MLH1_data$strain == "AST")&(MLH1_data$quality < 5),]
#unique(HetC.AST$mouse)

#non-passing mice
#PWD.remove.mice <- c("1apr15_PWD_f2","8oct14_PWD_f2","8oct14_PWD_f5")
#HetC.PWD <- HetC.PWD[ ! HetC.PWD$mouse %in% PWD.remove.mice, ]

#calq sex mean
AST.mean.MLH1.obs <- ddply(.data=HetC.AST, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)
AST.HETC.val <- AST.mean.MLH1.obs$mean.MLH1[1] / AST.mean.MLH1.obs$mean.MLH1[2]


#Molosinus

#MSM
HetC.MSM <- MLH1_data[(MLH1_data$strain == "MSM")&(MLH1_data$quality < 5),]
unique(HetC.MSM$mouse)

#non-passing mice
MSM.remove.mice <- c("12sep16_MSM_f3")
HetC.MSM <- HetC.MSM[ ! HetC.MSM$mouse %in% MSM.remove.mice, ]

#calq sex mean
MSM.mean.MLH1.obs <- ddply(.data=HetC.MSM, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

MSM.HETC.val <- MSM.mean.MLH1.obs$mean.MLH1[1] / MSM.mean.MLH1.obs$mean.MLH1[2]


#MOLF
HetC.MOLF <- MLH1_data[(MLH1_data$strain == "MOLF")&(MLH1_data$quality < 5),]
unique(HetC.MOLF$mouse)

#non-passing mice
MOLF.remove.mice <- c("27oct18_MOLF_m3")
HetC.MOLF <- HetC.MOLF[ ! HetC.MOLF$mouse %in% MOLF.remove.mice, ]

#calq sex mean
MOLF.mean.MLH1.obs <- ddply(.data=HetC.MOLF, 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)

MOLF.HETC.val <- MOLF.mean.MLH1.obs$mean.MLH1[1] / MOLF.mean.MLH1.obs$mean.MLH1[2]

```


> *-Which strain has highest HetC?*



```{r HetC.plot, echo=FALSE, warning=FALSE}
#HETC plot

#make scatter plot for HetC
#color by strain

#set up data
#make female male plot

HetC_strain_table.M <- ddply(MLH1_data[(MLH1_data$quality < 5)&(MLH1_data$sex == "male"),], c("strain"), summarise,
                         Nmice = length(unique(mouse)),
                         Ncells  = length(adj_nMLH1.foci),
                         mean_co = format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3),
                         var = format(round(   var(nMLH1.foci),3), nsmall=3),
                         sd   = round(sd(adj_nMLH1.foci), 3),
                         se   = round(sd / sqrt(Ncells), 3),
                         cV = round( (as.numeric(sd) / as.numeric(mean_co) ),3)
)
#
#HetC_strain_table.M <- HetC_strain_table.M[ -c(7, 4, 10,11,12, 14, 17, 18,19), ]

HetC_strain_table.F <- ddply(MLH1_data[(MLH1_data$quality < 5)&(MLH1_data$sex == "female"),], c("strain"), summarise,
                         Nmice = length(unique(mouse)),
                         Ncells  = length(adj_nMLH1.foci),
                         mean_co = format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3),
                         var = format(round(   var(nMLH1.foci),3), nsmall=3),
                         sd   = round(sd(adj_nMLH1.foci), 3),
                         se   = round(sd / sqrt(Ncells), 3),
                         cV = round( (as.numeric(sd) / as.numeric(mean_co) ),3)
)
#HetC_strain_table.F <- HetC_strain_table.F[ -c(11), ]

HetC_strain_table.M$sex <- "male"
HetC_strain_table.F$sex <- "female"

HetC_strain_table <- merge(HetC_strain_table.M, HetC_strain_table.F, by= "strain")

HetC_strain_table <- add_subsp(HetC_strain_table)

#HetC_strain_table$subsp <- c("Dom", "Dom", "Dom", "Musc", "Musc","Musc","Musc", "Cast", "Outgroup","Outgroup")

HetC_strain_table$mean_co.x <- as.numeric(HetC_strain_table$mean_co.x)
HetC_strain_table$mean_co.y <- as.numeric(HetC_strain_table$mean_co.y)
#str(HetC_strain_table)

Het.C.plot <- ggplot(data= HetC_strain_table, aes(x= mean_co.x, y=mean_co.y, color = subsp ))+ geom_point(aes(size=2)) + xlim(c(20,35)) + ylim(c(20, 35)) + geom_abline(slope = 1, intercept = 0)+labs(x="male MLH1 mean",y="female MLH1 mean")+ggtitle("Heterochiasmy Plot")+
  scale_color_manual(values=c("royalblue", "limegreen",  "tomato", "slategray2", "plum", "grey"))

#musc - coral, Dom - cadetblue (grey blue), 

Het.C.plot
#this plot is missing several 

```



3 of my Musc strains have male biased patter; SKIVE, PWD and MSM.
1 of the musc strains has female biased heterochiasmy, KAZ. 


### Distributions of MLH1 counts

> *Are the MLH1 distributions close to normal?*


```{r MLH1.histogram, echo=FALSE, fig.caption= "histograms", warning=FALSE, fig.align='center', eval=FALSE}


#gg <- data.frame(weight=rep(x,nrow(df)),df)
#gg$y <- with(gg,dnorm(x,mean,sd))
#gg$y <- gg$y * aggregate(weight~sex, weight,length)$weight * #diff(range(weight$weight))/30

mean.MLH1.obs <- ddply(.data=MLH1_data, 
                 .(category),
                 summarize, 
                 mean.MLH1 = mean(adj_nMLH1.foci),
                 var.MLH1 = var(adj_nMLH1.foci)
)


histM <- ggplot(MLH1_data,(aes(adj_nMLH1.foci))) + xlim(c(16, 38)) + geom_histogram(stat = "bin", binwidth = 1) + facet_wrap(~ category)+ggtitle("Pooled Cell Histograms")+
  geom_line(data=mean.MLH1.obs, aes(y=mean.MLH1.obs$mean.MLH1))
  
#  geom_smooth(method = lm, se = FALSE
 # geom_smooth(method = lm, formula = mean.MLH1.obs$mean.MLH1 ~ mean.MLH1.obs$category, se = FALSE)
  
histM

#function = glm(y ~ x, family = poisson)
#add Poission curve behind
#geom_smooth(method = lm, formula = y ~ splines::bs(x, 3), se = FALSE)
#not sure how to add Expected poisson curve

```


(most all distributions are close to normal)

How do these compare to Poisson? (mean == variance)
I should make 'expected' distributions behind these.


### Assesment of Quality Scores

> *How do the distributions change across different quality scores?*

> *How do the distributions change across mice with a good number of cells?*


```{r high.qual, fig.caption="boxplots of MLH1 distributions", fig.height=5, fig.width=5, echo=FALSE, warnings=FALSE, include=FALSE}

#MLH1_data$quality <- as.numeric(MLH1_data$quality) #this needs to be run for the subsetting to work
highest_qual_df <-  subset(MLH1_data, as.numeric(MLH1_data$quality) <= 2 )

#are there no KAZ cells of high quality?
qq <- ggplot(highest_qual_df, aes(x = mouse, y = adj_nMLH1.foci)) + geom_boxplot(data = highest_qual_df, aes(fill = factor(strain) ) ) +  ggtitle("Cells with quality scores of 2 or 1") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + scale_fill_manual(values=c("#56B4E9", "cadetblue", "lightblue",  "coral1", "#E69F00", "red","yellowgreen", "green","purple", "black", "grey" ))
high_qual_boxplot <- qq + facet_wrap(~ sex, scales="free") #this is breaking the kniting... 
```




```{r passing.mice, echo=FALSE, warning=FALSE}
q_cutoff_table <- ddply(MLH1_data, .(mouse), summarise,
                        total =  length(adj_nMLH1.foci),
                        q5 = sum(as.numeric(quality) >= 4, na.rm = TRUE ), 
                        above5 = sum(as.numeric(quality) <= 4, na.rm = TRUE )
                       # q_l3 = sum(as.numeric(as.numeric(quality)) <= 4, na.rm = TRUE )
)
#q_cutoff_table
passed_mice <- as.vector(q_cutoff_table[q_cutoff_table$above5 > 15,]$mouse)

not_passed <- as.vector(unique(MLH1_data[!(unique(MLH1_data$mouse) %in% passed_mice),]$mouse) )

#mnake dataframe with just passing mice -- so that it can be ploted
passed_mice_df <- MLH1_data[ (as.numeric(MLH1_data$quality) < 5), ]
```


Human quantification seems to be biased towards rating cells with more MLH1 foci as higher quality. Unbiased cell quality assignment, would not show a positive correlation with quality and nMLH1. (CAST female data is fake)




```{r scatter.plots.of.nMLH1.by.score, echo=FALSE, fig.cap="MLH1 means and quality scores", warning=FALSE}

#make lattice / plots seperated by strain and sex
#facet

#quality scores are now 1:7?
qual_means <- MLH1_data %>% 
        group_by(category, quality) %>% 
        summarise(
          adj_nMLH1.foci = mean(adj_nMLH1.foci)
        )

p <- ggplot(MLH1_data,(aes(adj_nMLH1.foci,quality)))
p <- p + geom_point(stat = "identity")
p <- p  + geom_point(data = qual_means, colour="red") 
p <- p + facet_wrap(~ category)
p

```


I plotted the mean of each quality bin with a red dot. From the pattern of the red dots, there is definitely a negative relationship with quality and nMLH1 foci across the data. This is most pronounced in MSM males and least pronounced in G males. The CAST female data is dummy data.


####Distributions by mouse

> *Is there mouse level MLH1 quality score bias?*


Below are code chunks that make a big dfs of CO count by quality score plot. The code has been commented out, and moved to it's own doc.

```{r mouse.specific.Qplot, echo=FALSE, message=FALSE, results='hide', warning=TRUE, include=FALSE, eval=FALSE}
### to integrate 'pass'/fail
### this should be in setup data

#mice that don't have female data will break the chain-loop
#MOLF female, HMI, CZECH female, CAROLI female, Tom male

#instead of adding fake data, remove the categories from list

#filler_data_MOLF.f = c("BatchX", "1jan19_fake_MOLF_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_MOLF_f1_sp1_rev.tif",
#                       "fake_MOLF_f1", "MOLF female", "MOLF","female","Musc", "20","")
#filler_data_HMI.f = c("BatchX", "1jan19_fake_HMI_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_HMI_f1_sp1_rev.tif",
#                       "fake_HMI_f1", "HMI female", "HMI","female","Cast", "20","")
#filler_data_CZECH.f = c("BatchX", "1jan19_fake_CZECH_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_CZECH_f1_sp1_rev.tif",
#                       "fake_CZECH_f1", "CZECH female", "CZECH","female","Musc", "20","")
#filler_data_CAROLI.f = c("BatchX", "1jan19_fake_CAROLI_f1_sp1", "99999", "3","20","20","","","","","","1jan19_fake_CAROLI_f1_sp1_rev.tif",
#                       "fake_CAROLI_f1", "CAROLI female", "CAROLI","female","Caroli", "20","")
#MLH1_data_table <- rbind(MLH1_data, filler_data_MOLF.f,filler_data_HMI.f,filler_data_CZECH.f,filler_data_CAROLI.f)#error from dataset thing

pass_mice <- c("28sep18_CZECH_m3","26oct18_MOLF_m1","22jun15_G_m2")


#this loop makes a quant_status col for a list of mice
for(i in 1:length(MLH1_data$mouse)){
  MLH1_data$quant_status[i] <- ifelse( is.element(MLH1_data$mouse[i], pass_mice), "pass", NA)
}


df_list <- split(MLH1_data, (MLH1_data$category))
#remove sections which are in category but have no data
#this is where you remove the non-data data!
df_list <- df_list[ -c(7,12,14,18,20,21,22,24,26,28,30) ]

#7 PERC, 12 MOLF female, 
#

#df list, is a list of df's which were split() from BIG df by category
df_list 
o=0
i=0

MLH1_data$quant_status <- as.factor(MLH1_data$quant_status)

#make a new empty df. create a ddply thing with mean calculations (this is like a list for matching up later)
for(i in 1:(length(df_list))){
 # only include data with quality values, then create a ddply for specific sub-df that calqs mean by each mouse
  df_list[[i]] <- df_list[[i]][!(is.na(df_list[[i]]$quality) | df_list[[i]]$quality==""), ]
  sub_mouse_means <- ddply(df_list[[i]], .(mouse), summarise,
                      mouse_nMLH1 = mean(adj_nMLH1.foci)
  )
# this loop is going though each row of dataframes within the df.list and assigning the mouse mean
  for(o in 1:length(df_list[[i]]$Original.Name)){
    df_list[[i]]$mouse_mean_MLH1[o] <- sub_mouse_means$mouse_nMLH1[ (df_list[[i]]$mouse[o] == sub_mouse_means$mouse) ]
        }
}


plot_list = list()
for (h in 1:length(df_list)) {
  pf <- ggplot(data = df_list[[h]], aes(colour = factor(Batch)), width = 0.25)+ 
    geom_jitter(aes(y= adj_nMLH1.foci, x= quality)) + 
    geom_rect(data = df_list[[h]], aes(fill=as.factor(quant_status)), alpha=0.5, xmin=-100, xmax=100, ymin=-100, ymax=100)+
    facet_wrap(~ mouse, drop = TRUE) + 
    geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") +scale_fill_manual(values=c(NA, "red"), breaks=NULL) +    geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
  #theme(plot.background = element_rect(fill = "green")) #theme for indiviual mice, 
  #make an empty ggplot? for missing data
  
  plot_list[[h]] =   pf
}

#orig (I think this is the same as above)
#plot_list = list()
#for (h in 1:length(df_list)) {
#  pf <- ggplot(df_list[[h]],(aes(y= adj_nMLH1.foci, x= quality)))
#  pf <- pf +geom_rect(data = df_list[[h]], aes(fill=quant_status), xmin=-100, xmax=100, ymin=-100, ymax=100, alpha=0.005)

#    pf <- pf + geom_jitter(width = 0.25, aes(colour = factor(Batch)) )
#  pf <- pf + geom_hline(yintercept = c( mean(df_list[[h]]$adj_nMLH1.foci) ), color="black" )
#  pf <- pf + facet_wrap(~ mouse) + geom_hline(aes(yintercept = mouse_mean_MLH1), color="red") + 
    
 #   scale_fill_manual(values=alpha(c("red"), .005), breaks=NULL) +

    #theme for indiviual mice, 
#theme(plot.background = element_rect(fill = "green"))
#  plot_list[[h]] =   pf
#}
#can't change the alpha/transparency of the red rec

#aes must be same length ---   #geom_point(stat = "identity") +
# the last one is correct....?

#so plot list is some wride dataframe, but indeces 1:12 in plot list are ggplots
```

```{r show.plots, echo=FALSE, message=FALSE,results='hide', warning=FALSE, include=FALSE, eval=FALSE}
geom_hline(aes(yintercept = med, group = gr), colour = 'red')
#no plot is made that goes in the list -- so it can't be shown
for (gg in 1:length(plot_list) ){
  show(plot_list[gg])
 # invisible(lapply(obj, function(x) plot(x,main="some plot")))
}

#this stops at MSM
```

The mouse specific scatter plots aren't show here because there are too bulky. These plots are in a different document.

Making all of these scatter plots, allows us to look at the whole distributions of the data for each mouse. The distance of the red line from the black could be a indicator of slides or mice with slide specific technical noise.


# Research Questions


## Explaination for the XX and XY differences


## Difference in proportion of chrm classes

generate smaller data set of chrm proportions (0CO, 1CO,2CO ect)
10 cells from each musc category.


```{r draw.rand.cells, echo=FALSE}
ss <- sample(MLH1_data[MLH1_data$category == "PWD male",1:4], 10, replace = FALSE)
ii <- MLH1_data[ sample( which(MLH1_data$category=='G male'), 10 ), ]
```


```{r chrm_prop_data, echo=FALSE}

chrm.class.DF = read.csv("~./MLH1repo/ChrmClassProportions.csv", header = TRUE)
chrm.class.DF$fileName <- (chrm.class.DF$Original.Name)

chrm.class.DF <- add_mouse(chrm.class.DF)
chrm.class.DF <- add_strain(chrm.class.DF)
chrm.class.DF <- add_sex(chrm.class.DF)
chrm.class.DF <- add_category(chrm.class.DF)
#chrm.class.DF <- add_euth_date(meta.data.file2)
#chrm.class.DF <- add_age(meta.data.file2)

table(chrm.class.DF$category)
str(chrm.class.DF)

#summarize by category
this_thing2  <- ddply(.data=chrm.class.DF[chrm.class.DF$sex == "male",], 
                 .(category),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                  tot_biv  = sum(biv.sum.check),

                 n0CO = sum(n0CO),
                  n1CO = sum(n1CO),
                  n2CO = sum(n2CO),
                  n3CO = sum(n3CO),
                  n4CO = sum(n4CO),
                 
                 per0CO = sum(n0CO) / tot_biv,                 
                 per1CO= sum(n1CO)/ tot_biv,
                 per2CO= sum(n2CO)/ tot_biv,
                 per3CO= sum(n3CO)/ tot_biv,
                 per4CO= sum(n4CO)/ tot_biv,
                 
                 mean.MLH1.foci = mean(MLH1.sum.check),
                 mean.MLH1.foci2 = mean(nMLH1.foci),
                 meanQ = mean(quality)

)
str(this_thing2)

#this first one is the 'first' MLH1 count
oopp2 <- lm( mean.MLH1.foci2 ~ per0CO+ per1CO +per2CO +per3CO, data = this_thing2)
summary(oopp2)
#none of the classes are significant


#mean is the new calculated-- mean 0CO is significant and intercept
oopp <-  lm( mean.MLH1.foci ~ per0CO+ per1CO +per2CO +per3CO, data = this_thing2)
summary(oopp)
#not sure if these are inter-correlated
#I don't know why 0COs and the intercept are significant..
#0CO and 1CO are significant when only chrm classes are included (and intercept)


#no longer significant when used
#lm regression indicates that the proportions aren't significant contributers to meanMLH1 -- but this could be due to error
#after added more MSM data, tot_biv is not significant
#0CO is now more significant, and 2CO is sightly significant


#2CO proportion is the most significant, 1CO is second most significat, 3CO doesn't have enough power - total bivalents is also significant, there might be a bias

#MSM needs more bialent observations

#use melt to put all propotions 

#display / visualize / compare proportions

melt.table = read.csv("~./MLH1repo/ChrmClassProportions_melt.csv", header = TRUE)
melt.table$fileName <- (melt.table$Original.Name)

#melt.table <- add_mouse(melt.table)
#melt.table <- add_strain(melt.table)
#melt.table <- add_sex(melt.table)
#melt.table <- add_category(melt.table)

melt.table$strain<- factor(melt.table$strain,levels =c("LEW",
                      "WSB","G", "TOM","AST","KAZ", "SKIVE","PWD","MSM"), order=T )

melt.table <- with(melt.table, melt.table[order(strain),])

other_thing <- ggplot(data = melt.table, aes(y = value, x = strain, fill=as.factor(type)) ) + geom_col(position = "dodge")+facet_grid(sex~subsp)

other_thing




chrm.class.DF$perBiv0 <-chrm.class.DF$n0CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv1<-chrm.class.DF$n1CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv2<-chrm.class.DF$n2CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv3<-chrm.class.DF$n3CO/chrm.class.DF$biv.sum.check
chrm.class.DF$perBiv4<-chrm.class.DF$n4CO/chrm.class.DF$biv.sum.check

chrm.class.DF$biv.sum.check

```


PWD and MSM have a higher proportion of 2CO chrms!

what about the variance across cells?



## Models for manuscript

Rough ideas for models of evolution of Heterochiasmy and current idea for how to test them.

- HetC arises due to more precursors (DSBs)

    - Compare DSB counts
    
- Larger cell volume drives longer chrms axis (and maybe more DSB)

    - Measure meiocyte diameter in males and females. Compare spermatocyte diameters in male biased and female biased strains. 
    - Compare DSBs counts and average SC/axis lengths.


- Difference in astral/MT organization

    - ?


- Something about interference and sister cohesin area

    - Develope metric for sister cohesin area, and look at initial patterns.




## Mixed Model, compare within and between subspecies patterns


Initial results indicate that male MLH1 counts have less variance within subspecies but more between subspecies compared to female data.

*Does this hold up with the full data set?*
*What's the best visualization for these questions?*

Main focus is contrasting the level of difference within and between subspecies.

I'll do this with a mixed model framework approach (and analyze with ANOVA, a method to partition the variance of subset.)

```{r mixed.model, echo=FALSE}
#build mixed model
#run simulations for accounting for sampling error
# old code uses base plot



```


## Meiotic Error

This section reviews all the data from achiasmy and 0CO bivalents.


### Another Heterochiasmy Plot

```{r HetC.plot22, echo=FALSE,  fig.width=10, fig.height=5, fig.caption="Sex-Specific MLH1 average"}


no_female <- c("HMI", "SKIVE", "CZECH", "MOLF", "CAROLI", "TOM","AST")

MixedModel_CO_data <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$strain.x != "other",]
CO_data_HetC_w.old <- AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$strain.x != "other",]
CO_data_HetC_w.old <- CO_data_HetC_w.old[ ! CO_data_HetC_w.old$strain.x %in% no_female, ]
CO_data_HetC_w.old <- CO_data_HetC_w.old[!(is.na(CO_data_HetC_w.old$Nmice) | CO_data_HetC_w.old$Nmice==""), ]

MixedModel_CO_data <- MixedModel_CO_data[MixedModel_CO_data$age.weeks < 15,]

MixedModel_CO_data <- MixedModel_CO_data[!(is.na(MixedModel_CO_data$mouse) | MixedModel_CO_data$mouse==""), ]


MixedModel_CO_data <- MixedModel_CO_data[ ! MixedModel_CO_data$strain.x %in% no_female, ]

kuku <- ggplot(MixedModel_CO_data, aes(y=mean_co, x=mouse, color=sex.y))+geom_point()+facet_wrap(~strain.x)

bubu <- ggplot(data=CO_data_HetC_w.old)+geom_point(aes(y=mean_co, x=mouse, color=sex.x))+facet_wrap(~strain.x)

#add titles
#use multiplot
#remove X axis

multiplot(kuku,bubu, cols=2)
```


## SC.skel measures

run analysis for whole SC skel measures


```{r RWscSkel, echo=FALSE}
#merge the sc.skel outputs with the master MLH1 measures
#match up random names with original names

#the skel output and scripts are in the SC_skel dir. it was run on all images in the anon_data folder. I haven't manually confirmed that the default parameters are skeletonizing the images correctly.


#some of richard's analysis show negative relationship with SC length and MLH1 (his QTL word doc). Could this be sign
# of pwd like regulation?

setwd("~./")
SC.skel = read.csv("~./SC_skeletonize/data/SCskel_output_sep19.csv", header = TRUE, strip.white = TRUE)


SC.skel$rand_name <- as.character(SC.skel$rand_name)
original_DF$Random.Name <- as.character(original_DF$Random.Name)
str(SC.skel)
str(original_DF)

mlh1.skel.og <- merge(original_DF, SC.skel, by.x = "Random.Name", by.y = "rand_name", all= F)
#for some reason this only worked after the chr and all = F

mlh1.skel.og <- mlh1.skel.og[ !grepl("X", mlh1.skel.og$Batch) , ]
mlh1.skel.og <- mlh1.skel.og[ !grepl("x", mlh1.skel.og$Batch) , ]
mlh1.skel.og <- mlh1.skel.og[!(is.na(mlh1.skel.og$quality) | mlh1.skel.og$quality==""), ]

mlh1.skel.og <- add_mouse(mlh1.skel.og)
mlh1.skel.og <- add_strain(mlh1.skel.og)
mlh1.skel.og <- add_sex(mlh1.skel.og)

mlh1.skel.og <- add_category(mlh1.skel.og)
mlh1.skel.og <- add_subsp(mlh1.skel.og)

#mlh1.skel.og <- add_euth_date(mlh1.skel.og)
#mlh1.skel.og <- add_age(mlh1.skel.og)

str(mlh1.skel.og)
mlh1.skel.og$skel_size  <- as.numeric(mlh1.skel.og$skel_size)
mlh1.skel.og$bin_size <- as.numeric(mlh1.skel.og$bin_size)
mlh1.skel.og$nMLH1.foci <- as.numeric(mlh1.skel.og$nMLH1.foci)

#remove outliers
mlh1.skel <- mlh1.skel.og[mlh1.skel.og$skel_size < 25000,]
#first test file has ~1000 measures
#when I ran it, no sign of outliers (after removing all the X's cells)

looky <- ggplot(data = mlh1.skel.og[mlh1.skel.og$subsp == "Dom",], aes(y=skel_size, x=quality) ) + geom_jitter() + facet_wrap(sex~strain)


looky <- ggplot(data = mlh1.skel.og[mlh1.skel.og$subsp == "Musc",], aes(y=skel_size, x=nMLH1.foci, color=mouse) ) + geom_jitter() + facet_wrap(sex~strain)+theme(legend.position="none")  +ylim(c(0,2000))
#very possible that the dimesions and pixel density are skrewing with these values
# I am suspcious that there is such a wide range for the female data

looky.DOM <- ggplot(data = mlh1.skel.og[mlh1.skel.og$subsp == "Dom",], aes(y=skel_size, x=nMLH1.foci, color=mouse) ) + geom_jitter() + facet_wrap(sex~strain)+theme(legend.position="none")  +ylim(c(0,2000))


#mouse level
mouse.level.skel <- ddply(.data=mlh1.skel.og, 
                 .(mouse),
                 summarize, 
                 ncells = length(unique(Original.Name)),
                 nmice = length(unique(mouse)),
                 mean.MLH1 = mean(nMLH1.foci),
                 mean.skel = mean(skel_size)
)

mouse.level.skel <- add_strain(mouse.level.skel)
mouse.level.skel <- add_sex(mouse.level.skel)
mouse.level.skel <- add_category(mouse.level.skel)
mouse.level.skel <- add_subsp(mouse.level.skel)


looky.mouse <- ggplot(data = mouse.level.skel[mouse.level.skel$subsp == "Musc",], aes(y=mean.skel, x=mean.MLH1, color=strain) ) + geom_jitter() +ylim(c(150,1200))+facet_wrap(subsp~sex)

looky.mouseDom <- ggplot(data = mouse.level.skel[mouse.level.skel$subsp == "Dom",], aes(y=mean.skel, x=mean.MLH1, color=strain) ) + geom_jitter() +ylim(c(150,1200))+facet_wrap(subsp~sex)

#theme(legend.position="none") 

#double check a way to visually inspect the python skel output
#
#repeat random numbers?
```



```{r test.BivData, echo=FALSE}
#bivdata
setwd("~./")
MSM_BivData.og = read.csv("~./MLH1repo/data/BivData/Curate_MSMmale_9.9.19.csv", header = TRUE, strip.white = TRUE )

MSM_BivData <- MSM_BivData.og[MSM_BivData.og$SC.pass ==1,]
MSM_BivData <- MSM_BivData[!(is.na(MSM_BivData$hand.foci.count) | MSM_BivData$hand.foci.count==""), ]

#MSM_BivDatam_CO2 <- MSM_BivData[MSM_BivData$hand.foci.count == 2,]
#MSM_BivDatam_CO2 <- MSM_BivDatam_CO2[!(is.na(MSM_BivDatam_CO2$fileName) | MSM_BivDatam_CO2$fileName==""), ]

#MSM_BivDatam_CO2$Foci1.PER <- MSM_BivDatam_CO2$Foci1 /MSM_BivDatam_CO2$chromosomeLength
#MSM_BivDatam_CO2$Foci2.PER <- MSM_BivDatam_CO2$Foci2 /MSM_BivDatam_CO2$chromosomeLength 

MSM_BivData <- add_IFD(MSM_BivData)
#add IFD2 is f-ing up 
MSM_BivData <- addIFD.2(MSM_BivData)

#this MSM PER.IFD, is similar to the PWD data

#new function is converting all hand.foci counts to 3
#it might be the IFD functions

str(new_shiny)
str(MSM_BivData)

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
new_shiny <- add_SisCoTen(MSM_BivData)

new_shiny$rel_Siscoten <- new_shiny$SisCoTen / new_shiny$chromosomeLength

qq <- ggplot(data = new_shiny, aes(y=chromosomeLength, x=rel_Siscoten) ) + geom_jitter()

ww <- ggplot(data = MSM_BivDatam_CO2, aes(y=IFD1_PER, x=mouse, color = fileName) ) + geom_jitter()+
  geom_boxplot(aes(alpha=.3))

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
#KAZ and PWD data set is larger
PWD_KAZ_BivData.og = read.csv("~./MLH1repo/data/BivData/Merged_Curate_PWD.KAZ_BivData.csv", header = TRUE, strip.white = TRUE )

PWD_KAZ_BivData <- PWD_KAZ_BivData.og[PWD_KAZ_BivData.og$SC.pass == 1,]

PWD_KAZ_BivData <- add_IFD(PWD_KAZ_BivData)
PWD_KAZ_BivData <- addIFD.2(PWD_KAZ_BivData)
PWD_KAZ_BivData <- add_SisCoTen(PWD_KAZ_BivData)
PWD_KAZ_BivData$rel_Siscoten <- PWD_KAZ_BivData$SisCoTen / PWD_KAZ_BivData$chromosomeLength
PWD_KAZ_BivData <- add_mouse(PWD_KAZ_BivData)
PWD_KAZ_BivData <- add_strain(PWD_KAZ_BivData)

mouse_boxes <- ggplot(data = PWD_KAZ_BivData, aes(y=rel_Siscoten, x=mouse) ) + geom_jitter(aes( color=fileName))+
  geom_boxplot(aes(alpha=.3))+theme(legend.position="none")

mouse_boxes2 <- ggplot(data = PWD_KAZ_BivData, aes(y=SisCoTen, x=mouse) ) + geom_jitter(aes( color=fileName))+
  geom_boxplot(aes(alpha=.3))+theme(legend.position="none")

#mean relative and raw sisco-ten is higher in PWD compared to KAZ

biv_boxes <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=hand.foci.count, fill=hand.foci.count) ) + geom_jitter()+geom_boxplot(aes(x= hand.foci.count,alpha=.3))+
theme(legend.position="none")+facet_wrap(~strain)

biv_boxes22 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=as.factor(hand.foci.count)) )+ geom_jitter()+
  geom_boxplot(aes(alpha=.3))+theme(legend.position="none")+facet_wrap(~strain)


biv_boxes2 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=rel_Siscoten, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+
theme(legend.position="none")+facet_wrap(~strain)

regress <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=chromosomeLength) ) + geom_jitter(aes( color=as.factor(hand.foci.count) ))+ facet_wrap(~strain)




regress.1 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+ theme(legend.position="none")+ facet_wrap(~strain)
#, 1mar15_PWD_m1

regress.2 <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",], aes(y=SisCoTen, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+ theme(legend.position="none")+ facet_wrap(~strain)
#, 1mar15_PWD_m1

#

regress.1.KAZ <- ggplot(data = PWD_KAZ_BivData[PWD_KAZ_BivData$mouse == "21may18_KAZ_m2",], aes(y=SisCoTen, x=hand.foci.count) ) + geom_jitter(aes( color=fileName))+
 theme(legend.position="none")+ facet_wrap(~fileName)


#doesn't look like the sis-co-ten is conserved across bivs

```


```{r within.cell.corr, echo=FALSE}

#test telomere distance
#centromere distance
#SC length

#I want to test if SC lengths within cells cluster
#wouldn't ANOVA get at this..?

#cell level variance is significant predictor for SC length (telomere)

#PWD_KAZ_BivData[PWD_KAZ_BivData$strain != "other",]
jjgg <- ddply(.data= PWD_KAZ_BivData,
                 .(fileName),
                 summarize, 
                 nbiv = length(unique(Obj.ID) ),
                  var.sc = var(chromosomeLength)
)

#reasons why this within cell correlation doesn't work well with bivalent data
  #different sets of chrms
#not enough resolution at cytology level

```


sis-coten metric:
I am currently missing a null model / test for this metric
(sis-co-ten from uniform placement of COs, and (some prob of draw for CO number))


there is a positive correlation with siscoten and chrm length 

there could be something about kinetochore sites differing across specific chromosomes that balance the force
