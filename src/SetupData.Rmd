---
title: "Setting up Data"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
library(plyr)
library(dplyr)
library(raster)#for cV
library(ggplot2)
library(knitr)
library(kableExtra)
setwd("~./MLH1repo/")
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

#forgot why I'm reading in this metadata file
meta.data = read.csv("data/clean.Meta.Data.txt",sep = "\t", header=TRUE)
#remove all MAD (peromyscus) from meta.data
meta.data <- meta.data[ !grepl("MAD", meta.data$mouse) , ]

MLH1_data = read.csv("data/MLH1/AnonData.csv", header=TRUE)

knitr::opts_chunk$set(echo = FALSE)
```



```{r MLH1.DF.setup, warning=FALSE, echo=FALSE}

original_DF = MLH1_data
original_DF$fileName <- (original_DF$Original.Name)

original_DF <- add_mouse(original_DF)
original_DF <- add_strain(original_DF)
original_DF <- add_category(original_DF)
original_DF <- add_sex(original_DF)


#check for duplicated data, make duplicated data DF for repeatability
#anyDuplicated(original_DF$fileName)#219
#orig_DF <- original_DF[duplicated(original_DF$Original.Name),]
#these just produce 1 set of the duplicated 

#isolate the duplicates (fileName) from main MLH1 DFs
n_occur <- data.frame(table(original_DF$fileName))
#n_occur[n_occur$Freq > 1,] displays the dups
original_DF_duplicates <- original_DF[original_DF$fileName %in% n_occur$Var1[n_occur$Freq > 1],]#2 is the max freq of duplicates, 
#use the above DF for quantifying repeatability in the Main_report.Rmd
#duplicates are cells counted twice

#are there duplicated filenames+batch
original_DF_duplicates$unique.key <-  paste(original_DF_duplicates$fileName, original_DF_duplicates$Batch, sep = "_")
#anyDuplicated(original_DF_duplicates$unique.key)#31 duplicated fileName_batch ... really 2?

#remove duplicates from original as well
original_DF <- original_DF %>% distinct(Original.Name, .keep_all = TRUE)#5216 to 4983

```



```{r clean_MLH1_data, echo=FALSE}
#Clean up main DF, MLH1_data
#remove duplicated data from MLH1 -- remove 1 or the two rows
#https://www.datanovia.com/en/lessons/identify-and-remove-duplicate-data-in-r/
#use distinct() in dlpyr()
MLH1_data <- MLH1_data %>% distinct(Original.Name, .keep_all = TRUE)#5216 to 4983

MLH1_data$Original.Name <- as.character(MLH1_data$Original.Name)
MLH1_data$fileName <- (MLH1_data$Original.Name)

#these introduce NAs
MLH1_data$n <- as.character(MLH1_data$n)
MLH1_data$nMLH1.foci<- as.character(MLH1_data$nMLH1.foci)
MLH1_data$quality<- as.character(MLH1_data$quality)

MLH1_data$n <- as.numeric(MLH1_data$n)
MLH1_data$nMLH1.foci<- as.numeric(MLH1_data$nMLH1.foci)
MLH1_data$quality<- as.numeric(MLH1_data$quality)

#remove X's and NAs
MLH1_data <- MLH1_data[ !grepl("X", MLH1_data$X) , ]
MLH1_data <- MLH1_data[!(is.na(MLH1_data$nMLH1.foci) | MLH1_data$nMLH1.foci==""), ]
#this should also have the empty column for removing X
MLH1_data <- MLH1_data[MLH1_data$nMLH1.foci != "X",]
MLH1_data <- MLH1_data[MLH1_data$nMLH1.foci != "x",]


MLH1_data <- add_mouse(MLH1_data)
MLH1_data <- add_category(MLH1_data)
MLH1_data <- add_strain(MLH1_data)
MLH1_data <- add_sex(MLH1_data)
MLH1_data <- add_subsp(MLH1_data)
#add species
MLH1_data <- add_species(MLH1_data)
```


```{r exclude.mice, echo=FALSE}
#remove mice -- 18nov17_WSB_f5 (only 1 cell)
exclude_mice_list <- c("10mar15_WSB_m2", "8oct14_WSB_f1", "8oct14_WSB_f3", "18nov17_WSB_f5",
                  "8jun15_G_f3", "8jun15_G_f4",
                  "4jan17_LEW_f2",
                  "8oct14_PWD_f3", "1apr15_PWD_f2", "8oct14_PWD_f5",
                  "12sep16_MSM_f3","31aug16_MSM_m2",
                  "27oct18_MOLF_m3",
                  "26oct18_SKIVE_f1","26oct18_SKIVE_f2","26oct18_SKIVE_f3",
                  "27aug18_CZECH_m1","8jun18_CZECH_m1",
                  "3sep18_AST_m1",
                  "3jel18_TOM_m1","3sep18_TOM_m1",
                  "31jul17_HMI_m1","3sep18_HMI_m1","3sep18_HMI_m2",
                 "21aug17_SPI_f1", "30may18_SPIC_f1", "30oct17_SPIC_m1", "8jun18_SPIC_m2"
                  )


MLH1_data <- MLH1_data[ ! MLH1_data$mouse %in% exclude_mice_list, ]
```


```{r adj_nMLH1, echo=FALSE}
#add a column with male adjusted MLH1 values (+1 to all males)
MLH1_data$adj_nMLH1.foci <- ifelse(MLH1_data$sex=="male", MLH1_data$nMLH1.foci+1, MLH1_data$nMLH1.foci)
MLH1_data$adj_nMLH1.foci <- as.numeric(MLH1_data$adj_nMLH1.foci)
```


```{r reorder.DF, echo=FALSE}
#reorder dataframe
MLH1_data <- MLH1_data %>%
  arrange(strain, sex, mouse) %>%
  mutate(Original.Name = factor(Original.Name) )

#order the batches in MLH1 and original
```


```{r kable.table, echo=FALSE}
#table comparing number of images in quantification batches
#ToDo:  correct the case of all batches, better names
#set an order to batches?
original_batches <- as.data.frame(table(original_DF$Batch) ) #these look bad
colnames(original_batches) <- c("BatchNum", "orginal")

final_batches <- as.data.frame(table(MLH1_data$Batch) ) #these look bad
colnames(final_batches) <- c("BatchNum", "main")

batch.stats <- merge(original_batches,final_batches, by="BatchNum")## mm is the table of batch stats
##batch18 has the wrong number, ~390
```

All images were manually quantified after the file name was anonimized. The original (full) dataset contains the quantification batches with the following number of images. Each batch csv file was merged into Anon.csv by hand.

`r kable(final_batches, caption = "Number of Images across all the anonimized Batches") %>% kable_styling()`


# Quality Cleaning steps

The original dataset was cleaned up in the following ways before analysis. Settting up main data file with explanation and examination of data. Make the raw original DF and main working DF with bad cells exlcuede. The original dataset had `r length(original_DF_duplicates$fileName)` duplicated file names. These were removed and can be used to quantify repeatability or repair. Using the distinct() function for the MLH1_data, the first duplicated filename is kept and the second removed.

Take out mice from the exclude list based on the output from Mouse level quality plots.

1. The quality of MLH1 counts for individual mice is / was assessed in the MouseLevelPlots Rmd (can I link this file?). A list, mice.to.exclude was made.

2. The list of excluded mice is applied in the MLH1.setup.data script, to remove these mice from the main dataset/dataframe. This script saves .RData file of the dataset which is loaded into Rmd files for analysis

Mouse specific plots of CO count and quality were examined for general quality from single mice. Mice which produced few cells of low quality were excluded to the 'HQ' (high quality) dataset. (The full dataset was used to look at some patterns)


# Mouse Data

Make mouse level tables

```{r mouse.table, echo=FALSE, warning=FALSE}

#Make a mouse level table
AP_mouse_table.HQ <- ddply(MLH1_data[MLH1_data$quality < 5,], c("mouse"), summarise,
                        Nmice = length(unique(mouse)),
                        Ncells  = length(adj_nMLH1.foci),
                        mean_co = as.numeric(format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3) ),
                        cV = cv(adj_nMLH1.foci),
                        var = as.numeric(format(round(   var(adj_nMLH1.foci),3), nsmall=3)),
                        sd   = round(sd(adj_nMLH1.foci), 3),
                        se   = round(sd / sqrt(Ncells), 3)
                        #quality?
)

AP_mouse_table.HQ <- add_strain(AP_mouse_table.HQ)
AP_mouse_table.HQ <- add_subsp(AP_mouse_table.HQ)
AP_mouse_table.HQ <- add_sex(AP_mouse_table.HQ)
AP_mouse_table.HQ <- add_category(AP_mouse_table.HQ)

#make sure they are all factors
AP_mouse_table.HQ$mouse <- as.factor(AP_mouse_table.HQ$mouse)
AP_mouse_table.HQ$sex <- as.factor(AP_mouse_table.HQ$sex)
AP_mouse_table.HQ$strain <- as.factor(AP_mouse_table.HQ$strain)
AP_mouse_table.HQ$subsp <-  as.factor(AP_mouse_table.HQ$subsp)

#add DOB to this table?
mice.frm.meta <- AP_mouse_table.HQ[(AP_mouse_table.HQ$mouse %in% meta.data$mouse),]

batch.mouse.count <- table(original_DF$mouse,original_DF$Batch) #mouse count by batch
batch.mouse.count.DF <- as.data.frame(batch.mouse.count)#this has a dif str, 3 cols -- like it was melted
batch.mouse.count.DF <- batch.mouse.count.DF[!(is.na(batch.mouse.count.DF$Freq)|batch.mouse.count.DF$Freq==0),]

#subsp in metadata not fully correct
meta.data <- add_strain(meta.data)
meta.data <- add_subsp(meta.data)
meta.data <- add_sex(meta.data)
meta.data <- add_category(meta.data)

#merge with DOB
mouse.table_w.Ages <- merge(batch.mouse.count.DF, meta.data, by.y = "mouse", by.x = "Var1", all = TRUE)
AP_mouse_table_w.Ages <- merge(AP_mouse_table.HQ, meta.data, by.y = "mouse", by.x = "mouse", all = TRUE)
#what are the differences between these two

#remove the NAs
AP_mouse_table_w.Ages <- AP_mouse_table_w.Ages[!(is.na(AP_mouse_table_w.Ages$category.x) | AP_mouse_table_w.Ages$category.x==""), ]
```



```{r Q1Q2.mouse.table, echo=FALSE}


#Make a mouse level table
Q12_mouse_table <- ddply(MLH1_data[MLH1_data$quality < 3,], c("mouse"), summarise,
                        
                        Nmice = length(unique(mouse)),
                        Ncells  = length(adj_nMLH1.foci),
                        mean_co = as.numeric(format(round(  mean(adj_nMLH1.foci), 3 ), nsmall=3) ),
                        cV = cv(adj_nMLH1.foci),
                        var = as.numeric(format(round(   var(adj_nMLH1.foci),3), nsmall=3)),
                        sd   = round(sd(adj_nMLH1.foci), 3),
                        se   = round(sd / sqrt(Ncells), 3)
                        #quality?
)

#REMOVE mice with fewer than 3 cells
Q12_mouse_table <- Q12_mouse_table[Q12_mouse_table$Ncells > 3,]

Q12_mouse_table <- add_strain(Q12_mouse_table)
Q12_mouse_table <- add_subsp(Q12_mouse_table)
Q12_mouse_table <- add_sex(Q12_mouse_table)
Q12_mouse_table <- add_category(Q12_mouse_table)

#use things from prv block
#mice.frm.meta 
#meta.data
#mouse.table_w.Ages

#MERGE HERE
Q12_mouse_table_w.Ages <- merge(Q12_mouse_table, meta.data, by.y = "mouse", by.x = "mouse", all = TRUE)
#what are the differences between these two

#remove the NAs
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[!(is.na(Q12_mouse_table_w.Ages$category.x) | Q12_mouse_table_w.Ages$category.x==""), ]


#CLEAN up and format for mixed models
Q12_mouse_table_w.Ages <- subset(Q12_mouse_table_w.Ages, select= -c(sex.y,sex.x,
                            subsp.y,subsp.x,
                    category.y,category.x, strain.x,
                    strain.y, mouse.1  )  )

Q12_mouse_table_w.Ages <- add_strain(Q12_mouse_table_w.Ages)
Q12_mouse_table_w.Ages <- add_subsp(Q12_mouse_table_w.Ages)
Q12_mouse_table_w.Ages <- add_sex(Q12_mouse_table_w.Ages)
Q12_mouse_table_w.Ages <- add_category(Q12_mouse_table_w.Ages)

Q12_mouse_table_w.Ages <- add_species(Q12_mouse_table_w.Ages)
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[Q12_mouse_table_w.Ages$species == "M.musculus",]

#REMOVE EXTRA STRAINS
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[Q12_mouse_table_w.Ages$subsp != "Cast",]
#remove musc strains
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[Q12_mouse_table_w.Ages$strain != "AST",]
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[Q12_mouse_table_w.Ages$strain != "TOM",]
#remove PERC, MOLF, CZECH, (no females)
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[Q12_mouse_table_w.Ages$strain != "CZECH",]
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[Q12_mouse_table_w.Ages$strain != "PERC",]

#REMOVE WRONG AGES
#afriad this is removing NA's
Q12_mouse_table_w.Ages <- Q12_mouse_table_w.Ages[( (Q12_mouse_table_w.Ages$age.weeks < 25) &  (Q12_mouse_table_w.Ages$age.days != 13) ) | is.na(Q12_mouse_table_w.Ages$age.weeks), ] #keeps mice without ages, and removes juvinilles

#MOL = subsp
Q12_mouse_table_w.Ages$subsp <- ifelse(grepl("MSM", Q12_mouse_table_w.Ages$strain), "Mol", 
        ifelse(grepl("MOLF", Q12_mouse_table_w.Ages$strain), "Mol", Q12_mouse_table_w.Ages$subsp))


#unclass order factors
#main df with variables coded as chr
Q12_mouse_table_w.Ages$subsp <- factor(Q12_mouse_table_w.Ages$subsp, ordered = FALSE)
Q12_mouse_table_w.Ages$sex <- factor(Q12_mouse_table_w.Ages$sex, ordered = FALSE)
Q12_mouse_table_w.Ages$strain <- factor(Q12_mouse_table_w.Ages$strain, ordered = FALSE)
Q12_mouse_table_w.Ages$species <- factor(Q12_mouse_table_w.Ages$species, ordered = FALSE)

```





```{r strain.table, echo=FALSE}

```


update the dissection document (that makes the meta.data DF)


## Number of mice per category


 number of mice are in the main DF (discribe the results for missing mice)



## Mouse Ages

Testes were collected from mice at various ages. For some poor breeding mice, I couldn't collect males at younger ages.

Is there a detectable age effect?

```{r Age.Hists, echo=FALSE, warning=FALSE}
#age.weeks col is missing

male_mouse_table_w.Ages <- AP_mouse_table_w.Ages[(AP_mouse_table_w.Ages$sex.x == "male") &(AP_mouse_table_w.Ages$category.x != "other"),]

all.ages_plot <- ggplot(AP_mouse_table_w.Ages[AP_mouse_table_w.Ages$sex.x == "male",], aes(age.weeks))+geom_histogram(binwidth = 3)+facet_wrap(~category.x)+ggtitle("Male Age Distributions")
all.ages_plot

male_mouse_table_w.good.ages <- male_mouse_table_w.Ages[male_mouse_table_w.Ages$age.weeks < 20,]
#droplevels on DF above

good.ages_plot <- ggplot(male_mouse_table_w.good.ages, aes(age.weeks))+geom_histogram(binwidth = 1)+facet_wrap(~category)+ggtitle("Good Male Age Distributions")

#male_mouse_table_w.good.ages
```



```{r color.scheme}
#color scheme, #mouse colors
#site for colors, #http://sape.inf.usi.ch/quick-reference/ggplot2/colour
colors_of_strains <- c('WSB'= "#56B4E9",'G' ='cadetblue','LEW'= 'lightblue','PERC'= 'blue',
                       #blues
                       
                       'PWD'= 'red2',
                       'SKIVE'= 'coral1','KAZ'= 'coral4', 'TOM'= 'indianred1','AST' = 'red4',
                       'CZECH'= 'indianred4',
                       
                       'MSM'= 'deeppink', 'MOLF'= 'hotpink', #mol are pinks, bc they are fancy mice
                       
                    'CAST'='green','HMI'= 'forestgreen', #greens
                    
                    'SPRET'='gold','SPIC'= 'goldenrod1', #browns? color of mounds?
                    'CAROLI'='gold3',
                    
                    "F1"='grey', "other" = 'grey'
                    )

```



# Saving Data file


Now that the dataframes have been process and formated, they will be saved as RData. the main files are:
  1. MLH1_data and original_DF
  2. AP_mouse_table and AP_mouse_table_w.Ages
  3. meta.data

work on cleaning up all other df with bad names

```{r save.RData, echo=FALSE}

save.image("~./MLH1repo/data/MLH1/MLH1_data_setup_1.10.20.RData")

#  OutPut: big large MLH1_data (AP's) df, big DF of BD with just the mice I want.
#  MLH1_data_table, means and variance of AP and BD MLH1 values. made from seperate tables from AP and BD data.
#  make sure decimal places are consistant

```



# Deciding on Mice for Final Dataset

Use the above information to make the final dataset for analysis

-age (for males)
-enough cells
-both male and female

