---
title: "BivData Setup"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---


# Data setup and basic cleaning

```{r setup, include=FALSE}
library(plyr)
library(lattice)
library(dplyr)
library(ggplot2)
library(reshape2)
library(raster)

setwd("~./MLH1repo/")
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

whole.cell.data_manual.OG <- read.csv("~./MLH1repo/whole_cell_measures.csv")


#BIVDATA MASTER SHEET
new.Curate.FULL <- read.csv("~./MLH1repo/data/BivData/curation/FULL_Curated_BivData.csv")
#83976
#83009
#80898
#80919
#61084
#60241
#60830

#Clean away all the empty rows
new.Curate.FULL <- new.Curate.FULL[!(is.na(new.Curate.FULL$fileName) | new.Curate.FULL$fileName==""), ]

#Apply the cleaning steps below to the FULL-OG DF

#remove non number charaecters for the FULL / OG DF
#Curated_BivData <- Curated_BivData[ !grepl("[?]", Curated_BivData$SC.pass) , ]
#Curated_BivData <- Curated_BivData[ !grepl("[?]", Curated_BivData$hand.foci.count) , ]

#remove data which has paint marks
#P_fileNames <- Curated_BivData$fileName[(grep('p_rev', Curated_BivData$fileName))]
#length(P_fileNames)

#remove anything with 'DUPLICATE'
#DUP_list <- Curated_BivData$fileName[(grep('DUP', Curated_BivData$fileName))]
#DUP_num = length(DUP_list)#0


#dup_list= c()
#for(i in Curated_BivData$fileName){  #change the file name header,  
#  # print(i)
#  ifelse(grepl("\\.[0-9]_rev", i),
#         (dup_list = c(dup_list, i)), NA)
#}
#MultiCells = c()
#for(j in dup_list){
#  stringLIST = strsplit(j, split="\\.")[[1]]
#  new_string = paste(stringLIST[[1]][1], "rev", sep="_")
#  MultiCells = c(MultiCells, new_string)
#}
#MultiCells = unique(MultiCells)
#multi_cell_num = length(MultiCells)#118

#new.Curate.FULL$Obj.ID <- paste(new.Curate.FULL$fileName, new.Curate.FULL$boxNumber, sep = "_")
#colnames(new.Curate.FULL)

new.Curate.FULL <- add_mouse(new.Curate.FULL)#this function is v.slow for this big file
#make OG copy
new.Curate.FULL.org <- new.Curate.FULL
new.Curate.FULL.org <- add_category(new.Curate.FULL.org)

#write files for basic stats to csv files
#OG.cURATE.table.mouse <- table(new.Curate.FULL.org$mouse, new.Curate.FULL.org$SC.pass)

#OG.cURATE.table.mouse <- add_strain(OG.cURATE.table.mouse)

OG.cURATE.table.category <- table(new.Curate.FULL.org$category, new.Curate.FULL.org$SC.pass)

#write the curated file
#write.table(OG.cURATE.table.mouse, "~./MLH1repo/data/CurrentCuratedDataset_21.1.20.csv", sep=",",
#            row.names = TRUE)
#
#write.table(OG.cURATE.table.category, "~./MLH1repo/data/CurrentCuratedDataset_cat_21.1.20.csv", sep=",",
#            row.names = TRUE)
```

```{r split.up.DF, echo=FALSE}

#SC PASS
new.Curate.FULL <- new.Curate.FULL[new.Curate.FULL$SC.pass == '1',]#10480 #9819, #9769

#fix these duplicated ones
#remove duplicates
Curated_BivData <- new.Curate.FULL %>% distinct()#from 8933 to 8151

Curated_BivData <- add_mouse(Curated_BivData)
Curated_BivData <- add_category(Curated_BivData)
Curated_BivData <- add_strain(Curated_BivData)
Curated_BivData <- add_sex(Curated_BivData)
Curated_BivData <- add_subsp(Curated_BivData)

Foci_TRUE_Curate_BivData <-   Curated_BivData[(!is.na(Curated_BivData$hand.foci.count)),]
#can I write a quick dummy check?
#there are 2 lines with 0 hand.foci, but with a foci position

```


# Manual Whole Cell


```{r whole.cell.manual.clean, echo=FALSE}
#compare and clean up whole cell measures

whole.cell.data_manual <- whole.cell.data_manual.OG[whole.cell.data_manual.OG$chrm.class != "XY",]

colnames(whole.cell.data_manual.OG)
#"return5"         "fileName"        "boxNumber"       "centromere"      "SC.length"  #    
 #[6] "rank"            "chrm.class"      "hand.foci.count" "F1"              "F2"    #         
#[11] "F3"              "notes"           "X"               "X.1"            
#remove, X, X.1
whole.cell.data_manual <- whole.cell.data_manual[-c(1, 13:14)]
whole.cell.data_manual$Foci4 <- ""

#rename foci positions
whole.cell.data_manual$Foci1 <- whole.cell.data_manual$F1
whole.cell.data_manual$Foci2 <- whole.cell.data_manual$F2
whole.cell.data_manual$Foci3 <- whole.cell.data_manual$F3

#mouse, strain, sex, category
whole.cell.data_manual <- add_mouse(whole.cell.data_manual)
whole.cell.data_manual <- add_category(whole.cell.data_manual)
whole.cell.data_manual <- add_strain(whole.cell.data_manual)
whole.cell.data_manual <- add_sex(whole.cell.data_manual)
whole.cell.data_manual <- add_subsp(whole.cell.data_manual)


#whole.cell.data_manual <-   whole.cell.data_manual[(!is.na(whole.cell.data_manual$fileName)),]
whole.cell.data_manual <- whole.cell.data_manual[!(is.na(whole.cell.data_manual$fileName) | whole.cell.data_manual$fileName==""), ]


#obj.id
whole.cell.data_manual$Obj.ID <- paste(whole.cell.data_manual$fileName, whole.cell.data_manual$boxNumber, sep = "_")


#add all the extra columns, blah


#percent Foci position


#ADD RANK
for(cellys in as.character(unique(whole.cell.data_manual$fileName))){
  
 # print(cellys)
  chrm.order = rank(whole.cell.data_manual$SC.length[whole.cell.data_manual$fileName == cellys])
  whole.cell.data_manual$rank[whole.cell.data_manual$fileName == cellys] <- chrm.order  
  }

#IFD 
whole.cell.data_manual <- add_IFD(whole.cell.data_manual)




```




ToDo  

- Go back and clean up the original excel data  

- clean the bottom, fill in missing data  

- check the order of foci positions for 5aug17_14jul17_LEW_f1_sp1_11_rev_blob4.


edit / clean up the lines with bad hand.foci.count (61)


ToDo:

1.clean up the non-numbered curated values (for the og df)

2.Goal of this doc is to make DFs that are ready for the analysis.

3.remove the 2 main sources of duplicate lines; 6mar16_PWD_m1, 1mar15_PWD_m1

4. decide on the right number of passing curated bivalents per category I should settle for
Justify why the current number is enough -- or subsample -- to random equivilent sized data sets

5. make sure that the saved Rdata has all the right cols and tables for the next analyses

6. consider integrating manual hand / whole cell measures (check for DUPs ect.)

Main files from this plot:  
  
  1. **Curated_BIVDATA**: cleaned up version of the passing, curated Bivalent measures  
  
  2.  **Foci_TRUE_Curated_Bivdata**: filterd version of the Curated_BivData file, but with only measures that have 'good' foci position information
  
  3. OG.Curate_FULL: original version of the Bivalent data (before 'failed' SC wiped away)  
  
  4. MELT_ABS: make melt version of foci positions for abs measuers
  
  5. CELL and 

  6. mouse table



```{r CLEAN.UP.1, echo=FALSE, include=FALSE}

#check for duplicates, and track them down
anyDuplicated(new.Curate.FULL$Obj.ID)  #5335, #3467

dup.curated <- new.Curate.FULL[duplicated(new.Curate.FULL$Obj.ID),] #784
dup.curated <- add_mouse(dup.curated)

#table(dup.curated$mouse)
#1mar15_PWD_m1

#which lines are duplicated
#lots of PWD_female duplicated -- probably how I put together the curated files

#new.Curate.FULL <- new.Curate.FULL.org[(new.Curate.FULL.org$SC.pass == 1 | new.Curate.FULL.org$SC.pass == 0),]
#new.Curate.FULL <- droplevels(new.Curate.FULL)

#new.Curate.FULL <- add_mouse(new.Curate.FULL)
#new.Curate.FULL <- add_category(new.Curate.FULL)

#pass.fail.table <- table(new.Curate.FULL$SC.pass, new.Curate.FULL$category)
#this outsput shows the relative ratios of pass to fail biv segmentation

```


```{r set.type, echo=FALSE}

##change factor cols to numbers (factor -> chr -> number)
Curated_BivData$centromere_ABS_Position <- as.character(Curated_BivData$centromere_ABS_Position)
Curated_BivData$centromere_PER_Position <- as.character(Curated_BivData$centromere_PER_Position)
Curated_BivData$chromosomeLength <- as.character(Curated_BivData$chromosomeLength)

Curated_BivData$hand.foci.count <- as.character(Curated_BivData$hand.foci.count)

Curated_BivData$Foci1 <- as.character(Curated_BivData$Foci1)
Curated_BivData$Foci2 <- as.character(Curated_BivData$Foci2)
Curated_BivData$Foci3 <- as.character(Curated_BivData$Foci3)
Curated_BivData$Foci4 <- as.character(Curated_BivData$Foci4)

##Numeric
Curated_BivData$centromere_ABS_Position <- as.numeric(Curated_BivData$centromere_ABS_Position)
Curated_BivData$centromere_PER_Position <- as.numeric(Curated_BivData$centromere_PER_Position)
Curated_BivData$chromosomeLength <- as.numeric(Curated_BivData$chromosomeLength)

Curated_BivData$hand.foci.count <- as.numeric(Curated_BivData$hand.foci.count)

Curated_BivData$Foci1 <- as.numeric(Curated_BivData$Foci1)
Curated_BivData$Foci2 <- as.numeric(Curated_BivData$Foci2)
Curated_BivData$Foci3 <- as.numeric(Curated_BivData$Foci3)
Curated_BivData$Foci4 <- as.numeric(Curated_BivData$Foci4)
#I think the number of sig figs and rounding changes slightly from the blocks above

#adding more feature calculations (IFD, ect)
Curated_BivData <- add_IFD(Curated_BivData)
Curated_BivData$IFD1_PER = Curated_BivData$IFD1_ABS / Curated_BivData$chromosomeLength

#IFD.2 does mulitple IFDs (just absolute)
#Curated_BivData <- add_IFD.2(Curated_BivData)

Curated_BivData$PER_Foci_1 <- Curated_BivData$Foci1 / Curated_BivData$chromosomeLength
Curated_BivData$PER_Foci_2 <- Curated_BivData$Foci2 / Curated_BivData$chromosomeLength
Curated_BivData$PER_Foci_3 <- Curated_BivData$Foci3 / Curated_BivData$chromosomeLength
Curated_BivData$PER_Foci_4 <- Curated_BivData$Foci4 / Curated_BivData$chromosomeLength

Curated_BivData$PER_Foci_1 <- as.numeric(Curated_BivData$PER_Foci_1)
Curated_BivData$PER_Foci_2 <- as.numeric(Curated_BivData$PER_Foci_2)
Curated_BivData$PER_Foci_3 <- as.numeric(Curated_BivData$PER_Foci_3)
Curated_BivData$PER_Foci_4 <- as.numeric(Curated_BivData$PER_Foci_4)

#not working
Curated_BivData$dis.cent <- Curated_BivData$Foci1 - Curated_BivData$centromere_ABS_Position
Curated_BivData$dis.cent.PER  <- Curated_BivData$dis.cent / Curated_BivData$chromosomeLength


#add telomere.dist
#str(Curated_BivData)
```


IFD functions

  - IFD: currently I think just does 2CO bivalents  
  
  - IFD.2: for mulitple IFDs (3CO ect.)  
  

# Cell Level table

- pass rate (don't need the OG.DF file, because I can count the number of boxes with the max index number)

- number bivs per mice?

- number cells represented per mouse

- number of pass.SC w/out foci position data

- number of foci with 'faint' mentioned in the notes


```{r cell.level.table, echo=FALSE}

cell.level.BivData_table <- ddply(.data=Curated_BivData, 
                       .(fileName),
                       summarize, 
                       boxs.IDd = max(boxNumber),
                       nboxes_passed = length(boxNumber),
                       
                       Nbiv = length(Obj.ID), #if there are na's below -- it breaks
                       CO0 =  sum(hand.foci.count == 0, na.rm=TRUE), 
                       CO1 =  sum(hand.foci.count == 1, na.rm=TRUE), 
                       CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                       CO3 = sum(hand.foci.count == 3, na.rm=TRUE),
                       CO4 = sum(hand.foci.count == 4, na.rm=TRUE),
                       
                       ncells = length(unique(fileName)),
                       nbivs = length(unique(Obj.ID)),

                       mean.SC_length = mean(chromosomeLength, na.rm = TRUE),
                       var.SC_length = var(chromosomeLength),
                       sd.SC_length   = round(sd(chromosomeLength), 3),
                       se.SC_length   = round(sd.SC_length / sqrt(nbivs), 3), #check that nBivs is the right number
 
                       cv.SC = cv(chromosomeLength),
                       
#AutoSC = sum( SC.length[which(blobjectClass != "XY")] ),
                      mean.IFD_all = mean(   IFD1_ABS, na.rm = TRUE),

                       mean.IFD_2C0 = mean(   IFD1_ABS[which(hand.foci.count == 2)], na.rm = TRUE),
                      var.IFD_2CO = var( IFD1_ABS[which(hand.foci.count == 2)], na.rm=TRUE),
                       #sd.IFD_2CO   = round(sd(IFD1, na.rm=TRUE), 3),
                       #se.IFD_2CO   = round(sd.IFD / sqrt(nbivs), 3)

#cent_dis
                      mean_cent_dist = mean(dis.cent, na.rm=TRUE)
#telomere dist

#can't think of a why to calq this by just 2CO

)
                       #add the centromere and ifd here?
                       #mean.dist_cent = mean(dis.cent, na.rm=TRUE),
#                       var.dist_cent = var(dis.cent, na.rm=TRUE),
#                       sd.dist_cent   = round(sd(dis.cent, na.rm=TRUE), 3),
#                       se.dist_cent   = round(sd.dist_cent / sqrt(nbivs), 3),
                       
#                       mean.siscoten = mean(SisCoTen, na.rm=TRUE),
#                       var.siscoten = var(SisCoTen, na.rm=TRUE),
#                       sd.siscoten   = round(sd(SisCoTen, na.rm=TRUE), 3),
 #                      se.siscoten   = round(sd.siscoten / sqrt(nbivs), 3),
                       
#                       mean.IFD = mean(IFD1, na.rm=TRUE),#IFD1 is chr
#                       var.IFD = var(IFD1, na.rm=TRUE),
#                       sd.IFD   = round(sd(IFD1, na.rm=TRUE), 3),
#                       se.IFD   = round(sd.IFD / sqrt(nbivs), 3),
                       
 #                      mean.IFDper = mean(IFD1_PER, na.rm=TRUE),#IFD1 is chr
#                       var.IFDper = var(IFD1_PER, na.rm=TRUE),
#                       sd.IFDper   = round(sd(IFD1_PER, na.rm=TRUE), 3),
#                       se.IFDper   = round(sd.IFDper / sqrt(nbivs), 3)
                       
cell.level.BivData_table <- add_mouse(cell.level.BivData_table)
cell.level.BivData_table <- add_strain(cell.level.BivData_table)
cell.level.BivData_table <- add_category(cell.level.BivData_table)

as.data.frame( head(cell.level.BivData_table) )

```



```{r whole.cell_merging, echo=FALSE}

#check if there are fileNames
double.filename <- whole.cell.data_manual[ whole.cell.data_manual$fileName %in% Curated_BivData$fileName, ]

#which cell-levels fileNames have close to 15-17 chrms?

almost_whole_cell <- cell.level.BivData_table[(cell.level.BivData_table$Nbiv < 21),]
almost_whole_cell <- almost_whole_cell[almost_whole_cell$Nbiv > 15,]

#there is some discrpancy with the Nbiv and nbivs columns! ugh why, some have 20 and 10

#get the Biv data 
almost_whole_cell_BivData <- Curated_BivData[ Curated_BivData$fileName %in% almost_whole_cell$fileName, ]

as.data.frame(  table( droplevels( almost_whole_cell_BivData$fileName) ) )
length(unique(almost_whole_cell_BivData$fileName))


#what next?


```


3 cells have manual measures and BivData measures. test error, need to match them up. There are 145 cells from the BivData set which are close to whole cells.  


8jun15_23apr15_PWD_f2_sp1_20_rev, 29nov16_13nov16_MSM_m2_sp1_13_rev, 27oct16_31aug16_MSM_m1_sp1_9_rev





# Mouse leve table


the mouse table will be the pooled stats / summary of all SC.passing + 

```{r mouse.table, echo=FALSE}

mouse.level.BivData_table <- ddply(.data=Curated_BivData, 
                       .(mouse),
                       summarize, 
                       
                       ncells = length(unique(fileName)),
                       
                       boxs.IDd = max(boxNumber),  #
                       nboxes_passed = length(boxNumber),
                       
                       Nbiv = length(Obj.ID), #if there are na's below -- it breaks
                       CO0 =  sum(hand.foci.count == 0, na.rm=TRUE), 
                       CO1 =  sum(hand.foci.count == 1, na.rm=TRUE), 
                       CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                       CO3 = sum(hand.foci.count == 3, na.rm=TRUE),
                       CO4 = sum(hand.foci.count == 4, na.rm=TRUE),
                       
                       ncells = length(unique(fileName)),
                       nbivs = length(unique(Obj.ID)),

                       mean.SC_length = mean(chromosomeLength, na.rm = TRUE),
                       var.SC_length = var(chromosomeLength, na.rm = TRUE),
                       sd.SC_length   = round(sd(chromosomeLength), 3),
                       se.SC_length   = round(sd.SC_length / sqrt(nbivs), 3)
)   

as.data.frame( head(mouse.level.BivData_table) )
#kable didn't work

```




analysis using the mouse level table -- to justify that using mouse averages is a good idea.


Plots  

1. Histograms of N.bivs per cell, facet category  

2. Number of images per mouse, number of biavlents per mouse (not sure what kinda of plot for this)

3. 

Is there a way to check my assumptions for these measues?  

What are the sources of error fot these data?



```{r telo.cent_dist, echo=FALSE}

#code for cal1 the telomere distance
#space between last foci and telomere end

#telo_dist <- if(hand.foci = 1){
          #SC.Length - F1
#}
#elseif(hand_foci == 2){ #SC.length - F2}


#code for centromere
#space between first foci and centromere/centromere-end

#cent_end_dist
#cent_dist
```



# melt position table

make the melt DF for the abs (raw) foci positions and then calculated the normalized (PER) foci positions from that table


```{r MELT.block1, echo=FALSE}

col.names.list <- colnames(Curated_BivData)
#"fileName" ,  "chromosomeLength",        "centromere_ABS_Position", "centromere_PER_Position",
#"boxNumber",               "Obj.ID",                  "SC.pass",                 "foci.pass",              
#"curated.1pass.0fail",     "curation.notes",          "hand.foci.count",        "Foci1",                  
#"Foci2",       "Foci3",                "notes",                 "mouse",                  
#"category",                "strain",                  "sex",                    "subsp",                  
#"IFD1_ABS",                "IFD1_PER",               

#all of the cols to use
MELT_Curated_BivData <- melt(Curated_BivData[,c("fileName","chromosomeLength","centromere_ABS_Position","centromere_PER_Position",  "boxNumber", "Obj.ID", "SC.pass","foci.pass",              
              "curated.1pass.0fail","curation.notes", "hand.foci.count","notes", "mouse",
              #leave out the Foci
                "Foci1","Foci2","Foci3", "Foci4")], 
                 
            id=c("fileName","chromosomeLength","centromere_ABS_Position","centromere_PER_Position",
                    "boxNumber", "Obj.ID", "SC.pass","foci.pass",              
              "curated.1pass.0fail","curation.notes", "hand.foci.count","notes", "mouse"))

MELT_Curated_BivData <- MELT_Curated_BivData[(!is.na(MELT_Curated_BivData$value)),]

#MELT, -- 15
colnames(MELT_Curated_BivData) <- c(col.names.list[c(1:11, 16:17)], "Foci_Type", "Pos") #too many foci

MELT_Curated_BivData$Pos <- as.numeric(MELT_Curated_BivData$Pos)


#calq normalized melt pos
MELT_Curated_BivData$PER.Foci.Pos <- MELT_Curated_BivData$Pos / MELT_Curated_BivData$chromosomeLength

MELT_Curated_BivData <- MELT_Curated_BivData[(!is.na(MELT_Curated_BivData$Pos)),]


```



```{r general.foci.pos, echo=FALSE, eval=FALSE}

#make the normalized foci density plots
#MELT_Curated_BivData.PER <- MELT_Curated_BivData.PER[MELT_Curated_BivData.PER$hand.foci.count < 5, ]
#MELT_Curated_BivData.PER <- MELT_Curated_BivData.PER[!MELT_Curated_BivData.PER$hand.foci.count == 0, ]

#MELT_Curated_BivData.PER <- MELT_Curated_BivData.PER[MELT_Curated_BivData.PER$PER_Position < 1.1, ]#

#remove 0 and NA
#remove 4foci count?

#check for values over 1

#density <- ggplot(MELT_Curated_BivData.PER, aes(x=PER_Position, fill=sex) ) + geom_density(alpha=.4) + facet_wrap(~hand.foci.count)+ggtitle("Normalized Foci Positions")

#density
#table(the4$mouse)
#something wrong with the 4 bivalents
#many of the lines just have 3 lines

```

This is proof that the plot codes work, but move the figures in the analysis doc. remeber this is just data-setup.

think about weighing the density plots by the number of bivalents per category... 




# Assemble final BivData DF


Main files from this plot:  
  
  1. new.Curate.FULL: cleaned up version of the passing, curated Bivalent measures  
  
  2. OG.Curate_FULL: original version of the Bivalent data (before 'failed' SC wiped away)  
  
  3. MELT_ABS: make melt version of foci positions for abs measuers
  
  4. CELL and mouse table

  5. 


MAIN BIVDATA_DF
decide on the colnames that I want for the final DF

fileName, Object_ID, box.number, centromere_ABS, centromere_PER
chromosome length, SC.pass, Foci.pass, hand.foci.count, 
F1, F2, F3, F4, F1_per, F2_per, F3_per, F4_per, IFD

telomere_dist, cent_dist, 

mouse, strain, category, subsp, 

merge:
cell.MLH1.count, cell.quality, mouse.age, 
cell.total_skel, cell.total_binary



# Save


```{r save.file}

#save Rdata
save.image("~./MLH1repo/data/CleanBivData_1.21.20.RData")
#save.image("data/BivData_4_PCA.RData")

```



# Analysis

planned analyses for later docs, but this is the list for getting everything ready

Use the Bivalent_Analysis.Rmd for analysis pieces
BivPattern.Rmd started to analyze this but, not a very clear setup


- chrom class proportions

- SC lengths, by CO number

