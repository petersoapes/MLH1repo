---
title: "BivData Setup"
author: "April Peterson"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---


# Main Files

Main files from this Script:  
  
  1. **Curated_BIVDATA**: cleaned up version of the passing, curated Bivalent measures  
  
  2.  **Foci_TRUE_Curated_Bivdata**: filterd version of the Curated_BivData file, but with only measures that have 'good' foci position information
  
  3. OG.Curate_FULL: original version of the Bivalent data (before 'failed' SC wiped away)  
  
  4. **MELT_ABS**: make melt version of foci positions for abs measuers
  
  5. CELL level table (full all mice) (use this to make long biv dataset)
  
  6. Long Biv Dataset and short biv dataset

  7. mouse table (full all mice)
  
  8. **Strain DFs** for Het models **Mouse.Table_BivData_4MM**
  
  9. **male Subsp DFs** for Polymorphism models **Male.poly.Mouse.Table_BivData_4MM**

 


# Data setup and basic cleaning

- remove BivData! (these are all Peromyscus!!) (not sure where this DF comes from)


add mean.telomere, mean cent.dist and mean sis.coten to the mouse level table

update IFD functions, to add IFD2,3 -- report the summaries

format manual data set so SC.length = Chrmlength (matches the bivData)



ToDo  


- Fix the hand.foci.count ==2, 5jan19_27oct18_SKIVE_m2_sp1_3.2_rev_13

- Fix all the hand.foci == 4, which don't have the right number of positions


- Go back and clean up the original excel data  

- clean the bottom, fill in missing data  

- check the order of foci positions for 5aug17_14jul17_LEW_f1_sp1_11_rev_blob4.


edit / clean up the lines with bad hand.foci.count (61)


ToDo:

1.clean up the non-numbered curated values (for the og df)

2.Goal of this doc is to make DFs that are ready for the analysis.

3.remove the 2 main sources of duplicate lines; 6mar16_PWD_m1, 1mar15_PWD_m1

4. decide on the right number of passing curated bivalents per category I should settle for
Justify why the current number is enough -- or subsample -- to random equivilent sized data sets

5. make sure that the saved Rdata has all the right cols and tables for the next analyses

6. consider integrating manual hand / whole cell measures (check for DUPs ect.)


```{r setup, include=FALSE}
library(plyr)
library(lattice)
library(dplyr)
library(ggplot2)
library(reshape2)
library(raster)

setwd("~./MLH1repo/")
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

whole.cell.data_manual.OG <- read.csv("~./MLH1repo/whole_cell_measures.csv")

#BIVDATA MASTER SHEET
new.Curate.FULL <- read.csv("~./MLH1repo/data/BivData/curation/FULL_Curated_BivData.csv")
#83975
#83976
#83009
#80898
#80919
#61084
#60241
#60830

#Clean away all the empty rows
new.Curate.FULL <- new.Curate.FULL[!(is.na(new.Curate.FULL$fileName) | new.Curate.FULL$fileName==""), ]
#this takes a while to run

new.Curate.FULL <- add_mouse(new.Curate.FULL)#this function is v.slow for this big file
#make OG copy
new.Curate.FULL.org <- new.Curate.FULL
new.Curate.FULL.org <- add_category(new.Curate.FULL.org)

new.Curate.FULL.org$Obj.ID <- paste(new.Curate.FULL.org$fileName, new.Curate.FULL.org$boxNumber, sep = "_")

#write files for basic stats to csv files
#OG.cURATE.table.mouse <- table(new.Curate.FULL.org$mouse, new.Curate.FULL.org$SC.pass)
#OG.cURATE.table.mouse <- add_strain(OG.cURATE.table.mouse)

OG.cURATE.table.category <- table(new.Curate.FULL.org$category, new.Curate.FULL.org$SC.pass)

#write the curated file
#write.table(OG.cURATE.table.mouse, "~./MLH1repo/data/CurrentCuratedDataset_21.1.20.csv", sep=",",
#            row.names = TRUE)
#write.table(OG.cURATE.table.category, "~./MLH1repo/data/CurrentCuratedDataset_cat_21.1.20.csv", sep=",",
#            row.names = TRUE)
```


```{r split.up.DF, echo=FALSE}
#new.Curate.FULL to Curated_BivData

#SC PASS
new.Curate.FULL <- new.Curate.FULL[new.Curate.FULL$SC.pass == '1',]#
#10480 #9819, #9769

#fix these duplicated ones
#remove duplicates
Curated_BivData <- new.Curate.FULL %>% distinct()#from 8933 to 8151

Curated_BivData <- add_mouse(Curated_BivData)
Curated_BivData <- add_category(Curated_BivData)
Curated_BivData <- add_strain(Curated_BivData)
Curated_BivData <- add_sex(Curated_BivData)
Curated_BivData <- add_subsp(Curated_BivData)
Curated_BivData <- add_species(Curated_BivData)

#don't think I need this one
#Foci_TRUE_Curate_BivData <-   Curated_BivData[(!is.na(Curated_BivData$hand.foci.count)),]
```


```{r set.type_Curated_BivData, echo=FALSE}
##change factor cols to numbers (factor -> chr -> number)
Curated_BivData$centromere_ABS_Position <- as.character(Curated_BivData$centromere_ABS_Position)
Curated_BivData$centromere_PER_Position <- as.character(Curated_BivData$centromere_PER_Position)
Curated_BivData$chromosomeLength <- as.character(Curated_BivData$chromosomeLength)

Curated_BivData$hand.foci.count <- as.character(Curated_BivData$hand.foci.count)

Curated_BivData$Foci1 <- as.character(Curated_BivData$Foci1)
Curated_BivData$Foci2 <- as.character(Curated_BivData$Foci2)
Curated_BivData$Foci3 <- as.character(Curated_BivData$Foci3)
Curated_BivData$Foci4 <- as.character(Curated_BivData$Foci4)

##Numeric
Curated_BivData$centromere_ABS_Position <- as.numeric(Curated_BivData$centromere_ABS_Position)
Curated_BivData$centromere_PER_Position <- as.numeric(Curated_BivData$centromere_PER_Position)
Curated_BivData$chromosomeLength <- as.numeric(Curated_BivData$chromosomeLength)

Curated_BivData$hand.foci.count <- as.numeric(Curated_BivData$hand.foci.count)

Curated_BivData$Foci1 <- as.numeric(Curated_BivData$Foci1)
Curated_BivData$Foci2 <- as.numeric(Curated_BivData$Foci2)
Curated_BivData$Foci3 <- as.numeric(Curated_BivData$Foci3)
Curated_BivData$Foci4 <- as.numeric(Curated_BivData$Foci4)
#I think the number of sig figs and rounding changes slightly from the blocks above

#adding more feature calculations (IFD, ect)
Curated_BivData <- add_IFD(Curated_BivData)#fixed a bug
Curated_BivData$IFD1_PER = Curated_BivData$IFD1_ABS / Curated_BivData$chromosomeLength

#IFD functions
#  - IFD: currently I think just does 2CO bivalents 
#  - IFD.2: for mulitple IFDs (3CO ect.)  

#IFD.2 does mulitple IFDs (just absolute)
#Curated_BivData <- add_IFD.2(Curated_BivData)

Curated_BivData$PER_Foci_1 <- Curated_BivData$Foci1 / Curated_BivData$chromosomeLength
Curated_BivData$PER_Foci_2 <- Curated_BivData$Foci2 / Curated_BivData$chromosomeLength
Curated_BivData$PER_Foci_3 <- Curated_BivData$Foci3 / Curated_BivData$chromosomeLength
Curated_BivData$PER_Foci_4 <- Curated_BivData$Foci4 / Curated_BivData$chromosomeLength

Curated_BivData$PER_Foci_1 <- as.numeric(Curated_BivData$PER_Foci_1)
Curated_BivData$PER_Foci_2 <- as.numeric(Curated_BivData$PER_Foci_2)
Curated_BivData$PER_Foci_3 <- as.numeric(Curated_BivData$PER_Foci_3)
Curated_BivData$PER_Foci_4 <- as.numeric(Curated_BivData$PER_Foci_4)

#not working
Curated_BivData$dis.cent <- Curated_BivData$Foci1 - Curated_BivData$centromere_ABS_Position
Curated_BivData$dis.cent.PER  <- Curated_BivData$dis.cent / Curated_BivData$chromosomeLength


#add telomere.dist
Curated_BivData$telo_dist <- ifelse(grepl(1, Curated_BivData$hand.foci.count), (Curated_BivData$chromosomeLength - Curated_BivData$Foci1), 
                     ifelse(grepl(2, Curated_BivData$hand.foci.count), (Curated_BivData$chromosomeLength -  Curated_BivData$Foci2), 
                     ifelse(grepl(3, Curated_BivData$hand.foci.count), (Curated_BivData$chromosomeLength - Curated_BivData$Foci3),
                    ifelse(grepl(4, Curated_BivData$hand.foci.count), (Curated_BivData$chromosomeLength - Curated_BivData$Foci4),   0))) )
  

Curated_BivData$telo_dist_PER <- Curated_BivData$telo_dist / Curated_BivData$chromosomeLength

#sis.co.ten
Curated_BivData <- add_SisCoTen(Curated_BivData)

#add rec.group
#divide musc males into groups
Curated_BivData$Rec.group <- ifelse(grepl("PWD male", Curated_BivData$category), 1, 
                                  ifelse(grepl("MSM male", Curated_BivData$category), 1,
                                  ifelse(grepl("SKIVE male", Curated_BivData$category), 1,
                                           0)))

Curated_BivData$Rec.group.exclu <- ifelse(grepl("PWD male", Curated_BivData$category), 1, 
                                ifelse(grepl("MSM male", Curated_BivData$category), 1, 0))

```

Curated_BivData will be the master DF with most observations. DFs for mixed models and tests need to subsetted from this one.  


```{r no.Foci.Pos, echo=FALSE}

#no posittion
#just.SC.length <- Curated_BivData[is.na(Curated_BivData$Foci1),] #NAs not registering
just.SC.length <- Curated_BivData[(Curated_BivData$Foci1 == ""),]

#table(just.SC.length$category)

#decide what to do with these lines
#how will they be represented in Mat Methods?
```


```{r input.check,echo=FALSE}

#10jan18_13jan17_LEW_f1_sp1_14_rev_12  '?'


##calq the nromalized.siscoten, double check the negative values;  #13sep18_28jun18_MOLF_m1_sp1_18.1_rev_14, #27aug15_12jun15_WSB_m2_sp1_18_rev_18, #21nov17_16nov17_MSM_f3_sp1_3_rev_1

#foci.pass = 2  #5aug17_14jul17_MSM_f1_sp1_13_rev_3
#hand foci =0 but there is a foci position
#too high hand foci count

#check for mistakes that might have been made when inputing / curation process

#hand foci > 4
#foci pos > SC lengths
#negative PER.foci.pos

#it hink most (ALL) of these came from bug in my function (ugh)

#Curated_BivData <- add_IFD(Curated_BivData)
#negative.IFD <- Curated_BivData[which(Curated_BivData$IFD1_ABS < 0),]
#caught 2
#15mar16_16jan16_G_f1_sp1_4_rev
#27mar16_6mar16_G_m3_sp1_12_rev

#neg Nrm F1
#negative.IFD2 <- Curated_BivData[which(Curated_BivData$PER_Foci_1 < 0),]
#0 really?

```

Main files from this Script:  
  
  1. **Curated_BIVDATA**: cleaned up version of the passing, curated Bivalent measures  
  
  2.  **Foci_TRUE_Curated_Bivdata**: filterd version of the Curated_BivData file, but with only measures that have 'good' foci position information
  
  3. OG.Curate_FULL: original version of the Bivalent data (before 'failed' SC wiped away)  
  
  4. **MELT_ABS**: make melt version of foci positions for abs measuers
  
  5. CELL level table (full all mice) (use this to make long biv dataset)
  
  6. Long Biv Dataset

  7. mouse table (full all mice)
  
  8. **Strain DFs** for Het models (summary strain DFs and tables?)
  
  9. **Mouse.Table_BivData_4MM** Mouse level table for HetC mixed models

  9. **male Subsp DFs** for Polymorphism models **Male.poly.Mouse.Table_BivData_4MM**



```{r CLEAN.UP.1, echo=FALSE, include=FALSE}

#check for duplicates, and track them down
anyDuplicated(new.Curate.FULL$Obj.ID)  #5335, #3467

dup.curated <- new.Curate.FULL[duplicated(new.Curate.FULL$Obj.ID),] #784
dup.curated <- add_mouse(dup.curated)

#table(dup.curated$mouse)
#1mar15_PWD_m1

#which lines are duplicated
#lots of PWD_female duplicated -- probably how I put together the curated files

#new.Curate.FULL <- new.Curate.FULL.org[(new.Curate.FULL.org$SC.pass == 1 | new.Curate.FULL.org$SC.pass == 0),]
#new.Curate.FULL <- droplevels(new.Curate.FULL)

#new.Curate.FULL <- add_mouse(new.Curate.FULL)
#new.Curate.FULL <- add_category(new.Curate.FULL)

#pass.fail.table <- table(new.Curate.FULL$SC.pass, new.Curate.FULL$category)
#this outsput shows the relative ratios of pass to fail biv segmentation

```


```{r remove.mice, echo=FALSE, eval=FALSE}

#mice to remove from the Curated_BivData -- should be similar to the mice exclude from the MLH1 

#poor quality?

#reaxamine these mice for if they should be included in 
exclude_mice_list_MLH1 <- c("10mar15_WSB_m2", "8oct14_WSB_f1", "8oct14_WSB_f3", "18nov17_WSB_f5",
                  "8jun15_G_f3", "8jun15_G_f4",
                  "4jan17_LEW_f2",
                  "8oct14_PWD_f3", "1apr15_PWD_f2", "8oct14_PWD_f5",
                  "12sep16_MSM_f3","31aug16_MSM_m2",
                  "27oct18_MOLF_m3",
                  "26oct18_SKIVE_f1","26oct18_SKIVE_f2","26oct18_SKIVE_f3",
                  
#    Musc males
    "27aug18_CZECH_m1","8jun18_CZECH_m1",
               
   "3sep18_AST_m1",
              
    "3jul18_TOM_m1","3sep18_TOM_m1",
  

                "31jul17_HMI_m1","3sep18_HMI_m1","3sep18_HMI_m2",
                 "21aug17_SPI_f1", "30may18_SPIC_f1", "30oct17_SPIC_m1", "8jun18_SPIC_m2"
                  )
#REaxamine and rename to exclude mice_BivData


#Curated_BivData <- Curated_BivData[ ! Curated_BivData$mouse %in% exclude_mice_list, ]

exmice.Curated_BivData <- Curated_BivData[ Curated_BivData$mouse %in% exclude_mice_list, ]


#juvi males
#juvi.mice_DF <- AP_mouse_table_w.Ages[(AP_mouse_table_w.Ages$age.days < 15) & (AP_mouse_table_w.Ages$sex.y == "male"),]
#juvi.mice_DF <- juvi.mice[!(is.na(juvi.mice$mouse) | juvi.mice$mouse==""), ]

#old males

```


I'm considering removing the same mice from the MLH1 counts, from the BivData, but this might -- limit the comparisons -- might be too stict. IF foci are bright and clear, SC/bivalents intact -- include.

If it seems like primary reason for excluding is low cell number include bivalents

Pro remove:

- more similarity across data sets

Con remove:

- the reasons for poor quality of the exclude mice in above list, might be from 2-3 bad bivalents -- which are removed from the biv data during the curation process. 




## Strain specific BivData sets

Compile dataframes for both sexes of each strain.

```{r WSB.SC, echo=FALSE}
#make the dataset
WSB.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "WSB",]
#correct and remove, 26dec17_18nov17_WSB_f4_sp1_12_rev_28, 26dec17_18nov17_WSB_f4_sp1_12_rev_27
table(WSB.Bivalents.DF$sex, WSB.Bivalents.DF$hand.foci.count)

#plot the differences
wsb.ploty <- ggplot(WSB.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()
wsb.ploty

#make a table of the means and n ect
wsb.SC.table <- ddply(WSB.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats



```

```{r LEW.SC, echo=FALSE}
#make the dataset
LEW.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "LEW",]
table(LEW.Bivalents.DF$sex, LEW.Bivalents.DF$hand.foci.count)

#plot the differences
LEW.ploty <- ggplot(LEW.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

LEW.ploty
#remove the NAs


#make a table of the means and n ect
LEW.SC.table <- ddply(LEW.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats


```

```{r G.SC, echo=FALSE}
#make the dataset
G.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "G",]
table(G.Bivalents.DF$sex, G.Bivalents.DF$hand.foci.count)

#plot the differences
G.ploty <- ggplot(G.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

G.ploty
#remove the NAs


#make a table of the means and n ect
G.SC.table <- ddply(G.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats



```

```{r PWD.SC, echo=FALSE}
#make the dataset
PWD.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "PWD",]
table(PWD.Bivalents.DF$sex, PWD.Bivalents.DF$hand.foci.count)

#plot the differences
PWD.ploty <- ggplot(PWD.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

PWD.ploty
#remove the NAs


#make a table of the means and n ect
PWD.SC.table <- ddply(PWD.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats



```

```{r KAZ.SC, echo=FALSE}
#make the dataset
KAZ.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "KAZ",]
table(KAZ.Bivalents.DF$sex, KAZ.Bivalents.DF$hand.foci.count)

#plot the differences
KAZ.ploty <- ggplot(KAZ.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

KAZ.ploty
#remove the NAs


#make a table of the means and n ect
KAZ.SC.table <- ddply(KAZ.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats


```

```{r SKIVE.Sc, echo=FALSE}
#make the dataset
SKIVE.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "SKIVE",]
table(SKIVE.Bivalents.DF$sex, SKIVE.Bivalents.DF$hand.foci.count)

#plot the differences
SKIVE.ploty <- ggplot(SKIVE.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

SKIVE.ploty
#remove the NAs


#make a table of the means and n ect
SKIVE.SC.table <- ddply(SKIVE.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats



```

```{r MSM.SC, echo=FALSE}
#make the dataset
MSM.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "MSM",]
table(MSM.Bivalents.DF$sex, MSM.Bivalents.DF$hand.foci.count)

#plot the differences
MSM.ploty <- ggplot(MSM.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

MSM.ploty
#remove the NAs


#make a table of the means and n ect
MSM.SC.table <- ddply(MSM.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats


```

```{r MOLF.SC, eval=FALSE}
#make the dataset
MOLF.Bivalents.DF <- Curated_BivData[Curated_BivData$strain == "MOLF",]
table(MOLF.Bivalents.DF$sex, MOLF.Bivalents.DF$hand.foci.count)

#plot the differences
MOLF.ploty <- ggplot(MOLF.Bivalents.DF,  aes(y=chromosomeLength, x = sex, color= as.factor(hand.foci.count)))+geom_jitter()+ggtitle("")

MOLF.ploty
#remove the NAs


#make a table of the means and n ect
MOLF.SC.table <- ddply(MOLF.Bivalents.DF, c("sex"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)
#can I plot these stats


```


## Male specific BivData set

```{r male.sc.length.strain, echo=FALSE}

#these measure ect should be in the male - mouse 
#isolate all musc and male
Curated_BivData_male <- Curated_BivData[ (Curated_BivData$sex == "male") & (Curated_BivData$species == "M.musculus"),]

#make strain average table
SC.Length.male_table <- ddply(Curated_BivData_male, c("strain"), summarise,
                             mean_SC = mean(chromosomeLength),
                              n_SC = length(Obj.ID),
                   
                   mean.SC_0CO = mean(chromosomeLength[which(hand.foci.count == 0)], na.rm = TRUE),
                  n_0CO =  sum((hand.foci.count == 0), na.rm = TRUE ),
                 # CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                  
                   mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                    n_1CO = sum((hand.foci.count == 1), na.rm = TRUE),
                  
                   mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                   n_2CO = sum((hand.foci.count == 2), na.rm = TRUE),
                  
                  mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                  n_3CO = sum((hand.foci.count == 3), na.rm = TRUE)
                          
)

#add all the other calculations 


```


# Manual Whole Cell BivData

Cleaning and integrating the dataframes for manual measured data.

```{r whole.cell.manual.clean, echo=FALSE}
#compare and clean up whole cell measures

whole.cell.data_manual <- whole.cell.data_manual.OG[whole.cell.data_manual.OG$chrm.class != "XY",]

colnames(whole.cell.data_manual.OG)
#"return5"         "fileName"        "boxNumber"       "centromere"      "SC.length"  #    
 #[6] "rank"            "chrm.class"      "hand.foci.count" "F1"              "F2"    #         
#[11] "F3"              "notes"           "X"               "X.1"            
#remove, X, X.1
whole.cell.data_manual <- whole.cell.data_manual[-c(1, 13:14)]
whole.cell.data_manual$Foci4 <- ""

#rename cols to match BivData
whole.cell.data_manual$Foci1 <- whole.cell.data_manual$F1
whole.cell.data_manual$Foci2 <- whole.cell.data_manual$F2
whole.cell.data_manual$Foci3 <- whole.cell.data_manual$F3
whole.cell.data_manual$Foci4 <- whole.cell.data_manual$F4  #currently Foci4 is chr
whole.cell.data_manual$chromosomeLength <- whole.cell.data_manual$SC.length

whole.cell.data_manual$PER_Foci_1 <- whole.cell.data_manual$Foci1 / whole.cell.data_manual$chromosomeLength
whole.cell.data_manual$PER_Foci_2 <- whole.cell.data_manual$Foci2 / whole.cell.data_manual$chromosomeLength
whole.cell.data_manual$PER_Foci_3 <- whole.cell.data_manual$Foci3 / whole.cell.data_manual$chromosomeLength
#whole.cell.data_manual$PER_Foci_4 <- whole.cell.data_manual$Foci4 / whole.cell.data_manual$chromosomeLength

#mouse, strain, sex, category
whole.cell.data_manual <- add_mouse(whole.cell.data_manual)
whole.cell.data_manual <- add_category(whole.cell.data_manual)
whole.cell.data_manual <- add_strain(whole.cell.data_manual)
whole.cell.data_manual <- add_sex(whole.cell.data_manual)
whole.cell.data_manual <- add_subsp(whole.cell.data_manual)


#whole.cell.data_manual <-   whole.cell.data_manual[(!is.na(whole.cell.data_manual$fileName)),]
whole.cell.data_manual <- whole.cell.data_manual[!(is.na(whole.cell.data_manual$fileName) | whole.cell.data_manual$fileName==""), ]

#obj.id
whole.cell.data_manual$Obj.ID <- paste(whole.cell.data_manual$fileName, whole.cell.data_manual$boxNumber, sep = "_")

#add all the extra columns, blah
#percent Foci position

#ADD RANK
for(cellys in as.character(unique(whole.cell.data_manual$fileName))){
  
 # print(cellys)
  chrm.order = rank(whole.cell.data_manual$SC.length[whole.cell.data_manual$fileName == cellys])
  whole.cell.data_manual$rank[whole.cell.data_manual$fileName == cellys] <- chrm.order  
  }

#IFD 
whole.cell.data_manual <- add_IFD(whole.cell.data_manual)

#PER Foci
```

```{r clean.whole.cell_table, echo = FALSE, eval=FALSE}

#calq the mouse means
manual_summary_stats <- ddply(whole.cell.data_manual, c("fileName"), summarise,

                        mean_SC = as.numeric(format(round(  mean(SC.length, na.rm = TRUE), 3 ), nsmall=3) ),
                        median_SC = median(SC.length, na.rm = TRUE),
                        Qar.4 = quantile(SC.length, na.rm = TRUE)[[4]]
#                        var_SC = format(round(   as.numeric(var(SC.length)),3), nsmall=3)
                   
)

manual_summary_stats <- add_mouse(manual_summary_stats)
manual_summary_stats <- add_strain(manual_summary_stats)
manual_summary_stats <- add_sex(manual_summary_stats)
manual_summary_stats <- add_subsp(manual_summary_stats)


#CHECKED FOR MISSING bivs -- also check for wrong directions, ect

#negative IFD
#5aug17_14jul17_LEW_f1_sp1_11_rev_blob4

#PER foci positions greater th

#check the numbers of bivalents with a SC length, but no hand.foci.count


```



# Cell Level Table

- pass rate (don't need the OG.DF file, because I can count the number of boxes with the max index number)

- number bivs per mice?

- number cells represented per mouse

- number of pass.SC w/out foci position data

- number of foci with 'faint' mentioned in the notes


The below cell level table is used for making the **long.biv.dataset** and short, (any others?)

```{r cell.level.table, echo=FALSE}

cell.level.BivData_table <- ddply(.data=Curated_BivData, 
                       .(fileName),
                       summarize, 
                       boxs.IDd = max(boxNumber),
                       nboxes_passed = length(boxNumber),
                       
                       Nbiv = length(Obj.ID), #if there are na's below -- it breaks
                       CO0 =  sum(hand.foci.count == 0, na.rm=TRUE), 
                       CO1 =  sum(hand.foci.count == 1, na.rm=TRUE), 
                       CO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                       CO3 = sum(hand.foci.count == 3, na.rm=TRUE),
                       CO4 = sum(hand.foci.count == 4, na.rm=TRUE),
                       
                       ncells = length(unique(fileName)),
                       nbivs = length(unique(Obj.ID)),

                       mean.SC_length = mean(chromosomeLength, na.rm = TRUE),
                       var.SC_length = var(chromosomeLength),
                       sd.SC_length   = round(sd(chromosomeLength), 3),
                       se.SC_length   = round(sd.SC_length / sqrt(nbivs), 3), #check that nBivs is the right number
 
                       cv.SC = cv(chromosomeLength),
                       
#AutoSC = sum( SC.length[which(blobjectClass != "XY")] ),
                      mean.IFD_all = mean(   IFD1_ABS, na.rm = TRUE),

                #this below might not be correct
                     mean.IFD_2C0 = mean(   IFD1_ABS[which(hand.foci.count == 2)], na.rm = TRUE),
                     
                       var.IFD_2CO = var( IFD1_ABS[which(hand.foci.count == 2)], na.rm=TRUE),
                       #sd.IFD_2CO   = round(sd(IFD1, na.rm=TRUE), 3),
                       #se.IFD_2CO   = round(sd.IFD / sqrt(nbivs), 3)

#cent_dis
                      mean_cent_dist = mean(dis.cent, na.rm=TRUE),
                       Qar.4 = quantile(chromosomeLength, na.rm = TRUE)[[4]], #calq threshold for all cells, pull out 'almost.whole.cells' later
                      Qar.3 = quantile(chromosomeLength, na.rm = TRUE)[[3]],
                      Qar.2 = quantile(chromosomeLength, na.rm = TRUE)[[2]],
                      Qar.1 = quantile(chromosomeLength, na.rm = TRUE)[[1]]

                        )
                      
cell.level.BivData_table <- add_mouse(cell.level.BivData_table)
cell.level.BivData_table <- add_sex(cell.level.BivData_table)
cell.level.BivData_table <- add_strain(cell.level.BivData_table)
cell.level.BivData_table <- add_category(cell.level.BivData_table)

#as.data.frame( head(cell.level.BivData_table) )

#use quartille 2 as a min, on average it grabs 4 

```



```{r whole.cell_merging, echo=FALSE, eval=FALSE}
#I think this block is redundant, could delete

#check if there are fileNames
#double.filename <- whole.cell.data_manual[ whole.cell.data_manual$fileName %in% #Curated_BivData$fileName, ]

#which cell-levels fileNames have close to 15-17 chrms?
almost_whole_cell <- cell.level.BivData_table[(cell.level.BivData_table$Nbiv < 21),] #cut off cells with too many
almost_whole_cell <- almost_whole_cell[almost_whole_cell$Nbiv > 15,]

#there is some discrpancy with the Nbiv and nbivs columns! ugh why, some have 20 and 10

#get the Biv data 
almost_whole_cell_BivData <- Curated_BivData[ Curated_BivData$fileName %in% almost_whole_cell$fileName, ]

as.data.frame(  table( droplevels( almost_whole_cell_BivData$fileName) ) )
#length(unique(almost_whole_cell_BivData$fileName))

#what is almost whole cell BivData used for...
```


3 cells have manual measures and BivData measures. test error, need to match them up. There are 145 cells from the BivData set which are close to whole cells.  
8jun15_23apr15_PWD_f2_sp1_20_rev, 29nov16_13nov16_MSM_m2_sp1_13_rev, 27oct16_31aug16_MSM_m1_sp1_9_rev


# Long and Short BivData Set

I want to make a dataset of 'longest' 25% chromosomes from cells with at least 16 segmented bivalents from a single cell. 


```{r long.chrm.dataset, echo=FALSE}

#1. Isolate bivalent measrues from 'almost whole cells'   (how many biv's are from cells with >15 bivalents)
over_15_biv_cell_DF <- cell.level.BivData_table[cell.level.BivData_table$Nbiv >15, ]
BivData_from_15biv_cells <- Curated_BivData[ Curated_BivData$fileName %in% over_15_biv_cell_DF$fileName, ]

#check for blank obj.id
BivData_from_15biv_cells$Obj.ID <- paste(BivData_from_15biv_cells$fileName, BivData_from_15biv_cells$boxNumber, sep = "_")

#check for dup
#length(duplicated(BivData_from_15biv_cells$Obj.ID))#2605
#anyDuplicated(BivData_from_15biv_cells$Obj.ID)#1997
dups.dummy <- BivData_from_15biv_cells[duplicated(BivData_from_15biv_cells$Obj.ID),]
#Dups -- 50, all from 1mar15_PWD_m1

#remove duplicate obj.ids
BivData_from_15biv_cells <- BivData_from_15biv_cells %>% distinct() #distinct doesn't work for chr type
BivData_from_15biv_cells <- BivData_from_15biv_cells[ ! BivData_from_15biv_cells$fileName %in% dups.dummy$fileName, ]

#make sure obj.id and fileName are charcter for studd below
BivData_from_15biv_cells$fileName <- as.character(BivData_from_15biv_cells$fileName)
BivData_from_15biv_cells$Obj.ID <- as.character(BivData_from_15biv_cells$Obj.ID)

#what are the Biv_Data_mean_table ... ? old version of cell table..
#replacing Biv_Data_mea_table with... cell.level.BivData_table

missing_from_cell_table <- BivData_from_15biv_cells[!BivData_from_15biv_cells$fileName %in% cell.level.BivData_table$fileName, ] 
#all these files stem from

#these are bivalents which don't appear the in cell level table, which can break the loop
BivData_from_15biv_cells <- BivData_from_15biv_cells[ ! BivData_from_15biv_cells$fileName %in% missing_from_cell_table$fileName, ]
#final cleaned BivData table, 2428

#2. calq the Q4 threshold
#loop for greping the mouse from file name ect

#mini.now  <- BivData_from_15biv_cells[1:300,]

for(  i in 1:length( unique(BivData_from_15biv_cells$Obj.ID) ) ){
  

  newfile.str = strsplit( BivData_from_15biv_cells$Obj.ID[i], "_" )[[1]][1:7]
  new.egg <- paste0(newfile.str, collapse = "_")
  
  the.Q4 <- cell.level.BivData_table$Qar.4[ which( grepl(new.egg, cell.level.BivData_table$fileName ) )]
  
  the.Q3 <-cell.level.BivData_table$Qar.3[ which( grepl(new.egg, cell.level.BivData_table$fileName ) )]
  
  the.Q2 <-cell.level.BivData_table$Qar.2[ which( grepl(new.egg, cell.level.BivData_table$fileName ) )]
  
  the.Q1 <-cell.level.BivData_table$Qar.1[ which( grepl(new.egg, cell.level.BivData_table$fileName ) )]
  
  BivData_from_15biv_cells$cell.Q4[i] <- the.Q4
    BivData_from_15biv_cells$cell.Q3[i] <- the.Q3
  BivData_from_15biv_cells$cell.Q2[i] <- the.Q2
  BivData_from_15biv_cells$cell.Q1[i] <- the.Q1
    
  the.FN <- as.character(cell.level.BivData_table$fileName[which(grepl(new.egg, cell.level.BivData_table$fileName ) )] )
  
  BivData_from_15biv_cells$Q4.FN[i] <- as.character(the.FN)
  BivData_from_15biv_cells$Q1.FN[i] <- as.character(the.FN)
}

#3.mark which bivalents are above the threshold

BivData_from_15biv_cells$long.Biv <- ifelse( (BivData_from_15biv_cells$chromosomeLength >= as.numeric(BivData_from_15biv_cells$cell.Q4)  ), "yes", "no" )

real.long.bivData <- BivData_from_15biv_cells[BivData_from_15biv_cells$long.Biv == "yes",]#713 observations


#isolate the short bivdata
BivData_from_15biv_cells$short.Biv <- ifelse( (BivData_from_15biv_cells$chromosomeLength <= as.numeric(BivData_from_15biv_cells$cell.Q2)  ), "yes", "no" )

real.short.bivData <- BivData_from_15biv_cells[BivData_from_15biv_cells$short.Biv == "yes",]# 708 much few than 

```


```{r short.biv.data, echo=FALSE, include=FALSE, eval=FALSE}

#notes for short biv

mini_G.15_15biv_FN <- BivData_from_15biv_cells %>% filter(category == "G male")
#ploting short biv data
G.15_15biv_male <- BivData_from_15biv_cells %>% filter(category == "G male")
mini_G.15_15biv_FN <- sample( G.15_15biv_male$fileName, 10)
mini_G.15_15biv  <- BivData_from_15biv_cells[BivData_from_15biv_cells$fileName %in% mini_G.15_15biv_FN, ] 


ppll <- ggplot(mini_G.15_15biv, aes(x = fileName, y=chromosomeLength, color=mouse))+geom_jitter()+facet_wrap(~fileName, scales="free")+ theme(legend.position="none")+
  geom_hline(aes(yintercept= cell.Q1), color='coral') + 
  geom_hline(aes(yintercept= cell.Q2), color='red') +
 geom_hline(aes(yintercept= cell.Q3), color='blue') +   ##actually Q3 might not be a real thing...
 geom_hline(aes(yintercept= cell.Q4), color='black')  

  #this plot shows that the Q1 is capturing only single values -- I should try Q2
#use Q2 as a 
```


The above blocks of code 1) isolates bivalents measures from cells with >15 segmented bivalents 2) for the cells in these data calculates the Q4 threshold and 3) marks which bivalents are longer than the threshold.


```{r table.long.biv, echo=FALSE}

# make a table for the Mixed Models -- from the long.BivData
# Calq mouse averages

#add in all the other stats there are in the other tables

Long.biv_mouse_table <- ddply(real.long.bivData, c("mouse"), summarise,
                        
                        Nmice = length(unique(mouse)),
                        Ncells  = length(Obj.ID),
                      
                          mean_SC = as.numeric(format(round(  mean(chromosomeLength), 3 ), nsmall=3) ),
                      
                        cV = cv(chromosomeLength),
                        var = as.numeric(format(round(   var(chromosomeLength),3), nsmall=3) ),
                        sd   = round(sd(chromosomeLength), 3),
                        se   = round(sd / sqrt(Ncells), 3),
                        
                        #SC lengths by class
                        nCO0 =  sum(hand.foci.count == 0, na.rm=TRUE), 
                      nCO1 =  sum(hand.foci.count == 1, na.rm=TRUE), 
                       nCO2 = sum(hand.foci.count == 2, na.rm=TRUE),
                       nCO3 = sum(hand.foci.count == 3, na.rm=TRUE),
                       nCO4 = sum(hand.foci.count == 4, na.rm=TRUE),
                       
                      mean.siscoten_0CO = mean(SisCoTen[which(hand.foci.count == 0)], na.rm = TRUE),
                      mean.siscoten_1CO = mean(SisCoTen[which(hand.foci.count == 1)], na.rm = TRUE),
                     mean.siscoten_2CO = mean(SisCoTen[which(hand.foci.count == 2)], na.rm = TRUE),
                      mean.siscoten_3CO = mean(SisCoTen[which(hand.foci.count == 3)], na.rm = TRUE),
                      
                #  mean_IFD_ABS = as.numeric(format(round(  mean(IFD1_ABS, na.rm = TRUE), 3 ), nsmall=3) ),
                # mean_IFD_PER = as.numeric(format(round(  mean(IFD1_PER, na.rm = TRUE), 3 ), nsmall=3) ),
                 
                 mean_IFD.2CO_ABS = mean(IFD1_ABS[which(hand.foci.count == 2)], na.rm = TRUE),
                 mean_IFD.2CO_PER = mean(IFD1_PER[which(hand.foci.count == 2)], na.rm = TRUE),
                  
                       #CO position things, requires the melt?
              norm.first.foci.pos =  mean(PER_Foci_1[which(hand.foci.count == 1)])
                  
        #          mean_siscoten = mean(siscoten)
        #
)
#mouse averages for long.biv

Long.biv_mouse_table <- add_sex(Long.biv_mouse_table)
Long.biv_mouse_table <- add_strain(Long.biv_mouse_table)
Long.biv_mouse_table <- add_subsp(Long.biv_mouse_table)
Long.biv_mouse_table <- add_category(Long.biv_mouse_table)

#unordered for the mixed models (move this to the MM blocks...?)
Long.biv_mouse_table$subsp <- factor(Long.biv_mouse_table$subsp, ordered = FALSE)
Long.biv_mouse_table$sex <- factor(Long.biv_mouse_table$sex, ordered = FALSE)
Long.biv_mouse_table$strain <- factor(Long.biv_mouse_table$strain, ordered = FALSE)

#rec group
Long.biv_mouse_table$Rec.group <- ifelse(grepl("PWD", Long.biv_mouse_table$category), 1, 
                            ifelse(grepl("MSM", Long.biv_mouse_table$category), 1,
                             ifelse(grepl("SKIVE", Long.biv_mouse_table$category), 1, 0)) )

#long.biv. 1) HetC  2) male.poly (the main factors are still unordered)

#1) Long Biv for 
#remove all the non-used strains!!
Long.biv_mouse_table_HetC <- Long.biv_mouse_table

Long.biv_mouse_table_HetC <- Long.biv_mouse_table_HetC[Long.biv_mouse_table$strain != "AST",]
Long.biv_mouse_table_HetC <- Long.biv_mouse_table_HetC[Curated_BivData$strain != "TOM",]
Long.biv_mouse_table_HetC <- Long.biv_mouse_table_HetC[Long.biv_mouse_table_HetC$strain != "CZECH",]
Long.biv_mouse_table_HetC$strain <- droplevels(Long.biv_mouse_table_HetC$strain)

#remove na's
Long.biv_mouse_table_HetC <- Long.biv_mouse_table_HetC[!(is.na(Long.biv_mouse_table_HetC$mouse) | Long.biv_mouse_table_HetC$mouse==""), ]

#table(droplevels( Long.biv_mouse_table_HetC$category) )  #for double checking



#2) Long Biv for male.poly
#just males, just Musculus
Long.biv_mouse_table_male.poly <- Long.biv_mouse_table

Long.biv_mouse_table_male.poly <- Long.biv_mouse_table_male.poly[Long.biv_mouse_table_male.poly$sex == "male",]

#table(droplevels( Long.biv_mouse_table_male.poly$category) ) #for double checking
```

The above code chunk makes 2 mouse level tables; **Long.biv_mouse_table_HetC** and **Long.biv_mouse_table_male.poly**. Run these through the model systems.


# Mouse Level Tables

Mouse level tables are the main meat of the models. There will be several for use in different models. Format these tables for run the mixed models (unordered factors, ect).


```{r FULL.mouse.table, echo=FALSE}

#remove bivalent entries without hand foci count values


cleanCurated_BivData <-  Curated_BivData  %>%  filter(hand.foci.count  == 0 | hand.foci.count  == 1 |
                                      hand.foci.count  == 2 | hand.foci.count  == 3 | hand.foci.count  == 4 )

mouse.level.BivData_table <- ddply(.data=cleanCurated_BivData, 
                       .(mouse),
                       summarize, 
                       
                       ncells = length(unique(fileName)),
                       
                       boxs.IDd = max(boxNumber),  #
                       nboxes_passed = length(boxNumber),
                       
                       Nbiv = length(Obj.ID), #if there are na's below -- it breaks
                     
                      tot.biv = length( !is.na(hand.foci.count) ),
                       
                       n0CO = sum( (hand.foci.count == 0), na.rm = TRUE ),
                      n1CO = sum( (hand.foci.count == 1), na.rm = TRUE ),
                      n2CO = sum( (hand.foci.count == 2), na.rm = TRUE ),
                      n3CO = sum( (hand.foci.count == 3), na.rm = TRUE ),
                      n4CO = sum(hand.foci.count == 4, na.rm=TRUE),

                       mean.SC_length = mean(chromosomeLength, na.rm = TRUE),
                       var.SC_length = var(chromosomeLength, na.rm = TRUE),
                       sd.SC_length   = round(sd(chromosomeLength), 3),
                       se.SC_length   = round(sd.SC_length / sqrt(Nbiv), 3),
                       
                       #sis.co.ten
                       mean.sis.co.ten = mean(SisCoTen, na.rm = TRUE)
)   


mouse.level.BivData_table <- add_sex(mouse.level.BivData_table)
mouse.level.BivData_table <- add_strain(mouse.level.BivData_table)
mouse.level.BivData_table <- add_subsp(mouse.level.BivData_table)
mouse.level.BivData_table <- add_category(mouse.level.BivData_table)

#unordered for the mixed models (move this to the MM blocks...?)
mouse.level.BivData_table$subsp <- factor(mouse.level.BivData_table$subsp, ordered = FALSE)
mouse.level.BivData_table$sex <- factor(mouse.level.BivData_table$sex, ordered = FALSE)
mouse.level.BivData_table$strain <- factor(mouse.level.BivData_table$strain, ordered = FALSE)


mouse.level.BivData_table$Rec.group <- ifelse(grepl("PWD male", mouse.level.BivData_table$category), 1, 
                              ifelse(grepl("MSM male", mouse.level.BivData_table$category), 1,
                                 ifelse(grepl("SKIVE male", mouse.level.BivData_table$category), 1, 0)))
```


```{r mouse.table.HetC.MM, echo=FALSE}

#this mouse level table -- should not have strains without female obs
#only Mmusculus

Mouse.Table_BivData_4MM <- ddply(Curated_BivData, c("mouse"), summarise,
                        Nmice = length(unique(mouse)),
                        Ncells  = length(  unique(fileName) ),
                      tot.biv = length(Obj.ID),
            
                      n0CO = sum( (hand.foci.count == 0), na.rm = TRUE ),
                      n1CO = sum( (hand.foci.count == 1), na.rm = TRUE ),
                      n2CO = sum( (hand.foci.count == 2), na.rm = TRUE ),
                      n3CO = sum( (hand.foci.count == 3), na.rm = TRUE ),
                        
                        mean_SC = as.numeric(format(round(  mean(chromosomeLength), 3 ), nsmall=3) ),
                        cV = cv(chromosomeLength),
                        var = as.numeric(format(round(   var(chromosomeLength),3), nsmall=3) ),
                        sd   = round(sd(chromosomeLength), 3),
                        se   = round(sd / sqrt(Ncells), 3),
                       
                       #calq mean.sc by chrm class
                       mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                       mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                       mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                       mean.SC_4CO = mean(chromosomeLength[which(hand.foci.count == 4)], na.rm = TRUE),
                       
                # IFD things
                #  mean_IFD_ABS = as.numeric(format(round(  mean(IFD1_ABS, na.rm = TRUE), 3 ), nsmall=3) ),
                # mean_IFD_PER = as.numeric(format(round(  mean(IFD1_PER, na.rm = TRUE), 3 ), nsmall=3) ),
                 
                 mean_IFD.2CO_ABS = mean(IFD1_ABS[which(hand.foci.count == 2)], na.rm = TRUE),
                 mean_IFD.2CO_PER = mean(IFD1_PER[which(hand.foci.count == 2)], na.rm = TRUE),
                  
                       #CO position things, requires the melt?
              norm.first.foci.pos =  mean(PER_Foci_1[which(hand.foci.count == 1)]),
                  
              #sis.co.ten!!
              mean.siscoten = mean(SisCoTen, na.rm=TRUE),
              
              mean.siscoten_1CO = mean(SisCoTen[which(hand.foci.count == 1)], na.rm = TRUE),
              mean.siscoten_2CO = mean(SisCoTen[which(hand.foci.count == 2)], na.rm = TRUE),
              mean.siscoten_3CO = mean(SisCoTen[which(hand.foci.count == 3)], na.rm = TRUE),
              
              mean.telo.dist = mean(telo_dist, na.rm=TRUE),
              mean.cent.dist = mean(dis.cent, na.rm=TRUE)
)

#
Mouse.Table_BivData_4MM <- add_sex(Mouse.Table_BivData_4MM)
Mouse.Table_BivData_4MM <- add_strain(Mouse.Table_BivData_4MM)
Mouse.Table_BivData_4MM <- add_subsp(Mouse.Table_BivData_4MM)
Mouse.Table_BivData_4MM <- add_category(Mouse.Table_BivData_4MM)

#unordered for the mixed models (move this to the MM blocks...?)
Mouse.Table_BivData_4MM$subsp <- factor(Mouse.Table_BivData_4MM$subsp, ordered = FALSE)
Mouse.Table_BivData_4MM$sex <- factor(Mouse.Table_BivData_4MM$sex, ordered = FALSE)
Mouse.Table_BivData_4MM$strain <- factor(Mouse.Table_BivData_4MM$strain, ordered = FALSE)

#remove all the non-used strains!!

Mouse.Table_BivData_4MM <-  Mouse.Table_BivData_4MM %>%  filter(strain != "AST")  %>% filter(strain != "TOM")  %>% filter(strain != "CZECH")


#Mouse.Table_BivData_4MM$strain <- droplevels(Mouse.Table_BivData_4MM$strain)
#Mouse.Table_BivData_4MM <- Mouse.Table_BivData_4MM[(!is.na(Mouse.Table_BivData_4MM$mouse)),] #so many NAs still 

Mouse.Table_BivData_4MM$Rec.group <- ifelse(grepl("PWD male", Mouse.Table_BivData_4MM$category), 1, 
                              ifelse(grepl("MSM male", Mouse.Table_BivData_4MM$category), 1,
                                 ifelse(grepl("SKIVE male", Mouse.Table_BivData_4MM$category), 1, 0)))

```


```{r mouse.table.Male.Poly, echo=FALSE}

#this table will have male BivData
#it will include Musc strains

Curated_BivData_male <- Curated_BivData[Curated_BivData$sex == "male",]

Male.poly.Mouse.Table_BivData_4MM <- ddply(Curated_BivData_male, c("mouse"), summarise,
                        Nmice = length(unique(mouse)),
                        Ncells  = length(Obj.ID),
                       
                      # mean_CO = mean()
                       
                        mean_SC = as.numeric(format(round(  mean(chromosomeLength), 3 ), nsmall=3) ),
                        cV = cv(chromosomeLength),
                        var = as.numeric(format(round(   var(chromosomeLength),3), nsmall=3) ),
                        sd   = round(sd(chromosomeLength), 3),
                        se   = round(sd / sqrt(Ncells), 3),
                       
                      n0CO = sum( (hand.foci.count == 0), na.rm = TRUE ),
                      n1CO = sum( (hand.foci.count == 1), na.rm = TRUE ),
                      n2CO = sum( (hand.foci.count == 2), na.rm = TRUE ),
                      n3CO = sum( (hand.foci.count == 3), na.rm = TRUE ),
                      
                       #calq mean.sc by chrm class
                       mean.SC_1CO = mean(chromosomeLength[which(hand.foci.count == 1)], na.rm = TRUE),
                       mean.SC_2CO = mean(chromosomeLength[which(hand.foci.count == 2)], na.rm = TRUE),
                       mean.SC_3CO = mean(chromosomeLength[which(hand.foci.count == 3)], na.rm = TRUE),
                       mean.SC_4CO = mean(chromosomeLength[which(hand.foci.count == 4)], na.rm = TRUE),
                       
                # IFD things
                #  mean_IFD_ABS = as.numeric(format(round(  mean(IFD1_ABS, na.rm = TRUE), 3 ), nsmall=3) ),
                # mean_IFD_PER = as.numeric(format(round(  mean(IFD1_PER, na.rm = TRUE), 3 ), nsmall=3) ),
                 
                 mean_IFD.2CO_ABS = mean(IFD1_ABS[which(hand.foci.count == 2)], na.rm = TRUE),
                 mean_IFD.2CO_PER = mean(IFD1_PER[which(hand.foci.count == 2)], na.rm = TRUE),
                  
                       #CO position things, requires the melt?
              norm.first.foci.pos =  mean(PER_Foci_1[which(hand.foci.count == 1)]),
                  
              #sis.co.ten!!
              mean.siscoten = mean(SisCoTen, na.rm=TRUE),
              
              mean.siscoten_1CO = mean(SisCoTen[which(hand.foci.count == 1)], na.rm = TRUE),
              mean.siscoten_2CO = mean(SisCoTen[which(hand.foci.count == 2)], na.rm = TRUE),
              mean.siscoten_3CO = mean(SisCoTen[which(hand.foci.count == 3)], na.rm = TRUE),
              
              mean.telo.dist = mean(telo_dist, na.rm=TRUE),
              mean.cent.dist = mean(dis.cent, na.rm=TRUE)
)

Male.poly.Mouse.Table_BivData_4MM <- add_sex(Male.poly.Mouse.Table_BivData_4MM)
Male.poly.Mouse.Table_BivData_4MM <- add_strain(Male.poly.Mouse.Table_BivData_4MM)
Male.poly.Mouse.Table_BivData_4MM <- add_subsp(Male.poly.Mouse.Table_BivData_4MM)
Male.poly.Mouse.Table_BivData_4MM <- add_category(Male.poly.Mouse.Table_BivData_4MM)

#unordered for the mixed models (move this to the MM blocks...?)
Male.poly.Mouse.Table_BivData_4MM$subsp <- factor(Male.poly.Mouse.Table_BivData_4MM$subsp, ordered = FALSE)
Male.poly.Mouse.Table_BivData_4MM$sex <- factor(Male.poly.Mouse.Table_BivData_4MM$sex, ordered = FALSE)
Male.poly.Mouse.Table_BivData_4MM$strain <- factor(Male.poly.Mouse.Table_BivData_4MM$strain, ordered = FALSE)

#remove females
Male.poly.Mouse.Table_BivData_4MM$sex <- droplevels(Male.poly.Mouse.Table_BivData_4MM$sex)

```


```{r Q1Q2.mouse.table, echo=FALSE}

#How Do I apply quality score things to BivData?
#make the same table but 


```

analysis using the mouse level table -- to justify that using mouse averages is a good idea.



# Melt Position Table

The BivData MELT DF is primarily for the nrmF1.pos plots/analysis. It is a Melted DF for raw and normalized foci positions from the Curated_BivData. 

```{r MELT.block1, echo=FALSE}

col.names.list <- colnames(Curated_BivData)
#"fileName" ,  "chromosomeLength",        "centromere_ABS_Position", "centromere_PER_Position",
#"boxNumber",               "Obj.ID",                  "SC.pass",                 "foci.pass",              
#"curated.1pass.0fail",     "curation.notes",          "hand.foci.count",        "Foci1",                  
#"Foci2",       "Foci3",                "notes",                 "mouse",                  
#"category",                "strain",                  "sex",                    "subsp",                  
#"IFD1_ABS",                "IFD1_PER",               

#all of the cols to use
MELT_Curated_BivData <- melt(Curated_BivData[,c("fileName","chromosomeLength","centromere_ABS_Position","centromere_PER_Position",  "boxNumber", "Obj.ID", "SC.pass","foci.pass",              
              "curated.1pass.0fail","curation.notes", "hand.foci.count","notes", "mouse",
              #leave out the Foci
                "Foci1","Foci2","Foci3", "Foci4")], 
                 
            id=c("fileName","chromosomeLength","centromere_ABS_Position","centromere_PER_Position",
                    "boxNumber", "Obj.ID", "SC.pass","foci.pass",              
              "curated.1pass.0fail","curation.notes", "hand.foci.count","notes", "mouse"))

MELT_Curated_BivData <- MELT_Curated_BivData[(!is.na(MELT_Curated_BivData$value)),]

#MELT, -- 15
colnames(MELT_Curated_BivData) <- c(col.names.list[c(1:11, 16:17)], "Foci_Type", "Pos") #too many foci

MELT_Curated_BivData$Pos <- as.numeric(MELT_Curated_BivData$Pos)


#calq normalized melt pos
MELT_Curated_BivData$PER.Foci.Pos <- MELT_Curated_BivData$Pos / MELT_Curated_BivData$chromosomeLength

MELT_Curated_BivData <- MELT_Curated_BivData[(!is.na(MELT_Curated_BivData$Pos)),]
```


# Assemble Final BivData DF

Main files from this Script:  
  
  1. **Curated_BIVDATA**: cleaned up version of the passing, curated Bivalent measures  
  
  2.  **Foci_TRUE_Curated_Bivdata**: filterd version of the Curated_BivData file, but with only measures that have 'good' foci position information
  
  3. OG.Curate_FULL: original version of the Bivalent data (before 'failed' SC wiped away)  
  
  4. **MELT_ABS**: make melt version of foci positions for abs measuers
  
  5. CELL level table (full all mice) (use this to make long biv dataset)
  
  6. Long Biv Dataset

  7. mouse table (full/all mice)
  
  8. **Strain DFs** for Het models **Mouse.Table_BivData_4MM**
  
  9. **male Subsp DFs** for Polymorphism models **Male.poly.Mouse.Table_BivData_4MM**



MAIN BIVDATA_DF
decide on the colnames that I want for the final DF

fileName, Object_ID, box.number, centromere_ABS, centromere_PER
chromosome length, SC.pass, Foci.pass, hand.foci.count, 
F1, F2, F3, F4, F1_per, F2_per, F3_per, F4_per, IFD

telomere_dist, cent_dist, 

mouse, strain, category, subsp, 

merge:
cell.MLH1.count, cell.quality, mouse.age, 
cell.total_skel, cell.total_binary



# Save


```{r save.file}

#save Rdata
save.image("~./MLH1repo/data/CleanBivData_19.2.20.RData")
#save.image("data/BivData_4_PCA.RData")

```



# Analysis

planned analyses for later docs, but this is the list for getting everything ready

Use the Bivalent_Analysis.Rmd for analysis pieces
BivPattern.Rmd started to analyze this but, not a very clear setup


-chrom class proportions

-SC lengths, by CO number


<!--
trash / junk

Plots  

1. Histograms of N.bivs per cell, facet category  

2. Number of images per mouse, number of biavlents per mouse (not sure what kinda of plot for this)

3. 

Is there a way to check my assumptions for these measues?  

What are the sources of error fot these data?


#Apply the cleaning steps below to the FULL-OG DF

#remove non number charaecters for the FULL / OG DF
#Curated_BivData <- Curated_BivData[ !grepl("[?]", Curated_BivData$SC.pass) , ]
#Curated_BivData <- Curated_BivData[ !grepl("[?]", Curated_BivData$hand.foci.count) , ]

#remove data which has paint marks
#P_fileNames <- Curated_BivData$fileName[(grep('p_rev', Curated_BivData$fileName))]
#length(P_fileNames)

#remove anything with 'DUPLICATE'
#DUP_list <- Curated_BivData$fileName[(grep('DUP', Curated_BivData$fileName))]
#DUP_num = length(DUP_list)#0


#dup_list= c()
#for(i in Curated_BivData$fileName){  #change the file name header,  
#  # print(i)
#  ifelse(grepl("\\.[0-9]_rev", i),
#         (dup_list = c(dup_list, i)), NA)
#}
#MultiCells = c()
#for(j in dup_list){
#  stringLIST = strsplit(j, split="\\.")[[1]]
#  new_string = paste(stringLIST[[1]][1], "rev", sep="_")
#  MultiCells = c(MultiCells, new_string)
#}
#MultiCells = unique(MultiCells)
#multi_cell_num = length(MultiCells)#118

#new.Curate.FULL$Obj.ID <- paste(new.Curate.FULL$fileName, new.Curate.FULL$boxNumber, sep = "_")
#colnames(new.Curate.FULL)

```{r clean.data, echo=FALSE, eval=FALSE}
#Keep these biv data for the male polymorphism version

#Curated_BivData <- Curated_BivData[Curated_BivData$strain != "AST",]
#Curated_BivData <- Curated_BivData[Curated_BivData$strain != "TOM",]
#Curated_BivData <- Curated_BivData[Curated_BivData$strain != "CZECH",]

#Curated_BivData$strain <- droplevels(Curated_BivData$strain)
```

```{r telo.cent_dist, echo=FALSE, eval=FALSE}

#code for cal1 the telomere distance
#space between last foci and telomere end

#telo_dist <- if(hand.foci = 1){
          #SC.Length - F1
#}
#elseif(hand_foci == 2){ #SC.length - F2}


#code for centromere
#space between first foci and centromere/centromere-end

#cent_end_dist
#cent_dist
```

-->