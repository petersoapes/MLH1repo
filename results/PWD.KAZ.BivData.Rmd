---
title: "PWD.KAZ"
author: "April Peterson"
date: "June 4, 2019"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(plyr)
library(ggplot2)

setwd("~./MLH1repo/")
#load BivData
#load(file="~./MLH1repo/data/MLH1_BivData.RData")

#load MLH1 data
#setwd("C:/Users/April/Desktop/MLH1repo/") #don't have two
load(file="~./MLH1repo/data/MLH1/MLH1_data_setup_62419.RData")
#MLH1_data_setup_62419.RData
#KAZ_male_data = read.csv("~./data/KAZ_BivData.csv")
meta.data.file2 = read.csv("~./MLH1repo/data/Mouse_MetaData_6.12.19.csv", header = TRUE)

#1. Curated Data
#PWD set 4 mice, ~100 objs each)
PWD_curate_BivData.full =
  read.csv("~./MLH1repo/data/BivData/Merged_Curate_PWD_BivData.csv", header = TRUE)
#remove bad segmentation
PWD_curate_BivData <- PWD_curate_BivData.full[PWD_curate_BivData.full$SC.pass == 1,]

#KAZ 3 mice >200 objs each
KAZ_curate_BivData.full =
  read.csv("~./MLH1repo/data/BivData/curate_KAZ_BivData.csv", header = TRUE)
KAZ_curate_BivData <- KAZ_curate_BivData.full[KAZ_curate_BivData.full$SC.pass == 1,]

#merged KAZ and PWD
curate_BivData <- rbind(KAZ_curate_BivData, PWD_curate_BivData)


#2. Hand measures (merge first, then add extra cols)
PWD_hand_measure_BivData =
  read.csv("~./MLH1repo/data/BivData/PWD_male_hand_measures.csv", header = TRUE)

KAZ_hand_measure_BivData =
  read.csv("~./MLH1repo/data/BivData/KAZ_male_hand_measures.csv", header = TRUE)

#merge together -- check that the colnames match!!
HandMeasures_BivData <- rbind(KAZ_hand_measure_BivData, PWD_hand_measure_BivData)

#remove extra empty rows
HandMeasures_BivData <- HandMeasures_BivData[!(is.na(HandMeasures_BivData$fileName) | HandMeasures_BivData$fileName == ""), ]

#add Obj.ID
HandMeasures_BivData$Obj.ID <- paste(HandMeasures_BivData$fileName, HandMeasures_BivData$boxNumber, sep = "_")
#add centromere_PER (match auto)
HandMeasures_BivData$centromere_PER_Position <- HandMeasures_BivData$centromere_ABS_Position / HandMeasures_BivData$chromosomeLength

#more columns to match Auto DFs
HandMeasures_BivData$SC.pass <- "1"
HandMeasures_BivData$foci.pass <- "1"
HandMeasures_BivData$curated.1pass.0fail. <- ""

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
HandMeasures_BivData <- add_mouse(HandMeasures_BivData)
HandMeasures_BivData <- add_category(HandMeasures_BivData)
HandMeasures_BivData <- add_strain(HandMeasures_BivData)
HandMeasures_BivData <- add_sex(HandMeasures_BivData)

#make indevidal DFs by strain just in case...
PWD.BivData.Hand_measures <- HandMeasures_BivData[HandMeasures_BivData$strain == "PWD",]
KAZ.BivData.Hand_measures <- HandMeasures_BivData[HandMeasures_BivData$strain == "KAZ",]


```



```{r Merge.manual.auto, echo=FALSE}

#merge with the both strain DF
#curate_BivData ... HandMeasures_BivData


#.1 match the colnames,  #merge, partial match
#colnames(PWD_curate_BivData)
#colnames(PWD_hand_measure_BivData.full)

#merg4.PWD_curate_BivData <-    #remove "avergeRED", numberCrossOvers
#merg4.PWD_hand_measure_BivData.full <- #manual.blobject.name

#auto.curate
auto.c_names <- c("fileName","centromere_ABS_Position","centromere_PER_Position",  "chromosomeLength","boxNumber","Obj.ID","SC.pass","foci.pass","curated.1pass.0fail.","curation.notes","hand.foci.count","Foci1","Foci2","Foci3" ,"mouse", "strain","sex","category")
new.DF <- curate_BivData[ , auto.c_names, drop = TRUE]
  
#manual
manual_names <- c("fileName","chromosomeLength","centromere_ABS_Position","boxNumber","Obj.ID","Foci1","Foci2","Foci3","centromere_PER_Position","SC.pass","foci.pass","curated.1pass.0fail.", "mouse", "category","strain","sex","curation.notes", "hand.foci.count")
new.DF2 <- HandMeasures_BivData[ , manual_names, drop = TRUE]

#Merge the 2 DFs
Auto.Man_BivData <- rbind(new.DF, new.DF2)


#make WHOLE CELL DF

#some cleanup may be required for the manual data; remove all XY, mark chrm classes for all 
#make better variable name
Auto.Man_BivData_cells <- ddply(Auto.Man_BivData, c("fileName"), summarise,
                    number = length(Obj.ID),
                    #make the rank or
                     maxChrm_length = max(chromosomeLength),
                    maxChrm_boxNumber = boxNumber[which.max(chromosomeLength)]
                    
)

#Isolate cells with all (19) autosomes measured
whole.cell_table <- Auto.Man_BivData_cells[Auto.Man_BivData_cells$number > 17,]
whole.cell_table <- whole.cell_table[whole.cell_table$number < 21,]
whole.cell.list <- unique(whole.cell.DF$fileName)

#make the whole.cell BivData DF
whole.cell.DF <- Auto.Man_BivData[Auto.Man_BivData$fileName %in% whole.cell.list,]

#ADD within cell RANK to indiviual Bivalents,
whole.cell.DF <- ddply(whole.cell.DF, .(fileName), transform, rank = rank(chromosomeLength,ties.method ="min")-1)

#there are instances of ties, 
#oo -- look at correlation ranks

#make the bins
short.bin.Bivs <- whole.cell.DF[whole.cell.DF$rank < 6,]
long.bin.Bivs <- whole.cell.DF[whole.cell.DF$rank > 14,]


```



```{r Melt.DF}
library(reshape2)
#Auto.Man_BivData, all curate data
#get the whole cell verion with whole.cell.list

#isolate bivs with passing foci measures
Auto.Man_BivData.good.foci <- Auto.Man_BivData[Auto.Man_BivData$foci.pass == 1,]
colnames(Auto.Man_BivData.good.foci)

#add nrm foci measures
Auto.Man_BivData.good.foci$nrm.F1.pos <- Auto.Man_BivData.good.foci$Foci1 / Auto.Man_BivData.good.foci$chromosomeLength
Auto.Man_BivData.good.foci$nrm.F2.pos <- Auto.Man_BivData.good.foci$Foci2 / Auto.Man_BivData.good.foci$chromosomeLength
Auto.Man_BivData.good.foci$nrm.F3.pos <-   Auto.Man_BivData.good.foci$Foci3 / Auto.Man_BivData.good.foci$chromosomeLength

#melting the DataFrame is needed to ploting the normalized foci positions
#do not include cols for IFD, or ABS.foci
Auto.Man_BivData.melt <- melt( Auto.Man_BivData.good.foci[,c("fileName", "chromosomeLength", "centromere_ABS_Position", "centromere_PER_Position", "boxNumber","Obj.ID",  "SC.pass","foci.pass","curated.1pass.0fail.", "curation.notes",
    "hand.foci.count","nrm.F1.pos","nrm.F2.pos","nrm.F3.pos",  "mouse", "category",   "strain" , "sex")] , 
                               
                                #nrm.F1, nrm.F2, nrm.F3 left out to be melted
              id=c( "fileName", "chromosomeLength", "centromere_ABS_Position", "centromere_PER_Position", "boxNumber","Obj.ID",  "SC.pass","foci.pass","curated.1pass.0fail.", "curation.notes",
    "hand.foci.count","mouse", "category",   "strain" , "sex"))


colnames(Auto.Man_BivData.melt) <- c( "fileName", "chromosomeLength", "centromere_ABS_Position", "centromere_PER_Position", "boxNumber","Obj.ID",  "SC.pass","foci.pass","curated.1pass.0fail.", "curation.notes",
    "hand.foci.count", "mouse", "category",   "strain" , "sex",
                                       #name for the 2 melted cols
                                      "nrmFoci.Type", "nrmFoci.pos")

#remove NAs
Auto.Man_BivData.melt <- Auto.Man_BivData.melt[!(is.na(Auto.Man_BivData.melt$nrmFoci.Type) | Auto.Man_BivData.melt$nrmFoci.pos==""), ]

#make PWD and KAZ specific melt.DF ... if you want

#make whole cell melt
whole.cell_melt.DF <- Auto.Man_BivData.melt[Auto.Man_BivData.melt$fileName %in% whole.cell.list,]
#add rank to these measures
whole.cell_melt.DF <- ddply(whole.cell_melt.DF, .(fileName), transform, rank = rank(chromosomeLength,ties.method ="min")-1)

```


```{r saveRdata}
# all the main DFs have been made ...
#save rdata file!

save.image("data/MLH1/MLH1_data_setup_62419.RData")
```





```{r SClength.cell.tables}
#this is useful for making the list of cells to curate (comment out after curation step)

#add total COs
KAZ_BivData_cells <- ddply(KAZ_curate_BivData, c("fileName"), summarise,
                            
                    boxs.IDd = max(boxNumber),
                    nboxes_passed = length(boxNumber),
                    pass_rate = nboxes_passed/boxs.IDd,
                  
                    
                    totalCO = sum(numberCrossOvers),     
                    avCO.per.CHRM = mean(numberCrossOvers),
                    varCO.per.CHRM = var(numberCrossOvers),
                            
                    avSC.intensity = mean(avergeRED, na.rm = TRUE),
                    varSC.intensity = var(avergeRED, na.rm = TRUE),
                            
                    avSC.length = mean(chromosomeLength),
                    varSC.length = var(chromosomeLength),
                            
                    av.COdensity = mean(chromosomeLength /numberCrossOvers),
                    varCOdensity = var(chromosomeLength /numberCrossOvers)
                            #av CO density
                    #change the mean list for column numbers 

)

#cells2curate <- KAZ_BivData_cells[KAZ_BivData_cells$pass_rate > .7,]
#write.table(cells2curate, "~./MLH1repo/results/KAZ.cell.curate.csv", sep=",", row.names = FALSE)

#PWD version
#add total COs
PWD_BivData_cells <- ddply(PWD_curate_BivData, c("fileName"), summarise,
                            
                    boxs.IDd = max(boxNumber),
                    nboxes_passed = length(boxNumber),
                    pass_rate = nboxes_passed/boxs.IDd,

                    totalCO = sum(numberCrossOvers),     
                    avCO.per.CHRM = mean(numberCrossOvers),
                    varCO.per.CHRM = var(numberCrossOvers),
                            
                    avSC.intensity = mean(avergeRED, na.rm = TRUE),
                    varSC.intensity = var(avergeRED, na.rm = TRUE),
                            
                    avSC.length = mean(chromosomeLength),
                    varSC.length = var(chromosomeLength),
                            
                    av.COdensity = mean(chromosomeLength /numberCrossOvers),
                    varCOdensity = var(chromosomeLength /numberCrossOvers)
                            #av CO density
                    #change the mean list for column numbers 

)

PWDcells2curate <- PWD_BivData_cells[PWD_BivData_cells$pass_rate > .65,]

#write.table(PWDcells2curate, "~./MLH1repo/results/PWD.cell.curate.csv", sep=",", row.names = FALSE)
```




From the cell level tables -- make lists of cells with ~75% of bivalents quantified. These will be manually verified and the missing chrms will be measured and supplemented.

Data frames and analyses are the main output of this script - for a saved Rdata file.

1. Curated BivData; read files, merge/rbind together

2. Hand Measures; read files, rbind together

3. Auto+manual; combine the curate and hand measures, rbind both strains together.
    3B. Auto-Manual_whole_cell, make a list of fileNames for extracting these measures later; the biv from cells with all 19 autosome measures. Add bivalent rank to this DF.

4. melted DF; Melt the Foci-Pass of Auto_Manual_DF


--- Once the above DF's are made, proceed with following analyses ---

1. SC Length
    a. raw / loose bivalents
    b. binned bivalents, short vs long, chrm class

2. Normalized Foci Position
   a. all/full
   b. bins
   
3. 2-CO
    a. IFDs, raw norm
    b. F1 by F2

4. Rbar?



## Background and Premise

PWD and KAZ differ in gwRR/MLH1 counts, is there a correlation in meiotic features which go with expected differences in gwRR.



```{r mergeing.meta.data, echo=FALSE}
#meta.data.file2 = read.csv("~./MLH1repo/data/MouseMetaData61119.csv", header = TRUE)
#meta.data.file2 = read.csv("~./MLH1repo/data/Mouse_MetaData_6.12.19.csv", header = TRUE)

meta.data.file2 <- meta.data.file2[!(is.na(meta.data.file2$mouse)|meta.data.file2$mouse==""),] #375

#find a way to remove the rows without the right format before setting as as.Date
#trying to remove these the extra rows..uggh
#yy <- meta.data.file2[subset(meta.data.file2$DOB, !( (meta.data.file2$DOB == "emb") | (meta.data.file2$DOB == "arr") | (meta.data.file2$DOB == "e16.5")|(meta.data.file2$DOB == "march") ) ),]
#yy <- yy[subset(yy$DOB, !(yy$DOB == "arr")),]
#yy <- yy[subset(yy$DOB, !(yy$DOB == "e1")),]
#i think subseting is messing up the dataframes

meta.data.file2$DOB <- as.Date(meta.data.file2$DOB, format= "%m/%d/%Y")#%Y 2000, %y '18,

#source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
#meta.data.file2 <- add_euth_date(meta.data.file2) #euthdate 1st
#meta.data.file2 <- add_age(meta.data.file2)  #age second
##got it to work ... maybe should save adding it to the merged DF
meta.data.file2 <- add_category(meta.data.file2)
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
meta.data.file2 <- add_euth_date(meta.data.file2)
meta.data.file2 <- add_age(meta.data.file2)

pwd.meta <- meta.data.file2[meta.data.file2$category == "PWD male",]

#pwd.meta <- add_euth_date(pwd.meta)
#pwd.meta <- add_age(pwd.meta)

kaz.meta <- meta.data.file2[meta.data.file2$category == "KAZ male",]

#kaz.meta <- add_mouse(kaz.meta)
#kaz.meta <- add_euth_date(kaz.meta)
county =1
for(i in kaz.meta$mouse){
    templist= strsplit(i, split="_")[[1]]
    euth <- templist[1]
    #figure out date conversion
    kaz.meta$euth.date2[county] <- as.character(euth)
    
    #kaz.meta$euth.date[county] <- as.Date(kaz.meta$euth.date[county], format='%d%b%y')
    county= county +1
}

kaz.meta$euth.date <- as.Date(kaz.meta$euth.date2, format='%d%b%y')

kaz.meta <- add_age(kaz.meta)

#reduce metadata down to 2 cols (mouse, DOB), merge this with MLH1
MouseMetaData.wrkin <- meta.data.file2[,c(1,4)]
colnames(MouseMetaData.wrkin) <- c("mouse", "DOB")
MouseMetaData.wrkin <- MouseMetaData.wrkin[!(is.na(MouseMetaData.wrkin$mouse)|MouseMetaData.wrkin$mouse==""),]

PWD.KAZ_MLH1.imprv <- merge(PWD.KAZ_MLH1, MouseMetaData.wrkin)#don't apply the all parameters
#report number with  and without

#add euth date for calculating age
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
PWD.KAZ_MLH1.imprv <- add_euth_date(PWD.KAZ_MLH1.imprv)
PWD.KAZ_MLH1.imprv <- add_age(PWD.KAZ_MLH1.imprv)


#yesDOB.check <- PWD.KAZ_MLH1.imprv[!(is.na(PWD.KAZ_MLH1.imprv$DOB)),]
#noDOB.check <- PWD.KAZ_MLH1.imprv[(is.na(PWD.KAZ_MLH1.imprv$DOB)),]#note, date type of data can't do the string matching!

#total, KAZ 144, PWD 139
#table(noDOB.check$category)#  no DOB, KAZ 67  PWD 133
#table(yesDOB.check$category) #yes DOB, KAZ 77  PWD 6

# I need to find the ages of more PWD males

```



### SC Length Analysis

Make plots for SC lengths

kk <- ggplot(data=bin.short.PWD, aes(x=mouse,y=chromosomeLength))+geom_jitter(width = 0.25)+ggtitle("short bins")


```{r SC.lengths}
library(ggplot2)
#SC lenghts

#strange number of low chrm lengths
#hist(SC.passed.PWD$chromosomeLength)

SC.PWD <- ggplot(data = PWD_curate_BivData, aes(color=fileName,x=mouse, y= chromosomeLength))+geom_jitter()+theme(legend.position="none")+ylim(c(35,150))+ggtitle("PWD SC lengths")
#the SC range is 45 - 150 (for PWD)

SC.KAZ <- ggplot(data = KAZ_curate_BivData, aes(color=fileName,x=mouse, y= chromosomeLength))+geom_jitter()+
  theme(legend.position="none")+ylim(c(35,150))+ggtitle("KAZ SC lengths")
#can I add the means?

SC.PWD
SC.KAZ

KAZ_mean_SC <- ddply(KAZ_curate_BivData, c("mouse"), summarise,
                            
                    boxs.IDd = max(boxNumber),
                    nboxes_passed = length(boxNumber),
                    pass_rate = nboxes_passed/boxs.IDd,
                            
                    avSC.length = mean(chromosomeLength),
                    varSC.length = var(chromosomeLength)
)


PWD_mean_SC <- ddply(PWD_curate_BivData, c("mouse"), summarise,
                            
                    boxs.IDd = max(boxNumber),
                    nboxes_passed = length(boxNumber),
                    pass_rate = nboxes_passed/boxs.IDd,
                            
                    avSC.length = mean(chromosomeLength),
                    varSC.length = var(chromosomeLength)
)


t.test(KAZ_curate_BivData$chromosomeLength,PWD_curate_BivData$chromosomeLength)

```

the PWD has longer means





```{r}


show.plot <- ggplot(data =KAZ_m2_curate_bivData_SC_pass, aes(y=chromosomeLength, x=fileName))+geom_point()

show.plot2 <- ggplot(data =KAZ_m2_curate_bivData_SC_pass, aes(y=Foci1.pos, x=hand.foci.count))+geom_jitter()

show.plot99 <- ggplot(data =KAZ_m2_curate_bivData_SC_pass, aes(y=nrm.F1.pos, x=hand.foci.count))+geom_jitter()+
  ggtitle("Normalized foci positions")


count.hist <- ggplot(data =KAZ_m2_curate_bivData_SC_pass, aes(hand.foci.count))+geom_histogram()


```





Asigned rank to bivalent measures from the whole.cell dataset. I should try to use these measures to see if I can guess the ranks of 'loose' bivalent measures.
I also noted that the shortest 3 seem to cluster in PWD. Maybe I should try doing cluster analysis on these. 
I should also add rbar values to these measures. (I might have to reformat the function)

```{r hist.boxes.per.cell, echo=FALSE}
#histograms to display the average number of Objects per cell
PWD.curateautoBivData_cells <- ddply(PWD_curate_BivData, c("fileName"), summarise,
                    number = length(Obj.ID)
                    
)


PWD.autoBivData_cells_raw <- ggplot(data=PWD_BivData_cells, aes(x=boxs.IDd))+
  geom_histogram()+
  ggtitle("PWD raw bivadata")

PWD.autoBivData_cells <- ggplot(data=PWD.curateautoBivData_cells, aes(x=number))+
  geom_histogram()+   ggtitle("PWD curated")

PWD.autoBivData_cells_manu <- ggplot(data=PWD.auto.man_BivData_cells, aes(x=number))+
  geom_histogram()+
  ggtitle("PWD")

```


```{r histograms}

KAZ.autoBivData_cells_raw <- ggplot(data=KAZ_BivData_cells, aes(x=boxs.IDd))+
  geom_histogram()+
  ggtitle("KAZ raw bivadata")

```

KAZ.length.by.class <- ggplot(data=KAZ_whole.cell.BivData, aes(x=fileName,y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=as.factor(hand.foci.count), shape=mouse))+ggtitle("PWD full cell SC lengths")

KAz have more 0CO. Most of the NA's for CO count are from auto- where I was whisy-washy during curation.

#10mar15_PWD_m1: 13w
#10mar15_PWD_m2: 13w
#18may15_PWD_m1:  7w -- use this one
#18may15_PWD_m2: 7w  (seems like not all of the images were run through the algorithm)



```{r stat.test.SC.length, echo=FALSE}
#can't cleanly merge the curated data since the rows and headers are different
merged.cur <- rbind(curBivData_PWD_m1, curBivData_KAZ_m2)

SCs <- ggplot(data = , aes(y, x=mice))+geom_point

OneCO <- all.curated.BivData[all.curated.BivData$hand.foci.count == 1,]
TwoCO <- all.curated.BivData[all.curated.BivData$hand.foci.count == 2,]

Class.SC.test.1CO <- t.test(OneCO$chromosomeLength[OneCO$strain == "PWD"], OneCO$chromosomeLength[OneCO$strain == "KAZ"])

Class.SC.test.2CO <- t.test(TwoCO$chromosomeLength[TwoCO$strain == "PWD"],TwoCO$chromosomeLength[TwoCO$strain == "KAZ"])

```



```{r SC.Chrm, echo=FALSE}
all.curated.BivData <- rbind(KAZ.auto.man_BivData, PWD.auto.man_BivData)
all.whole.cell <- rbind(KAZ_whole.cell.BivData,PWD_whole.cell.BivData)


BivClass.SC_BivData <- ggplot(data=all.curated.BivData, aes(x=hand.foci.count,  y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=as.factor(hand.foci.count)))+ggtitle("PWD full cell SC lengths")+geom_boxplot(aes(alpha=.3))+facet_wrap(~strain)


BivClass.SC_whole.cell <- ggplot(data=all.whole.cell, aes(x=hand.foci.count,  y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=as.factor(hand.foci.count)))+
  ggtitle("PWD full cell SC lengths")+
  geom_boxplot(aes(alpha=.3))+
  facet_wrap(~strain)


all.whole.cell.sub <- all.whole.cell[all.whole.cell$mouse != "18may15_PWD_m1",]

all.whole.cell.sub <- all.whole.cell.sub[all.whole.cell.sub$mouse != "6mar16_PWD_m1",]

all.whole.cell.sub <- all.whole.cell.sub[all.whole.cell.sub$hand.foci.count >= 1,]

table(all.whole.cell.sub$mouse)


SC.COnum <- ggplot(all.whole.cell.sub, aes(x=mouse, y=chromosomeLength, color=as.factor(hand.foci.count), fill=as.factor(hand.foci.count) ))+
  geom_jitter(alpha=0.8)+
  geom_boxplot(alpha=0.6) +theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("SC Length by Chromosome Class")+theme(legend.position="none")


```


```{r SC.by.bins}

#compare short and long bins
bin_short <- all.whole.cell[all.whole.cell$rank < 5,]

bin_short <- all.whole.cell[all.whole.cell$rank < 3,]#comparing the bottom 3 are not sig different

#bin.short.PWD <- bin.short.PWD[bin.short.PWD$fileName %in% full.cell.list$fileName,]

short_SC <- ggplot(data=bin_short, aes(x=mouse,y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=fileName))+ggtitle("short bins")+facet_wrap(~strain)+ theme(legend.position="none")

t.test(bin_short$chromosomeLength[bin_short$strain == "PWD"],
       bin_short$chromosomeLength[bin_short$strain == "KAZ"])

#p-value = 0.02131

bin_long <- all.whole.cell[all.whole.cell$rank > 15,]#comparing the top 3 is not sig different


long_SC <- ggplot(data=bin_long, aes(x=mouse,y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=fileName) )+ggtitle("Long bins")+facet_wrap(~strain)+ theme(legend.position="none")

t.test(bin_long$chromosomeLength[bin_long$strain == "PWD"],
       bin_long$chromosomeLength[bin_long$strain == "KAZ"])

#p-value = 0.01495
```


```{r chrm.class, echo=FALSE}
#proportions of bivalent classes

foci.passed.KAZ <- KAZ_curate_BivData[KAZ_curate_BivData$foci.pass == 1,]
foci.passed.PWD <- PWD_curate_BivData[PWD_curate_BivData$foci.pass == 1,]

jj <- rbind(foci.passed.KAZ,foci.passed.PWD)

qq <- ggplot(data = jj, aes(color=fileName,x=mouse, y= hand.foci.count))+geom_jitter()+theme(legend.position="none")+facet_wrap(~strain)

qq2 <- ggplot(data = foci.passed.PWD, aes(color=fileName,x=mouse, y= hand.foci.count))+geom_jitter()+theme(legend.position="none")

qq4 <- ggplot(data = foci.passed.PWD, aes(x=hand.foci.count, y= chromosomeLength))+geom_jitter(aes(fill=nrm.F1.pos))+theme(legend.position="none")

#PWD have more 2CO bivalents
biv_class_table <- ddply(jj, c("hand.foci.count", "strain"), summarise,
                    number = length(Obj.ID)
)


#### use whole cell data

KAZ_whole.cell.BivData
all.whole.cell
#chi-squard test?

whole.cell_biv_class_table <- ddply(all.whole.cell, c("hand.foci.count", "strain"), summarise,
                    number = length(Obj.ID)
)

```


```{r IDF, echo=FALSE}


#isolate the 2COs
#total Bivdata
KAZ.2COs <- KAZ.auto.man_BivData[KAZ.auto.man_BivData$hand.foci.count == 2,]
PWD.2COs <- PWD.auto.man_BivData[PWD.auto.man_BivData$hand.foci.count == 2,]

all.2CO <- rbind(KAZ.2COs,PWD.2COs)
#all.2CO <- ddply(all.2CO, .(fileName), transform, rank = rank(chromosomeLength,ties.method ="min")-1)
#all.2CO <- all.2CO[ -c(24) ]


all.2CO$Foci1.PER <- all.2CO$Foci1 / all.2CO$chromosomeLength
all.2CO$Foci2.PER <- all.2CO$Foci2 / all.2CO$chromosomeLength
all.2CO$Foci3.PER <- all.2CO$Foci3 / all.2CO$chromosomeLength

#call IFD function on this DF
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
all.2CO <- add_IFD(all.2CO)
all.2CO <- droplevels(all.2CO)
all.2CO <- all.2CO[!(is.na(all.2CO$fileName) | all.2CO$fileName == ""), ]

all.2CO$mouse <- droplevels(all.2CO$mouse)

IFDs.ABS <- ggplot(data=all.2CO, aes(x=mouse,y=IFD1_ABS))+geom_jitter(width = 0.25, aes(color=as.factor(fileName) ))+ggtitle("raw IFD Distributions")+geom_boxplot(alpha = 0.6)+facet_wrap(~strain)+  theme(legend.position="none", axis.text.x = element_text(angle = 90, hjust = 1) )

IFDs.PER <- ggplot(data=all.2CO, aes(x=mouse,y=IFD1_PER))+geom_jitter(width = 0.25, aes(color=as.factor(fileName) ))+ggtitle("norm IFD Distributions")+geom_boxplot(alpha = 0.6)+facet_wrap(~strain)+theme(legend.position="none")


#whole cell comparison (use rank)
#KAZ_whole.cell.BivData, #PWD_whole.cell.BivData

#limit to mice with most observations

whole.cell.2CO <- rbind(KAZ_whole.cell.BivData,PWD_whole.cell.BivData)

whole.cell.2CO$Foci1.PER <- whole.cell.2CO$Foci1 / whole.cell.2CO$chromosomeLength
whole.cell.2CO$Foci2.PER <- whole.cell.2CO$Foci2 / whole.cell.2CO$chromosomeLength
whole.cell.2CO$Foci3.PER <- whole.cell.2CO$Foci3 / whole.cell.2CO$chromosomeLength

#call IFD function on this DF
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
whole.cell.2CO <- add_IFD(whole.cell.2CO)
whole.cell.2CO <- droplevels(whole.cell.2CO)
whole.cell.2CO <- whole.cell.2CO[!(is.na(whole.cell.2CO$fileName) | whole.cell.2CO$fileName == ""), ]



IFDs.ABS.whole.cell <- ggplot(data=whole.cell.2CO, aes(x=mouse,y=IFD1_ABS))+geom_jitter(width = 0.25, aes(color=as.factor(rank) ))+ggtitle("Whole cell IFD Distributions")+geom_boxplot(alpha = 0.6)+facet_wrap(~strain)+  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1) )

IFDs.PER.whole.cell <- ggplot(data=whole.cell.2CO, aes(x=mouse,y=IFD1_PER))+geom_jitter(width = 0.25, aes(color=as.factor(rank) ))+ggtitle("Whole Cell Norm IFD Distributions")+geom_boxplot(alpha = 0.6)+facet_wrap(~strain)+theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1) )


```


```{r IFD.SC, echo=FALSE}
#compare the realtionship of SC length and 

values.ABS.all <- all.2CO %>% 
    group_by(strain) %>% 
    do({
      mod = lm(IFD1_ABS ~ chromosomeLength, data = .)
      data.frame(Intercept = coef(mod)[1],
                 Slope = coef(mod)[2])
    })

SC.IFD <- ggplot(data=all.2CO, aes(x=chromosomeLength,y=IFD1_ABS))+geom_point( aes(color=as.factor(mouse) ))+
  ggtitle("SC by IFD length")+facet_wrap(~strain)+  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1) )+ 
  geom_smooth(method="lm")#+
  #geom_text(values.ABS.all, aes(x = 75, y = 100, label = n), parse = TRUE, inherit.aes=FALSE)

SC.IFD_PER <- ggplot(data=all.2CO, aes(x=chromosomeLength,y=IFD1_PER))+geom_jitter(width = 0.25, aes(color=as.factor(mouse) ))+
  geom_abline(intercept = 0.25)+
    geom_smooth(method="lm")+
  ggtitle("SC by nrm IFD length")+facet_wrap(~strain)+  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1) )


```



```{r BivData.set, echo=FALSE}
#goal load and set up of the BivData Dataframe

#BivData
# load more bivData
KAZ_bivData = read.csv("~./MLH1repo/data/KAZ_BivData.csv", header = TRUE)

P_fileNames <- KAZ_bivData$fileName[(grep('p_rev', KAZ_bivData$fileName))]
length(P_fileNames)#187

KAZ_bivData <- KAZ_bivData[!(KAZ_bivData$fileName %in% P_fileNames), ]#3642

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")

KAZ_bivData <- add_mouse(KAZ_bivData)
KAZ_bivData <- add_strain(KAZ_bivData)
KAZ_bivData <- add_sex(KAZ_bivData)
KAZ_bivData <- add_category(KAZ_bivData)

#dup_list= c()
#for(i in KAZ_bivData$fileName){  #change the file name header,  
#  # print(i)
#  ifelse(grepl("\\.[0-9]_rev", i),
#         (dup_list = c(dup_list, i)), NA)
#}
#MultiCells = c()
#for(j in dup_list){
#  stringLIST = strsplit(j, split="\\.")[[1]]
#  new_string = paste(stringLIST[[1]][1], "rev", sep="_")
#  MultiCells = c(MultiCells, new_string)
#}
#MultiCells = unique(MultiCells)
#multi_cell_num = length(MultiCells)

#test this part of the function
#KAZ_bivData <- KAZ_bivData[!(KAZ_bivData$fileName %in% MultiCells), ]#35 removed from KAZ data



MouseMetaData.wrkin <- MouseMetaData.wrkin[!(is.na(MouseMetaData.wrkin$mouse)|MouseMetaData.wrkin$mouse==""),]

PWD.KAZ_BivData.imprv <- merge(PWD.KAZ_BivData, MouseMetaData.wrkin)

table(fullBivData$category)# PWD 670, 
#there are no KAZ male data

#merge PWD and KAZ (WHAT ABOUT THE foci?)
#melt the BivData?
```





```{r position.plot}
library(ggplot2)
library(plyr)

curBivData_PWD.melt <- curBivData_PWD.melt[curBivData_PWD.melt$hand.foci.count != "1?",]

curBivData_PWD.melt <- droplevels(curBivData_PWD.melt)

curBivData_PWD.melt$hand.foci.count <- as.numeric(curBivData_PWD.melt$hand.foci.count)

nPWD.obs <- ddply(.data=curBivData_PWD.melt[curBivData_PWD.melt$hand.foci.count <3,], 
                 .(hand.foci.count),
                 summarize, 
                 n=paste("n =", length(unique(Obj.ID))))

#normalized foci plots
PWD.plot.nrm <- ggplot(curBivData_PWD.melt[curBivData_PWD.melt$hand.foci.count < 3,],
              aes(x=Foci.nrm.pos, fill=Foci.Type.nrm) ) + 
  geom_histogram(alpha= 0.5,stat = "bin", position= "identity")+
 facet_wrap(~ hand.foci.count, scales="free", ncol=1)+ggtitle("norm foci position PWD")+
  
   geom_text(data=nPWD.obs, aes(x=.5, y=7, label=n), 
            colour="black", inherit.aes=FALSE, parse=FALSE) + xlim(c(0,1)) + ylim(c(0,20))
  
#  scale_fill_manual(values=c("green4", "greenyellow")) +
#can I put the number of observations in this? 

#make a sample dataset for KAZ
#uni<- unique(curBivData_KAZ.melt$Obj.ID)#careful not to confuse cell names with obj.ID this is the number of cells! (not bivs)
#subSample.KAZ <- sample(uni, 68, replace = FALSE)
#subSample.KAZ.DF <- curBivData_KAZ.melt[curBivData_KAZ.melt$Obj.ID %in% subSample.KAZ,]

curBivData_KAZ.melt2 <- curBivData_KAZ.melt[!is.na(curBivData_KAZ.melt$hand.foci.count),]
curBivData_KAZ.melt2 <- curBivData_KAZ.melt2[curBivData_KAZ.melt2$hand.foci.count < 3,]

nKAZ.obs <- ddply(.data=curBivData_KAZ.melt2, 
                 .(hand.foci.count),
                 summarize, 
                 n=paste("n =", length(unique(Obj.ID))))

#urBivData_KAZ.melt[curBivData_KAZ.melt$hand.foci.count < 3,]

KAZ.plot.nrm    <- ggplot(curBivData_KAZ.melt2,
              aes(x=nrmFoci.pos, fill=nrmFoci.Type) ) + 
  
  geom_histogram(alpha= 0.5,stat = "bin", position= "identity")+
 facet_wrap(~ hand.foci.count, scales="free", ncol=1)+ggtitle("norm foci position KAZ")+
   geom_text(data=nKAZ.obs, aes(x=.5, y=7, label=n), 
            colour="black", inherit.aes=FALSE, parse=FALSE)+xlim(c(0,1)) + ylim(c(0,20))
    

```


```{r}
#t.test of nrm positions

PWD.OneCO_nrmPos <- curBivData_PWD.melt[curBivData_PWD.melt$hand.foci.count ==1,]
PWD.TWOCO_nrmPos <- curBivData_PWD.melt[curBivData_PWD.melt$hand.foci.count ==2,]

KAZ.OneCO_nrmPos <- curBivData_KAZ.melt2[curBivData_KAZ.melt2$hand.foci.count ==1,]
KAZ.TWOCO_nrmPos <- curBivData_KAZ.melt2[curBivData_KAZ.melt2$hand.foci.count ==2,]


t.test(PWD.OneCO_nrmPos$Foci.nrm.pos, KAZ.OneCO_nrmPos$nrmFoci.pos)
#p-value = 0.5468

t.test(KAZ.TWOCO_nrmPos$nrmFoci.pos[KAZ.TWOCO_nrmPos$nrmFoci.Type == "nrm.F1.pos"],
       PWD.TWOCO_nrmPos$Foci.nrm.pos[PWD.TWOCO_nrmPos$Foci.Type.nrm == "nrm.F1"])
#p-value = 0.9421


t.test(KAZ.TWOCO_nrmPos$nrmFoci.pos[KAZ.TWOCO_nrmPos$nrmFoci.Type == "nrm.F2.pos"],
       PWD.TWOCO_nrmPos$Foci.nrm.pos[PWD.TWOCO_nrmPos$Foci.Type.nrm == "nrm.F2"])
#p-value = 0.5403
```


From the curation datasets, it seems that the dpulicate / repeat image loop is not effectively removing double counted images.

are the bivalents with faint foci similar in SC length (or rank) across cells



During the curation process, I could pull the intensities of foci which match the hand reported measure.
I could also pull 'faint foci' from the auto-measures from the note section, as long as I can standardize my coding for faint foci.

```{r fit.exp, echo=FALSE}
#fitting IFDs to expoential Distribution
#curBivData_PWD.melt
#make an IFD plot of Null.IFDs drawn from exponential
#curBivData_KAZ.melt2

#total Bivdata
KAZ.2COs <- KAZ.auto.man_BivData[KAZ.auto.man_BivData$hand.foci.count == 2,]
PWD.2COs <- PWD.auto.man_BivData[PWD.auto.man_BivData$hand.foci.count == 2,]

all.2CO <- rbind(KAZ.2COs,PWD.2COs)
#all.2CO <- ddply(all.2CO, .(fileName), transform, rank = rank(chromosomeLength,ties.method ="min")-1)
#all.2CO <- all.2CO[ -c(24) ]

all.2CO$Foci1.PER <- all.2CO$Foci1 / all.2CO$chromosomeLength
all.2CO$Foci2.PER <- all.2CO$Foci2 / all.2CO$chromosomeLength
all.2CO$Foci3.PER <- all.2CO$Foci3 / all.2CO$chromosomeLength

source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
all.2CO <- add_IFD(all.2CO)
all.2CO <- droplevels(all.2CO)
all.2CO <- all.2CO[!(is.na(all.2CO$fileName) | all.2CO$fileName == ""), ]

all.2CO <- all.2CO[!(is.na(all.2CO$IFD1_PER) | all.2CO$IFD1_PER == ""), ]

all.2CO$mouse <- droplevels(all.2CO$mouse)


#whole cell comparison (use rank)
#KAZ_whole.cell.BivData, #PWD_whole.cell.BivData

#limit to mice with most observations

whole.cell.2CO <- rbind(KAZ_whole.cell.BivData,PWD_whole.cell.BivData)

whole.cell.2CO$Foci1.PER <- whole.cell.2CO$Foci1 / whole.cell.2CO$chromosomeLength
whole.cell.2CO$Foci2.PER <- whole.cell.2CO$Foci2 / whole.cell.2CO$chromosomeLength
whole.cell.2CO$Foci3.PER <- whole.cell.2CO$Foci3 / whole.cell.2CO$chromosomeLength

#call IFD function on this DF
source("~./MLH1repo/src/CommonFunc_MLH1repo.R")
whole.cell.2CO <- add_IFD(whole.cell.2CO)
whole.cell.2CO <- droplevels(whole.cell.2CO)
whole.cell.2CO <- whole.cell.2CO[!(is.na(whole.cell.2CO$fileName) | whole.cell.2CO$fileName == ""), ]



require(vcd)
require(MASS)

# data generation
ex <- rexp(10000, rate = 1.85) # generate some exponential distribution
control <- abs(rnorm(10000)) # generate some other distribution

# estimate the parameters
fit1 <- fitdistr(ex, "exponential") 
fit2 <- fitdistr(control, "exponential")

fit.AP1 <- fitdistr(all.2CO$IFD1_PER, "exponential")


fit.PWD <- fitdistr(all.2CO$IFD1_ABS[all.2CO$strain == "PWD"], "gamma")#change to gamma, (1 outlier)

fit.KAZ <- fitdistr(all.2CO$IFD1_ABS[all.2CO$strain== "KAZ"], "gamma")


PWD.curve <- hist(all.2CO$IFD1_ABS[all.2CO$strain == "PWD"], freq = FALSE, breaks = 100, xlim = c(0, quantile(ex, 0.99)))+
curve(dexp(x, rate = fit.PWD$estimate), from = 0, col = "red", add = TRUE)

KAZ.curve <- hist(all.2CO$IFD1_PER[all.2CO$strain == "KAZ"], freq = FALSE, breaks = 100, xlim = c(0, quantile(ex, 0.99)))+
curve(dexp(x, rate = fit.KAZ$estimate), from = 0, col = "red", add = TRUE)


ks.test(ex, "pexp", fit1$estimate) # p-value > 0.05 -> distribution not refused
ks.test(control, "pexp", fit2$estimate) 

# plot a graph
hist(ex, freq = FALSE, breaks = 100, xlim = c(0, quantile(ex, 0.99)))+curve(dexp(x, rate = fit1$estimate), from = 0, col = "red", add = TRUE)


hist(all.2CO$IFD1_PER, freq = FALSE, breaks = 100, xlim = c(0, quantile(ex, 0.99)))+
curve(dexp(x, rate = fit.AP1$estimate), from = 0, col = "red", add = TRUE)


```



```{r makeKAZ.curate.list, echo=FALSE}
#write out list for initial quality control and subsetting
#remove centromere_PER > .2
KAZ.Biv.curate.list <- KAZ_bivData[KAZ_bivData$centromere_PER_Position < 0.2,]#3123

#remove chrmLength > 150? 200
KAZ.Biv.curate.list <- KAZ.Biv.curate.list[KAZ.Biv.curate.list$chromosomeLength < 300, ]#not completely sure 300 is probably the max length is the best length
#3117

table(KAZ.Biv.curate.list$mouse)
#7 mice: 11jan18_KAZ_m4(9w), 1feb18_KAZ_m1(11w), 11jan18_KAZ_m3(9w), and 11jan18_KAZ_m1(43w) have good MLH1


cur11jan18_KAZ_m4 <- KAZ.Biv.curate.list[KAZ.Biv.curate.list$mouse == "11jan18_KAZ_m4",]

cur11jan18_KAZ_m4$Obj.ID <- paste(cur11jan18_KAZ_m4$fileName, cur11jan18_KAZ_m4$boxNumber, sep = "_")

write.table(cur11jan18_KAZ_m4, "~./MLH1repo/results/curate_cur11jan18_KAZ_m4_BivData.txt", sep="\t", row.names = FALSE)

```


```{r make.curate.list, echo=FALSE}

#load/read in fullBivdata file
newPWD_BivData = read.csv("~./MLH1repo/data/BivData/PWD_BivData_7.9.19.csv", header = TRUE)#740
#filter by centromere
newPWD <- newPWD_BivData[newPWD_BivData$centromere_PER_Position < 0.2,] #665
#add Obj.ID
newPWD$Obj.ID <- paste(newPWD$fileName, newPWD$boxNumber, sep = "_")
#write to file for making manual notes
write.table(newPWD, "~./MLH1repo/results/newPWD_7.9.19.txt", sep="\t", row.names = FALSE)
#think about adding ~6 more columns for the curation process
```

PWD.auto.man_BivData <- PWD.auto.man_BivData[ -c(19:25) ]

#y <- droplevels(y)

#length.by.class <- ggplot(data=hh2, aes(x=fileName,y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=hand.foci.count, shape=mouse))+ggtitle("PWD full cell SC lengths")
#most cells are from 1 mouse

DF.w.rank2 <- DF.w.rank[DF.w.rank$fileName %in% full.cell.list$fileName,]
DF.w.rank2 <- DF.w.rank[DF.w.rank$fileName != "20jul15_18may15_PWD_m1_sp1_17_rev",]


qq <- ggplot(data=DF.w.rank2, aes(x=fileName,y=chromosomeLength))+geom_jitter(width = 0.25, aes(color=rank, shape=mouse))+ggtitle("PWD full cell SC lengths")
#most cells are from 1 mouse

#take the shortest 5? (lower 25%)
#take the shortest 3? (seems to be natural cutoff, lowest 3 are similar)


#bin.long.PWD <- DF.w.rank[DF.w.rank$rank]
#can't do long yet, bc the coding for XY is inconsistant!

Kaz.biv.plot <- ggplot(data = KAZ.Biv.curate.list, aes(x= centromere_PER_Position, y=chromosomeLength) )+geom_point()+facet_wrap(~mouse)

#3000 to curate


